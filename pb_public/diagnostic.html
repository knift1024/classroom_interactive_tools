<!DOCTYPE html>
<html>
<head>
    <title>PocketBase è¨ºæ–·å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>PocketBase è¨ºæ–·å·¥å…·</h1>
    
    <div class="section">
        <h2>1. ç®¡ç†å“¡ç™»å…¥</h2>
        <input type="email" id="adminEmail" placeholder="ç®¡ç†å“¡ Email" style="margin: 5px; padding: 5px;">
        <input type="password" id="adminPassword" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="margin: 5px; padding: 5px;">
        <button id="adminLogin">ç®¡ç†å“¡ç™»å…¥</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="section">
        <h2>2. é€£æ¥æ¸¬è©¦</h2>
        <button id="testConnection">æ¸¬è©¦é€£æ¥</button>
        <div id="connectionResult"></div>
    </div>
    
    <div class="section">
        <h2>3. Collections æª¢æŸ¥</h2>
        <button id="checkCollections">æª¢æŸ¥ Collections</button>
        <div id="collectionsResult"></div>
    </div>
    
    <div class="section">
        <h2>4. å»ºç«‹æ¸¬è©¦æ•™å®¤</h2>
        <button id="createTestClassroom">å»ºç«‹æ¸¬è©¦æ•™å®¤</button>
        <div id="classroomResult"></div>
    </div>

    <div class="section">
        <h2>5. è‡ªå‹•å»ºç«‹ Collections</h2>
        <button id="createCollections">è‡ªå‹•å»ºç«‹æ‰€éœ€çš„ Collections</button>
        <div id="createResult"></div>
    </div>

    <script type="module">
        import PocketBase from 'https://cdn.skypack.dev/pocketbase';
        
        const pb = new PocketBase('http://127.0.0.1:8090');
        
        document.getElementById('adminLogin').addEventListener('click', async () => {
            const result = document.getElementById('loginResult');
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!email || !password) {
                result.innerHTML = '<p class="error">è«‹è¼¸å…¥ç®¡ç†å“¡ Email å’Œå¯†ç¢¼</p>';
                return;
            }
            
            try {
                result.innerHTML = '<p class="info">ç™»å…¥ä¸­...</p>';
                const authData = await pb.admins.authWithPassword(email, password);
                result.innerHTML = `<p class="success">âœ… ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼</p><p>Token: ${authData.token.substring(0, 20)}...</p>`;
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ ç™»å…¥å¤±æ•—: ${error.message}</p>`;
            }
        });
        
        document.getElementById('testConnection').addEventListener('click', async () => {
            const result = document.getElementById('connectionResult');
            try {
                result.innerHTML = '<p class="info">æ¸¬è©¦ä¸­...</p>';
                const health = await pb.health.check();
                result.innerHTML = `<p class="success">âœ… é€£æ¥æˆåŠŸï¼</p><pre>${JSON.stringify(health, null, 2)}</pre>`;
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ é€£æ¥å¤±æ•—: ${error.message}</p>`;
            }
        });
        
        document.getElementById('checkCollections').addEventListener('click', async () => {
            const result = document.getElementById('collectionsResult');
            try {
                result.innerHTML = '<p class="info">æª¢æŸ¥ä¸­...</p>';
                const collections = await pb.collections.getFullList();
                
                const requiredCollections = ['classrooms', 'student_responses', 'student_presence', 'peer_reviews'];
                let html = '<h3>ç¾æœ‰ Collections:</h3><ul>';
                
                collections.forEach(col => {
                    const isRequired = requiredCollections.includes(col.name);
                    html += `<li ${isRequired ? 'class="success"' : ''}>${col.name} (${col.type}) ${isRequired ? 'âœ…' : ''}</li>`;
                });
                
                html += '</ul><h3>ç¼ºå°‘çš„ Collections:</h3><ul>';
                const existingNames = collections.map(c => c.name);
                const missing = requiredCollections.filter(name => !existingNames.includes(name));
                
                if (missing.length === 0) {
                    html += '<li class="success">ç„¡ç¼ºå°‘çš„ Collections âœ…</li>';
                } else {
                    missing.forEach(name => {
                        html += `<li class="error">${name} âŒ</li>`;
                    });
                }
                
                html += '</ul>';
                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ æª¢æŸ¥å¤±æ•—: ${error.message}</p>`;
            }
        });
        
        document.getElementById('createTestClassroom').addEventListener('click', async () => {
            const result = document.getElementById('classroomResult');
            try {
                result.innerHTML = '<p class="info">å»ºç«‹æ¸¬è©¦æ•™å®¤ä¸­...</p>';
                
                const testData = {
                    code: 'DIAGNOSTIC_TEST',
                    app_id: 'test-app',
                    teacher_id: 'test-teacher',
                    active_mode: 'waiting',
                    is_paused: false
                };
                
                console.log('å˜—è©¦å»ºç«‹æ•™å®¤ï¼Œè³‡æ–™:', testData);
                
                const classroom = await pb.collection('classrooms').create(testData);
                result.innerHTML = `<p class="success">âœ… æ¸¬è©¦æ•™å®¤å»ºç«‹æˆåŠŸï¼</p><pre>${JSON.stringify(classroom, null, 2)}</pre>`;
                
                // æ¸…ç†æ¸¬è©¦è³‡æ–™
                await pb.collection('classrooms').delete(classroom.id);
                result.innerHTML += `<p class="info">ğŸ§¹ æ¸¬è©¦è³‡æ–™å·²æ¸…ç†</p>`;
                
            } catch (error) {
                console.error('å»ºç«‹æ•™å®¤å¤±æ•—:', error);
                result.innerHTML = `<p class="error">âŒ å»ºç«‹å¤±æ•—: ${error.message}</p>`;
                if (error.response?.data) {
                    result.innerHTML += `<pre class="error">${JSON.stringify(error.response.data, null, 2)}</pre>`;
                }
            }
        });
        
        document.getElementById('createCollections').addEventListener('click', async () => {
            const result = document.getElementById('createResult');
            result.innerHTML = '<p class="info">å»ºç«‹ Collections ä¸­...</p>';
            
            try {
                // æª¢æŸ¥ä¸¦å»ºç«‹ classrooms collection
                try {
                    await pb.collections.getOne('classrooms');
                    result.innerHTML += '<p class="success">âœ… classrooms collection å·²å­˜åœ¨</p>';
                } catch (e) {
                    // Collection ä¸å­˜åœ¨ï¼Œå»ºç«‹å®ƒ
                    await pb.collections.create({
                        name: 'classrooms',
                        type: 'base',
                        schema: [
                            { name: 'code', type: 'text', required: true },
                            { name: 'app_id', type: 'text', required: true },
                            { name: 'teacher_id', type: 'text', required: true },
                            { name: 'active_mode', type: 'text', required: false },
                            { name: 'is_paused', type: 'bool', required: false },
                            { name: 'background_image', type: 'text', required: false },
                            { name: 'multiple_choice_questions', type: 'text', required: false },
                            { name: 'dispatch_settings', type: 'text', required: false }
                        ]
                    });
                    result.innerHTML += '<p class="success">âœ… classrooms collection å·²å»ºç«‹</p>';
                }
                
                // æª¢æŸ¥ä¸¦å»ºç«‹å…¶ä»– collections...
                const collections = [
                    {
                        name: 'student_responses',
                        schema: [
                            { name: 'classroom_code', type: 'text', required: true },
                            { name: 'student_name', type: 'text', required: true },
                            { name: 'answer', type: 'text', required: false },
                            { name: 'timestamp', type: 'date', required: false },
                            { name: 'is_nominated', type: 'bool', required: false }
                        ]
                    },
                    {
                        name: 'student_presence',
                        schema: [
                            { name: 'classroom_code', type: 'text', required: true },
                            { name: 'user_id', type: 'text', required: true },
                            { name: 'student_name', type: 'text', required: true },
                            { name: 'last_seen', type: 'date', required: false }
                        ]
                    },
                    {
                        name: 'peer_reviews',
                        schema: [
                            { name: 'classroom_code', type: 'text', required: true },
                            { name: 'reviewer_name', type: 'text', required: true },
                            { name: 'reviewed_name', type: 'text', required: true },
                            { name: 'score', type: 'number', required: true }
                        ]
                    }
                ];
                
                for (const colDef of collections) {
                    try {
                        await pb.collections.getOne(colDef.name);
                        result.innerHTML += `<p class="success">âœ… ${colDef.name} collection å·²å­˜åœ¨</p>`;
                    } catch (e) {
                        await pb.collections.create({
                            name: colDef.name,
                            type: 'base',
                            schema: colDef.schema
                        });
                        result.innerHTML += `<p class="success">âœ… ${colDef.name} collection å·²å»ºç«‹</p>`;
                    }
                }
                
                result.innerHTML += '<p class="success">ğŸ‰ æ‰€æœ‰ Collections æº–å‚™å°±ç·’ï¼</p>';
                
            } catch (error) {
                result.innerHTML += `<p class="error">âŒ å»ºç«‹å¤±æ•—: ${error.message}</p>`;
                console.error('å»ºç«‹ collections å¤±æ•—:', error);
            }
        });
    </script>
</body>
</html>