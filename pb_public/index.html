
<!-- --- è‡ªå‹•æ•™å¸«ç™»å…¥ï¼ˆæ ¹æ“š URL åƒæ•¸ï¼‰ --- -->
<script>
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role');
    const password = urlParams.get('password');
    if (role === 'teacher' && password) {
        // è‡ªå‹•é¸æ“‡æ•™å¸«èº«ä»½
        const teacherBtn = document.getElementById('teacher-entry-btn');
        if (teacherBtn) teacherBtn.click();
        // è¼ªè©¢ç­‰å¾…æ•™å¸«å¯†ç¢¼æ¬„ä½èˆ‡ç™»å…¥æŒ‰éˆ•å‡ºç¾
        const tryAutoLogin = () => {
            const pwdInput = document.getElementById('teacher-password-modal-input');
            const loginBtn = document.getElementById('teacher-password-submit-btn');
            if (pwdInput && loginBtn) {
                pwdInput.value = password;
                loginBtn.click();
            } else {
                setTimeout(tryAutoLogin, 100);
            }
        };
        tryAutoLogin();
    }
});
</script>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰›å¥½å­¸ï¼šèª²å ‚äº’å‹•so easy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        /* --- å…¨æ–°åˆå§‹ç•«é¢ç¾åŒ–æ¨£å¼ --- */
        body.initial-view-background {
            background-color: #f0f4f8; /* Fallback */
            background-image:
                radial-gradient(circle at 1px 1px, #d1d5db 1px, transparent 0),
                radial-gradient(circle at 20px 20px, #d1d5db 1px, transparent 0);
            background-size: 40px 40px;
        }

        .role-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            padding: 2rem 1.5rem;
            border-radius: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            transition: all 0.3s ease-in-out;
            text-align: center;
        }
        .role-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            border-color: #93c5fd; /* Light blue border on hover */
        }
        .role-card-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            transition: all 0.3s ease-in-out;
        }
        .role-card .btn {
            font-size: 1.1rem;
            padding-top: 0.625rem;
            padding-bottom: 0.625rem;
        }
        /* --- åˆå§‹ç•«é¢æ¨£å¼çµæŸ --- */

        /* è‡ªè¨‚æ¨£å¼ */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* æŸ”å’Œçš„èƒŒæ™¯è‰² */
        }
        /* éš±è—å…ƒç´ çš„é€šç”¨ class */
        .hidden {
            display: none;
        }
        /* æŒ‰éˆ•æ¨£å¼ (ç›´æ¥åœ¨ HTML ä¸­ä½¿ç”¨ Tailwind classï¼Œä¸ä½¿ç”¨ @apply) */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            line-height: 1.75rem;
            font-weight: 700;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn-primary { background-color: #2563eb; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-green { background-color: #16a34a; }
        .btn-green:hover { background-color: #15803d; }
        .btn-orange { background-color: #ea580c; }
        .btn-orange:hover { background-color: #c2410c; }
        .btn-purple { background-color: #9333ea; }
        .btn-purple:hover { background-color: #7e22ce; }
        .btn-red { background-color: #dc2626; }
        .btn-red:hover { background-color: #b91c1c; }
        .btn-teal { background-color: #0d9488; } /* New Teal color */
        .btn-teal:hover { background-color: #0f766e; }

        .btn-amber {
            background-color: #f59e1b;
            color: #222;
        }
        .btn-amber:hover {
            background-color: #d97706;
            color: #fff;
        }
        .btn-gray { background-color: #9ca3af; cursor: not-allowed; }

        /* QR Code æ¨£å¼ */
        #qr-code-container {
            transition: all 0.3s ease;
        }
        #qr-code-container:hover {
            transform: scale(1.02);
        }
        #qr-code-canvas {
            display: block;
            margin: 0 auto;
        }
        #qr-code-btn {
            position: relative;
        }
        #qr-code-btn:hover #qr-code-container {
            transform: scale(1.02);
        }

        /* æ‰‹æ©ŸQR Codeæƒç¢¼å„ªåŒ– */
        @media (max-width: 768px) {
            #student-name-view {
                padding: 1rem;
            }
            #student-name-view h2 {
                font-size: 1.5rem;
                line-height: 1.4;
            }
            #student-classroom-code-input,
            #student-name-input {
                font-size: 16px; /* é˜²æ­¢iOS Safariç¸®æ”¾ */
            }
        }

        /* æ¶ç­”æŒ‰éˆ•æ¨£å¼ */
        .quick-answer-btn {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        .quick-answer-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        .quick-answer-btn:active {
            transform: scale(0.95);
        }
        .quick-answer-btn.locked {
            background: #9ca3af;
            cursor: not-allowed;
            animation: none;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ç¹ªåœ–æ¿ Canvas æ¨£å¼ */
        #drawing-canvas {
            border: 2px solid #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            touch-action: none; /* é˜²æ­¢åœ¨ canvas ä¸Šç¹ªåœ–æ™‚è§¸ç™¼é é¢æ»¾å‹• */
            display: block; /* Ensures it takes up its own line and respects margins */
            margin: 0 auto; /* Center the canvas */
            background-color: white; /* ç¹ªåœ–ç•«å¸ƒèƒŒæ™¯è‰² */
            flex-grow: 1; /* Allow canvas to take available vertical space */
            width: 100%; /* Ensure canvas takes full width within its container */
        }
        /* å­¸ç”Ÿä½œç­”çµæœå¡ç‰‡ */
        .student-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            margin-bottom: 0.75rem;
            word-break: break-all;
        }

        /* æ–°å¢ï¼šç”¨æ–¼å­¸ç”Ÿä½œç­”åˆ—è¡¨çš„å¡ç‰‡æ¨£å¼ */
        .student-response-item {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* å°‡å…§å®¹å‘å·¦å°é½Š */
            justify-content: flex-start; /* å°‡å…§å®¹å‘ä¸Šå°é½Š */
            text-align: left; /* å°‡æ–‡æœ¬å‘å·¦å°é½Š */
            transition: border 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Add transition for smooth border change */
        }
        .student-response-item .name-box {
            background-color: #d1e7dd; /* Light green for name */
            color: #0f5132; /* Dark green text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            width: 100%; /* Take full width within its grid column */
            max-width: 150px; /* Max width for name box */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            text-align: center; /* è®“å§“ååœ¨æ¡†å…§ç½®ä¸­ */
        }
        .student-response-item .answer-box {
            background-color: white; /* Changed to white */
            color: #0e7490; /* Dark blue text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%; /* Take full width within its grid column */
            word-break: break-word;
            flex-grow: 1; /* Allow answer box to take available space */
            min-height: 48px; /* Ensure a consistent height regardless of content */
            display: flex; /* To vertically center content */
            align-items: center;
            justify-content: center;
        }
        .student-response-item .answer-box img {
            max-width: 100%; /* Make images responsive within the answer box */
            height: auto;
            max-height: 120px; /* Limit image height to prevent large images */
            object-fit: contain; /* Ensure image fits without cropping */
            display: block; /* Remove extra space below image */
            margin: 0 auto; /* Center image if it's smaller than max-width */
        }
        .student-response-item .answer-box audio {
            width: 100%;
            max-width: 200px; /* Limit audio player width */
        }
        /* New: Styles for custom multiple choice answers in teacher monitor */
        .student-response-item .mc-question-answer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #334155;
        }
        .student-response-item .mc-question-answer .icon {
            font-size: 1.1rem;
        }
        .student-response-item .mc-question-answer .correct-icon {
            color: #16a34a; /* Green */
        }
        .student-response-item .mc-question-answer .incorrect-icon {
            color: #dc2626; /* Red */
        }
        .student-response-item .mc-question-answer .question-text {
            font-weight: 500;
        }
        .student-response-item .mc-question-answer .student-choice {
            font-weight: bold;
            color: #2563eb; /* Blue */
        }

        /* äº’è©•æŠ•ç¥¨ç›¸é—œæ¨£å¼ */
        .peer-review-work-item {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }
        
        .peer-review-work-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .peer-review-work-item .work-author {
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .peer-review-work-item .work-content {
            flex-grow: 1;
            margin-bottom: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .peer-review-work-item .work-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .peer-review-work-item .work-content p {
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .peer-review-work-item .vote-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .peer-review-work-item .vote-btn {
            background: none;
            border: 2px solid transparent;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            position: relative;
        }
        
        .peer-review-work-item .vote-btn:hover {
            background-color: #fef7f7;
            transform: scale(1.1);
            border-color: #fca5a5;
        }
        
        .peer-review-work-item .vote-btn.voted {
            color: #dc2626;
            background-color: #fef2f2;
            border-color: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .peer-review-work-item .vote-btn:not(.voted) {
            color: #9ca3af;
            border-color: #e5e7eb;
        }
        
        .peer-review-work-item .vote-btn:not(.voted):hover {
            color: #dc2626;
            background-color: #fef7f7;
        }
        
        /* Pulse animation for voted buttons */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        /* Tooltip for vote buttons */
        .peer-review-work-item .vote-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #374151;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .peer-review-work-item .vote-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        .peer-review-work-item .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .peer-review-work-item .vote-count.zero {
            color: #9ca3af;
        }

        /* æ•™å¸«ç«¯æŠ•ç¥¨çµ±è¨ˆæ¨£å¼ */
        .vote-stats-item {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .vote-stats-item .stats-author {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.375rem 0.75rem;
            border-radius: 0.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .vote-stats-item .stats-content {
            flex-grow: 1;
            margin-bottom: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .vote-stats-item .stats-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
            max-height: 120px;
            object-fit: contain;
        }
        
        .vote-stats-item .stats-content p {
            padding: 0.375rem;
            background-color: white;
            border-radius: 0.375rem;
            color: #374151;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .vote-stats-item .stats-votes {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem;
            background-color: #fef2f2;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
        }
        
        .vote-stats-item .stats-votes .vote-icon {
            color: #dc2626;
            font-size: 1.2rem;
        }
        
        .vote-stats-item .stats-votes .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .vote-stats-item .stats-votes .vote-count.zero {
            color: #9ca3af;
        }


        /* æ”¾å¤§ç¹ªåœ– Modal æ¨£å¼ */
        .magnified-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .magnified-image-modal-content {
            position: relative;
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow: auto; /* Allow scrolling for large images */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .magnified-image-modal-content img {
            max-width: 100%;
            max-height: 80vh; /* Limit image height within modal */
            object-fit: contain;
        }
        .magnified-image-modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #333;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .magnified-image-modal-close:hover {
            background-color: #eee;
        }

        /* Dropdown styles for drawing tools */
        .drawing-tool-select {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: white;
            font-size: 1rem;
            height: 44px; /* Match button height for alignment */
            cursor: pointer;
            min-width: 100px; /* Ensure dropdown has minimum width */
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }

        /* Styles for color swatch in dropdown */
        .color-option-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #ccc;
            flex-shrink: 0; /* Prevent shrinking when text is long */
        }
        /* Hidden select for visual color swatch */
        #current-color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #2563eb; /* Highlight selected color */
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }

        /* Made by link styling */
        .made-by-text {
            background-color: #e0f7fa; /* Light blue background */
            color: #007bff; /* Blue text */
            padding: 8px 15px;
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* Remove underline */
            transition: background-color 0.3s ease;
        }
        .made-by-text:hover {
            background-color: #cceeff; /* Lighter blue on hover */
            color: #0056b3;
        }

        /* Modal for student list */
        #student-list-modal-content {
            padding: 1rem;
            max-width: 700px; /* Adjusted max-width for 5 columns */
            width: 100%;
        }
        /* Applying grid to modal-student-names */
        #modal-student-names {
            display: grid;
            /* Changed to fixed 5 columns on larger screens, responsive down to 100px min width */
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem; /* Gap between grid items */
            padding: 0.5rem; /* Padding for the grid container */
            max-height: 64vh; /* Adjusted to fit more height */
            overflow-y: auto;
            background-color: #f8fafc; /* Light background */
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #modal-student-names {
                grid-template-columns: repeat(5, 1fr); /* Fixed 5 columns for md and larger */
            }
        }
        #modal-student-names p {
            background-color: #e0f2f7; /* Light blue background for each name */
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            color: #0e7490;
            font-weight: 500;
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            white-space: nowrap; /* Prevent text wrapping */
            border-bottom: none; /* Remove individual border-bottom, handled by grid gap */
            margin: 0; /* Remove default paragraph margin */
            transition: all 0.2s ease-in-out; /* Add transition for smooth highlight */
        }
        /* No specific styling for the last-child within the grid items, as gap handles spacing */

        /* NEW: Styles for Unsubmitted Students Modal */
        #modal-unsubmitted-student-names {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            padding: 0.5rem;
            max-height: 64vh;
            overflow-y: auto;
            background-color: #fef2f2; /* Light red background */
            border-radius: 0.5rem;
            border: 1px solid #fca5a5; /* Red border */
        }
        #modal-unsubmitted-student-names p {
            background-color: #fee2e2; /* Lighter red background for each name */
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            color: #b91c1c; /* Darker red text */
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #modal-unsubmitted-student-names {
                grid-template-columns: repeat(5, 1fr);
            }
        }


        /* Styles for Chart Modal */
        #statistics-modal-content { /* Changed ID to match HTML */
            padding: 1rem;
            max-width: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #chart-svg {
            display: block;
            margin: 0 auto;
            background-color: #fff; /* Ensure chart background is white */
            border-radius: 0.5rem;
            flex-shrink: 0; /* Prevent shrinking */
        }
        #students-by-answer-list-container {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #f8fafc;
        }
        #students-by-answer-list-container h5 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        /* New style for the paragraph containing names */
        #students-by-answer-names {
            word-wrap: break-word; /* Allow long names to wrap */
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* New CSS for selected student border */
        .selected-student-border {
            border: 4px solid #ef4444; /* Tailwind red-500 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); /* Optional: add a glow effect */
        }

        /* NEW CSS for selected student border in the modal */
        .modal-selected-student-border {
            border: 2px solid #ef4444; /* Red border */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); /* Optional: add a glow effect */
            background-color: #fef2f2; /* Light red background */
        }

        /* åˆé¸ä½œå“é …ç›®æ¨£å¼ */
        .preliminary-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f9fafb;
            position: relative;
        }

        .preliminary-item:hover {
            border-color: #d1d5db;
            background-color: #f3f4f6;
        }

        .preliminary-item.selected {
            border-color: #10b981;
            background-color: #ecfdf5;
            box-shadow: 0 0 0 1px #10b981;
        }

        .preliminary-item .student-name {
            font-weight: bold;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .preliminary-item .content {
            color: #6b7280;
        }

        .preliminary-item .content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.25rem;
        }

        .preliminary-item .checkbox {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
        }


        /* AI Text Summary Modal Styles */
        #ai-summary-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative; /* Needed for close button positioning */
        }
        #ai-summary-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-summary-result-list {
            list-style-type: none; /* Removed decimal numbering */
            padding-left: 0; /* Removed default padding for list */
            font-size: 1rem;
        }
        /* Default style for list items (successful results) */
        #ai-summary-result-list li {
            margin-bottom: 0.4rem;
            padding: 0.2rem 0;
            border-bottom: 1px dashed #e2e8f0;
            color: black; /* Changed to black */
            font-weight: bold; /* Added bold */
        }
        #ai-summary-result-list li:last-child {
            border-bottom: none;
        }
        /* Style for error messages within the list */
        #ai-summary-result-list li.error-message {
            color: white; /* White color for error messages */
            background-color: #dc2626; /* A red background for visual emphasis (optional, but good for error) */
            padding: 0.5rem;
            border-radius: 0.25rem;
            text-align: center;
        }
        #ai-loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px; /* Ensure some height for spinner */
            color: #2563eb;
            font-size: 1.1rem;
        }

        /* AI Settings Modal Styles */
        #ai-settings-modal-content {
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
        }
        #ai-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #ai-settings-modal-content select,
        #ai-settings-modal-content input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }
        #ai-settings-modal-content input[type="password"] {
            background-image: none; /* Remove dropdown arrow for password field */
        }
        .settings-button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .settings-button-group .btn {
            width: auto;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        /* New: URL Dispatch Modal Styles */
        #url-dispatch-settings-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        #url-dispatch-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #url-dispatch-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #url-dispatch-settings-modal-content input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .checkbox-container input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #2563eb;
        }

        /* New: Student-side URL Dispatch Styles */
        #interaction-url-dispatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 1rem;
        }
        .url-card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: inherit;
        }
        .url-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .url-card-icon {
            font-size: 4rem;
            color: #2563eb;
        }
        .url-card-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3a8a;
        }
        .url-card-link {
            font-size: 1rem;
            color: #6b7280;
            word-break: break-all;
        }
        .youtube-embed-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            background-color: #000; /* æ·»åŠ é»‘è‰²èƒŒæ™¯ï¼Œå¦‚æœå½±ç‰‡è¼‰å…¥å¤±æ•—æœƒçœ‹åˆ° */
        }
        .youtube-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* NEW: Pause Overlay for Student */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Below modals */
            border-radius: 0.5rem; /* Match container border-radius */
            text-align: center;
            padding: 1rem;
        }
        .pause-overlay p {
            font-size: 2rem;
            font-weight: bold;
            color: #dc2626; /* Red text */
            margin-bottom: 1rem;
        }
        .pause-overlay i {
            font-size: 4rem;
            color: #ef4444; /* Lighter red icon */
        }

        /* NEW: HTML Dispatch Styles */
        /* This ID is now reused for the combined dispatch, but the content will be in the iframe */
        #interaction-html-dispatch {
            position: fixed; /* Use fixed positioning to cover entire screen */
            top: 0;
            left: 0;
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden; /* Prevent scrolling at container level */
            background-color: white;
            z-index: 1000; /* Ensure it's above other content */
        }
        #html-content-iframe {
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            background-color: white;
            display: block; /* Ensure no inline spacing */
        }

        /* HTML Dispatch Status Indicator */
        .html-dispatch-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(239, 68, 68, 0.9); /* Red background with transparency */
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001; /* Above the HTML content */
            animation: blink-glow 1.5s ease-in-out infinite alternate;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        @keyframes blink-glow {
            0% {
                opacity: 0.7;
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            }
            100% {
                opacity: 1;
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.6);
            }
        }

        /* NEW: Styles for enlarged default multiple-choice buttons */
        #interaction-multiple-choice.enlarged-buttons #default-mc-options .answer-btn {
            width: min(12rem, calc(50vw - 2rem)); /* è€ƒæ…® app-container(1rem) + container padding(0.5rem) + gap(0.25rem) */
            height: min(12rem, calc(50vw - 2rem)); /* ä¿æŒæ­£æ–¹å½¢ */
            font-size: clamp(3rem, 8vw, 8rem); /* éŸ¿æ‡‰å¼å­—é«”å¤§å° */
        }
        
        /* é›»è…¦ç‰ˆæŒ‰éˆ•å®¹å™¨ - è®“å…©æ¬„æ›´ç·Šé  */
        @media (min-width: 768px) {
            #interaction-multiple-choice.enlarged-buttons #default-mc-options {
                max-width: 28rem; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œè®“æŒ‰éˆ•æ›´ç·Šé  */
                margin: 0 auto; /* ç½®ä¸­é¡¯ç¤º */
            }
        }
        
        /* MODIFIED: MC Settings Modal for AI Question Generation */
        #multiple-choice-settings-modal {
            align-items: center; /* Center modal vertically */
        }

        #multiple-choice-settings-modal-content {
            max-width: 800px; /* Wider modal for two columns */
            max-height: 95vh; /* Increase max height */
            height: auto; /* Allow dynamic height */
            justify-content: flex-start; /* Align content to top */
            align-items: stretch; /* Stretch to full width */
            padding: 1.5rem; /* Increase padding */
            margin-top: 0; /* Remove top margin */
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-6">

    <div id="entry-view" class="w-full h-screen flex flex-col items-center justify-center p-4">
    <!-- åªåœ¨ entry-view ä½¿ç”¨ flex ç½®ä¸­ï¼Œå…¶ä»– view ä¸å—å½±éŸ¿ -->
          
            <div class="w-full max-w-3xl bg-white/80 backdrop-blur-sm p-8 md:p-12 rounded-2xl shadow-xl text-center border border-gray-200">
        
                <div class="flex flex-col md:flex-row items-center justify-center mb-6">
                    <i class="fas fa-rocket text-5xl text-indigo-500 mb-4 md:mb-0 md:mr-6"></i>
                    <div>
                        <h1 class="text-4xl md:text-5xl font-bold text-gray-800">å‰›å¥½å­¸ï¼šèª²å ‚äº’å‹•so easy</h1>
                        <p class="text-lg text-gray-600 mt-2">ä¸€å€‹å°ˆç‚ºç¾ä»£èª²å ‚è¨­è¨ˆçš„å³æ™‚äº’å‹•å·¥å…·</p>
                    </div>
                </div>
                
                <hr class="my-8 border-gray-200">
        
                <p class="text-xl font-medium text-gray-700 mb-6">è«‹é¸æ“‡æ‚¨çš„è§’è‰²ä»¥é–‹å§‹</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="role-card group">
                        <div class="role-card-icon bg-blue-100 text-blue-500 group-hover:bg-blue-500 group-hover:text-white">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mt-4">æˆ‘æ˜¯æ•™å¸«</h2>
                        <p class="text-gray-500 my-2 h-12">å»ºç«‹æ•™å®¤ï¼Œç™¼èµ·äº’å‹•ï¼Œå³æ™‚æŸ¥çœ‹å­¸ç”Ÿåé¥‹ã€‚</p>
                        <button id="teacher-entry-btn" class="btn btn-primary !w-full">å»ºç«‹æˆ–é€²å…¥æ•™å®¤</button>
                    </div>
                    <div class="role-card group">
                         <div class="role-card-icon bg-green-100 text-green-500 group-hover:bg-green-500 group-hover:text-white">
                            <i class="fas fa-user-graduate"></i>
                         </div>
                         <h2 class="text-2xl font-bold text-gray-800 mt-4">æˆ‘æ˜¯å­¸ç”Ÿ</h2>
                         <p class="text-gray-500 my-2 h-12">è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼Œåƒèˆ‡èª²å ‚å•ç­”èˆ‡äº’å‹•ã€‚</p>
                        <button id="student-entry-btn" class="btn btn-green !w-full">åŠ å…¥èª²å ‚</button>
                    </div>
                </div>
            </div>
        
            <div class="text-center mt-6 text-gray-600">
                <p class="text-xs">App ID: <span id="app-id-display"></span> &nbsp;&bull;&nbsp; User ID: <span id="user-id-display"></span></p>
                <div class="mt-2">
                    <a href="https://kentxchang.blogspot.tw" target="_blank" rel="noopener noreferrer" class="made-by-text !bg-white/50 !text-indigo-600 hover:!bg-white">
                       Original made by é˜¿å‰›è€å¸«V2.4
                    </a>
                </div>
                    <div class="mt-2">
                    Modified by ç¦é¾œä¿Šç¾©è€å¸«
                </div>
            </div>
        </div>

    <div id="teacher-classroom-code-view" class="hidden text-center flex flex-col justify-center items-center min-h-screen">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼</h2>
            <div class="max-w-sm mx-auto space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="teacher-classroom-code-input" placeholder="è«‹è¼¸å…¥è‡ªè¨‚æ•™å®¤ä»£ç¢¼" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="generate-classroom-code-btn" class="btn btn-green !w-auto px-4 py-3 text-base whitespace-nowrap">ç”Ÿæˆä»£ç¢¼</button>
                </div>
                <button id="teacher-classroom-code-submit-btn" class="btn btn-primary mt-4">é€²å…¥æ•™å¸«é¢æ¿ â¡ï¸</button>
                <button id="teacher-classroom-code-back-btn" class="btn btn-gray mt-2">è¿”å› â†©ï¸</button>
            </div>
        </div>

    <div id="teacher-menu-view" class="hidden text-center relative flex flex-col justify-center items-center min-h-screen">
            <!-- é ‚éƒ¨æŒ‰éˆ•å€åŸŸ -->
            <div class="flex justify-between items-center mb-6 px-4">
                <button id="end-class-session-menu-btn" class="btn btn-red !w-auto text-xs sm:text-base h-11 px-2 sm:px-4 py-2 flex items-center justify-center" title="ä¸‹èª²ä¸¦æ¸…ç©ºè³‡æ–™">
                    <i class="fas fa-door-open mr-1 sm:mr-2"></i> <span id="end-class-button-text"><span class="sm:hidden">ä¸‹èª²</span><span class="hidden sm:inline">ä¸‹èª² ğŸ”š</span></span>
                </button>
                
                <div class="flex items-center gap-2 p-2 rounded-md bg-white shadow-sm text-sm sm:text-lg">
                    <div id="student-status-area" class="text-gray-600 cursor-pointer flex items-center justify-center hover:bg-gray-200 transition-colors">
                        <span class="hidden sm:inline">ç›®å‰æœ‰ </span><span class="sm:hidden">åœ¨ç·š </span><span id="active-student-count" class="font-bold text-blue-700">0</span><span class="hidden sm:inline"> ä½å­¸ç”Ÿåœ¨ç·š</span><span class="sm:hidden"> äºº</span>
                    </div>
                    <button id="refresh-student-count-btn" class="text-gray-500 hover:text-blue-700 transition-colors" title="æ›´æ–°çµ±è¨ˆ">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <h2 class="text-3xl font-bold text-gray-800 mb-8">æ•™å¸«é¢æ¿ï¼šè«‹é¸æ“‡äº’å‹•æ¨¡å¼</h2>

            <div class="flex flex-wrap justify-center gap-4 mx-auto max-w-6xl"> 
                <button data-mode="true_false" class="btn btn-primary !w-40 !h-40 flex items-center justify-center text-4xl">æ˜¯éé¡Œ</button>
                <button id="multiple-choice-settings-btn" class="btn btn-green !w-40 !h-40 flex items-center justify-center text-4xl">é¸æ“‡é¡Œ</button>
                <button data-mode="text_input" class="btn btn-orange !w-40 !h-40 flex items-center justify-center text-4xl">æ–‡å­—é¡Œ</button>
                <button data-mode="drawing" class="btn btn-purple !w-40 !h-40 flex items-center justify-center text-4xl">ç¹ªåœ–é¡Œ</button>
                <button data-mode="url_dispatch" class="btn btn-teal !w-40 !h-40 flex items-center justify-center text-4xl">æ´¾é€ ç¶²å€ HTML</button>
                <!-- éŒ„éŸ³é¡Œæš«æ™‚éš±è— - HTTPç’°å¢ƒä¸æ”¯æ´éº¥å…‹é¢¨æ¬Šé™ -->
                <!-- <button data-mode="recording" class="btn bg-indigo-600 hover:bg-indigo-700 !w-40 !h-40 flex items-center justify-center text-4xl">éŒ„éŸ³é¡Œ</button> -->
                <button data-mode="quick_answer" class="btn bg-red-500 hover:bg-red-600 !w-40 !h-40 flex items-center justify-center text-4xl">æ¶ç­”</button>
                
                <!-- QR Code æŒ‰éˆ• -->
                <div class="btn bg-gray-700 hover:bg-gray-600 !w-40 !h-40 flex flex-col items-center justify-center text-white cursor-pointer" id="qr-code-btn" title="å­¸ç”Ÿæƒç¢¼é€²å…¥">
                    <div class="text-xs mb-1">å­¸ç”Ÿæƒç¢¼</div>
                    <div id="qr-code-container" class="bg-white p-1 rounded">
                        <canvas id="qr-code-canvas" width="100" height="100"></canvas>
                    </div>
                    <div class="text-xs mt-1">
                        <span id="qr-classroom-code">---</span>
                    </div>
                </div>
                <!-- QR Code å…¨è¢å¹• Modal -->
                <div id="qr-code-fullscreen-modal" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50 hidden">
                    <button id="close-qr-fullscreen-btn" class="absolute top-6 right-8 text-white text-4xl">&times;</button>
                    <div class="bg-white rounded-lg p-6 flex flex-col items-center">
                        <div class="text-lg font-bold mb-2 text-gray-800">å­¸ç”Ÿæƒç¢¼</div>
                        <canvas id="qr-code-canvas-fullscreen" width="320" height="320"></canvas>
                        <div class="text-lg mt-4 text-gray-700">
                            ç­ç´šä»£ç¢¼ï¼š<span id="qr-classroom-code-fullscreen">---</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex flex-col items-center">
                <div class="flex gap-4 mb-4 w-full justify-center items-center">
                    <button id="ai-settings-btn" class="btn btn-primary !w-auto text-base h-11 px-4 py-2 flex items-center justify-center" title="AI è¨­å®š">
                        <i class="fas fa-robot"></i>
                    </button>
                    <label for="teacher-image-upload-input" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                        <i class="fas fa-upload mr-2"></i> ä¸Šå‚³ç¹ªåœ–èƒŒæ™¯åœ–ç‰‡ (æ•™å¸«ç”¨) ğŸ–¼ï¸
                    </label>
                    <input type="file" id="teacher-image-upload-input" accept="image/*" class="hidden">
                    <button id="clear-teacher-background-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                        <i class="fas fa-trash mr-2"></i> æ¸…é™¤èƒŒæ™¯åœ– ğŸ—‘ï¸
                    </button>
                    <button id="url-dispatch-settings-btn" class="btn btn-teal !w-auto text-base h-11 px-4 py-2 flex items-center justify-center" title="è¨­å®šæ´¾é€ç¶²å€/HTML">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
                <p id="teacher-image-status" class="text-gray-600 text-sm mt-2">ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚</p>
                <div id="teacher-image-preview-container" class="mt-4 hidden border border-gray-300 rounded-lg p-2 max-w-xs">
                    <img id="teacher-image-preview" src="" alt="èƒŒæ™¯åœ–ç‰‡é è¦½" class="w-full h-auto rounded-md object-contain">
                </div>
            </div>
        </div>
        
    <div id="teacher-monitor-view" class="hidden flex flex-col justify-center items-center min-h-screen">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4"> <button id="end-class-session-monitor-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center" title="ä¸‹èª²ä¸¦æ¸…ç©ºè³‡æ–™">
                        <i class="fas fa-door-open mr-2"></i> <span id="end-class-monitor-button-text">ä¸‹èª² ğŸ”š</span>
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800"></h2>
                </div>
                <div class="flex gap-2">
                     <button id="show-unsubmitted-students-btn" class="btn btn-orange !w-auto text-sm hidden !px-2 !py-1">æœªç­”</button>
                     <button id="toggle-pause-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto text-sm !px-2 !py-1">
                        <i class="fas fa-pause mr-1"></i> <span id="toggle-pause-btn-text">æš«åœ</span>
                     </button>
                     <button id="draw-lottery-btn" class="btn btn-orange !w-auto text-sm !px-2 !py-1">æŠ½ç±¤</button>
                     <button id="ai-text-summary-btn" class="btn btn-purple !w-auto text-sm hidden !px-2 !py-1">AIåˆ†æ</button> 
                     <button id="download-media-btn" class="btn btn-purple !w-auto text-sm hidden !px-2 !py-1">ä¸‹è¼‰</button> 
                     <button id="show-statistics-btn" class="btn btn-primary !w-auto text-sm hidden !px-2 !py-1">çµ±è¨ˆ</button>
                     <button id="start-preliminary-selection-btn" class="btn btn-amber !w-auto text-sm hidden !px-2 !py-1">åˆé¸</button>
                     <button id="start-peer-review-btn" class="btn btn-teal !w-auto text-sm hidden !px-2 !py-1">äº’è©•â¤ï¸</button>
                     <button id="view-questions-btn" class="btn bg-indigo-600 hover:bg-indigo-700 !w-auto text-sm hidden !px-2 !py-1">é¡Œç›®</button>
                     <button id="download-responses-btn" class="btn btn-green !w-auto text-sm hidden !px-2 !py-1">åŒ¯å‡º</button>
                     <button id="end-interaction-btn" class="btn btn-red !w-auto text-sm !px-2 !py-1">çµæŸ</button>
                 </div>
            </div>
            <div id="student-responses-container" class="bg-gray-100 p-4 rounded-lg h-96 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>
            </div>
            
            <!-- æ¶ç­”æ¨¡å¼å°ˆç”¨æ§åˆ¶å€åŸŸ -->
            <div id="quick-answer-controls" class="hidden mt-6">
                <div class="bg-white p-4 rounded-lg border">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ğŸƒâ€â™‚ï¸ æ¶ç­”æ§åˆ¶</h3>
                    <div class="flex justify-center items-center gap-4">
                        <div id="quick-answer-status" class="text-lg font-medium text-gray-700">
                            ç­‰å¾…æ¶ç­”é–‹å§‹...
                        </div>
                        <button id="restart-quick-answer-btn" class="btn btn-green !w-auto text-base px-6 py-2 hidden">
                            <i class="fas fa-redo mr-2"></i>å†ä¾†ä¸€æ¬¡ ğŸ”„
                        </button>
                    </div>
                    <div id="quick-answer-winner-display" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600 mb-2">ğŸ† æ¶ç­”æˆåŠŸ</div>
                        <div id="quick-answer-winner-name" class="text-xl text-green-800"></div>
                        <div id="quick-answer-winner-time" class="text-sm text-green-600 mt-1"></div>
                    </div>
                </div>
            </div>
            
            <div id="peer-review-stats-container" class="hidden mt-6">
                <div class="bg-white p-4 rounded-lg border">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">ğŸ“Š å³æ™‚æŠ•ç¥¨çµ±è¨ˆ</h3>
                    <div id="peer-review-stats-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <p class="text-gray-500 text-center col-span-full">å°šæœªé–‹å§‹äº’è©•...</p>
                    </div>
                </div>
            </div>
        </div>

    <div id="student-name-view" class="text-center hidden flex flex-col justify-center items-center min-h-screen">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼èˆ‡æ‚¨çš„å§“å</h2>
            <div class="max-w-sm mx-auto space-y-4">
                <input type="text" id="student-classroom-code-input" placeholder="è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                <input type="text" id="student-name-input" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="name" autocapitalize="words">
                <button id="submit-name-btn" class="btn btn-primary mt-4">é€²å…¥æ•™å®¤ ğŸšª</button>
            </div>
            
            <!-- æ‰‹æ©Ÿèª¿è©¦é¢æ¿ -->
            <div id="mobile-debug" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; max-height: 400px; overflow-y: auto; text-align: left;">
                <h4 style="margin: 0 0 10px 0; color: #333; text-align: center;">ğŸ” èª¿è©¦è³‡è¨Š</h4>
                <div id="debug-info" style="white-space: pre-wrap; color: #495057; font-family: monospace; font-size: 12px;"></div>
                <button onclick="document.getElementById('mobile-debug').style.display='none'" style="margin-top: 10px; padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">éš±è—</button>
            </div>
        </div>
        
    <div id="student-waiting-view" class="text-center hidden flex flex-col justify-center items-center min-h-screen">
             <h2 id="student-welcome-msg" class="text-3xl font-bold text-gray-800 mb-6"></h2>
             <div class="flex items-center justify-center space-x-3 text-xl text-gray-600">
                <i class="fas fa-spinner fa-spin"></i>
                <p>è«‹ç­‰å¾…è€å¸«é–‹å§‹äº’å‹•...</p>
            </div>
        </div>
        
    <div id="student-interaction-view" class="hidden flex flex-col justify-center items-center min-h-screen w-full max-w-2xl mx-auto px-2 py-4">
            <div id="student-pause-overlay" class="pause-overlay hidden">
                <p>è€å¸«å·²æš«åœå›è¦†</p>
                <i class="fas fa-hand-paper"></i>
            </div>

            <div id="interaction-true-false" class="hidden">
                <h3 class="text-2xl font-bold text-center mb-6">æ˜¯éé¡Œ</h3>
                <div class="flex justify-center gap-4">
                    <button data-answer="O" class="answer-btn text-6xl w-32 h-32 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg transform hover:scale-110 transition">O</button>
                    <button data-answer="X" class="answer-btn text-6xl w-32 h-32 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg transform hover:scale-110 transition">X</button>
                </div>
            </div>
            <div id="interaction-multiple-choice" class="hidden flex flex-col items-center">
                <h3 class="text-2xl font-bold text-center mb-6">é¸æ“‡é¡Œ</h3>
                <div id="default-mc-options" class="grid grid-cols-2 gap-2 w-full max-w-lg mx-auto px-1">
                     <button data-answer="1" class="answer-btn w-full bg-blue-500 hover:bg-blue-600 rounded-lg p-2 text-white font-bold h-16 text-4xl box-border">1</button>
                     <button data-answer="2" class="answer-btn w-full bg-yellow-500 hover:bg-yellow-600 rounded-lg p-2 text-white font-bold h-16 text-4xl box-border">2</button>
                     <button data-answer="3" class="answer-btn w-full bg-green-500 hover:bg-green-600 rounded-lg p-2 text-white font-bold h-16 text-4xl box-border">3</button>
                     <button data-answer="4" class="answer-btn w-full bg-red-500 hover:bg-red-600 rounded-lg p-2 text-white font-bold h-16 text-4xl box-border">4</button>
                </div>
                
                <div id="custom-mc-questions-container" class="hidden w-full max-w-2xl space-y-6 text-left">
                    </div>
                <button id="submit-custom-mc-btn" class="btn btn-primary mt-6 hidden max-w-sm mx-auto">é€å‡ºå…¨éƒ¨ç­”æ¡ˆ âœ‰ï¸</button>
            </div>
            <div id="interaction-text-input" class="hidden text-center">
                                <h3 class="text-2xl font-bold text-center mb-6">æ–‡å­—é¡Œ</h3>
                                <div class="w-full max-w-lg mx-auto px-2">
                                    <textarea id="text-input-area" rows="6" class="w-full p-3 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å›ç­”..." style="resize:vertical;"></textarea>
                                    <button id="submit-text-btn" class="btn btn-primary mt-4 max-w-sm mx-auto">é€å‡ºå›ç­” âœ‰ï¸</button>
                                </div>
            </div>
            <div id="interaction-drawing" class="hidden text-center flex flex-col w-full max-w-2xl mx-auto">
                <h3 class="text-2xl font-bold text-center mb-4">ç¹ªåœ–é¡Œ</h3>
                <div class="flex flex-wrap justify-center md:justify-start items-center gap-4 mb-4 p-2 bg-gray-50 rounded-lg shadow-sm flex-shrink-0 w-full max-w-2xl mx-auto">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="toggle-grid-checkbox" class="form-checkbox h-5 w-5 text-blue-600">
                        <label for="toggle-grid-checkbox" class="text-gray-700 font-medium select-none cursor-pointer">é¡¯ç¤ºç¶²æ ¼</label>
                    </div>
                    <button id="pen-tool-btn" class="p-2 rounded-lg border-2 border-blue-500 transition-all duration-150 ease-in-out h-11 flex items-center" title="ç•«ç­†">
                        <i class="fas fa-paint-brush mr-1"></i> ç•«ç­† âœï¸
                    </button>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium flex items-center" for="color-select">
                            <span id="current-color-swatch" class="color-swatch mr-2 bg-black"></span> é¡è‰²:
                        </label>
                        <select id="color-select" class="drawing-tool-select">
                            <option value="black" style="background-color: black; color: white;">é»‘è‰²</option>
                            <option value="red" style="background-color: red; color: white;">ç´…è‰²</option>
                            <option value="blue" style="background-color: blue; color: white;">è—è‰²</option>
                            <option value="green" style="background-color: green; color: white;">ç¶ è‰²</option>
                            <option value="yellow" style="background-color: yellow; color: black;">é»ƒè‰²</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium" for="size-select">ç²—ç´°:</label>
                        <select id="size-select" class="drawing-tool-select">
                            <option value="2">ç´°</option>
                            <option value="5">ä¸­</option>
                            <option value="10">ç²—</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="eraser-btn" class="p-2 rounded-lg border-2 border-transparent hover:bg-gray-200 transition-all duration-150 ease-in-out h-11" title="æ©¡çš®æ“¦"><i class="fas fa-eraser mr-1"></i> æ©¡çš®æ“¦ ğŸ§¼</button>
                        <button id="clear-canvas-btn" class="p-2 rounded-lg border-2 border-transparent hover:bg-gray-200 transition-all duration-150 ease-in-out h-11" title="æ¸…é™¤ç•«å¸ƒ"><i class="fas fa-trash mr-1"></i> æ¸…é™¤ ğŸ§¹</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="student-image-upload-input" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                            <i class="fas fa-upload mr-2"></i> ä¸Šå‚³åœ–ç‰‡ ğŸ–¼ï¸
                        </label>
                        <input type="file" id="student-image-upload-input" accept="image/*" class="hidden">
                        <button id="clear-student-image-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                            <i class="fas fa-trash mr-2"></i> æ¸…é™¤åœ–ç‰‡ ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mt-2 md:mt-0 ml-auto">
                        <button id="submit-drawing-btn" class="btn btn-primary !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">é€å‡º ğŸš€</button> </div>
                </div>
                                <div class="w-full max-w-2xl mx-auto overflow-x-auto" style="min-height:220px;">
                                                        <div id="drawing-canvas-container" style="width:640px;height:640px;max-width:100%;margin:0 auto;display:flex;align-items:center;justify-content:center;">
                                                            <canvas id="drawing-canvas" width="640" height="640" style="width:100%;height:100%;display:block;"></canvas>
                                                        </div>
                                </div>
            </div>
            <div id="interaction-url-dispatch" class="hidden">
                </div>
            <!-- éŒ„éŸ³é¡ŒUIæš«æ™‚éš±è— - HTTPç’°å¢ƒä¸æ”¯æ´éº¥å…‹é¢¨æ¬Šé™ -->
            <!--
            <div id="interaction-recording" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4">
                <h3 class="text-2xl font-bold text-center mb-6">éŒ„éŸ³é¡Œ</h3>
                <div class="flex items-center justify-center space-x-3 text-xl text-gray-600 mb-6">
                    <i id="recording-status-icon" class="fas fa-microphone-alt text-gray-400"></i>
                    <p id="recording-status-text">æº–å‚™éŒ„éŸ³...</p>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <button id="start-recording-btn" class="btn btn-green !w-40 !h-16 flex items-center justify-center text-lg">
                        <i class="fas fa-play mr-2"></i> é–‹å§‹éŒ„éŸ³ â–¶ï¸
                    </button>
                    <button id="stop-recording-btn" class="btn btn-red !w-40 !h-16 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-stop mr-2"></i> åœæ­¢éŒ„éŸ³ â¹ï¸
                    </button>
                    <button id="play-recording-btn" class="btn btn-primary !w-40 !h-16 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-volume-up mr-2"></i> è©¦è½ ğŸ”Š
                    </button>
                    <button id="reset-recording-btn" class="btn btn-orange !w-40 !h-10 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-redo mr-2"></i> é‡éŒ„ ğŸ”„
                    </button>
                </div>
                <audio id="audio-preview" controls class="w-full max-w-md mb-6 hidden"></audio>
                <button id="submit-recording-btn" class="btn btn-primary mt-4 max-w-sm mx-auto" disabled>
                    <i class="fas fa-paper-plane mr-2"></i> é€å‡ºéŒ„éŸ³ âœ‰ï¸
                </button>
            </div>
            -->
            <div id="interaction-quick-answer" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4 relative">
                <h3 class="text-2xl font-bold text-center mb-6">æ¶ç­”é¡Œ</h3>
                <p id="quick-answer-status-text" class="text-lg text-gray-600 mb-6">ç­‰å¾…æ¶ç­”é–‹å§‹...</p>
                <div id="quick-answer-button-container" class="absolute inset-0 pointer-events-none">
                    <!-- æ¶ç­”æŒ‰éˆ•å°‡æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
                <div id="quick-answer-result" class="hidden">
                    <h2 class="text-4xl font-bold text-green-600 mb-4">ğŸ‰ æ¶ç­”æˆåŠŸï¼</h2>
                    <p class="text-xl text-gray-700">ä½ æ˜¯ç¬¬ä¸€å€‹é»åˆ°æŒ‰éˆ•çš„å­¸ç”Ÿï¼</p>
                </div>
                <div id="quick-answer-locked" class="hidden">
                    <h2 class="text-4xl font-bold text-red-600 mb-4">â° æ¶ç­”çµæŸ</h2>
                    <p class="text-xl text-gray-700">å…¶ä»–åŒå­¸å·²ç¶“æ¶ç­”æˆåŠŸäº†ï¼</p>
                </div>
            </div>
        </div>

        <div id="student-peer-review-view" class="hidden">
            <div class="flex flex-col h-full min-h-screen">
                <div class="flex-shrink-0 mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">ä½œå“è§€æ‘©èˆ‡æŠ•ç¥¨</h2>
                    <p class="text-lg text-gray-600 text-center mb-6">é»æ“Šæ„›å¿ƒæŠ•ç¥¨ï¼Œå†é»æ“Šå¯å–æ¶ˆï¼æœ€å¤šå¯æŠ• <span class="font-bold text-red-600">3</span> å€‹ä¸åŒä½œå“</p>
                    <div class="text-center mb-4">
                        <span class="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium">
                            å·²æŠ•ç¥¨ï¼š<span id="current-vote-count">0</span> / 3
                        </span>
                    </div>
                </div>
                
                <div id="peer-review-works-container" class="flex-1 bg-gray-100 p-4 rounded-lg overflow-y-auto">
                    <div id="peer-review-works-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-gray-500 text-center col-span-full">è¼‰å…¥ä½œå“ä¸­...</p>
                    </div>
                </div>
                
                <div class="flex-shrink-0 mt-4 text-center">
                    <button id="exit-peer-review-btn" class="btn btn-gray !w-auto text-base h-11 px-6 py-2">
                        <i class="fas fa-arrow-left mr-2"></i> è¿”å›ç­‰å¾…
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-all duration-300 transform" role="alert">
        <p id="message-content"></p>
        <button id="close-message-btn" class="absolute top-1 right-2 text-white text-xl leading-none">Ã—</button>
    </div>

    <div id="magnified-image-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content">
            <button id="magnified-image-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <img id="magnified-image" src="" alt="æ”¾å¤§ç¹ªåœ–">
        </div>
    </div>

    <div id="student-list-modal" class="magnified-image-modal hidden">
        <div id="student-list-modal-content" class="magnified-image-modal-content">
            <button id="student-list-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">ç›®å‰åœ¨ç·šå­¸ç”Ÿ</h4>
            <button id="modal-draw-lottery-btn" class="btn btn-orange !w-auto text-sm mb-4">æŠ½ç±¤ ğŸ²</button> <div id="modal-student-names">
                <p class="text-gray-500 text-sm">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>
            </div>
        </div>
    </div>

    <div id="statistics-modal" class="magnified-image-modal hidden">
        <div id="statistics-modal-content" class="magnified-image-modal-content">
            <button id="chart-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 id="chart-title" class="text-2xl font-bold mb-4 text-gray-800">ä½œç­”çµ±è¨ˆ</h4>
            <svg id="chart-svg" width="550" height="400"></svg>
            <div id="students-by-answer-list-container" class="hidden">
                <h5 id="students-by-answer-list-title"></h5>
                <p id="students-by-answer-names" class="text-gray-700"></p> 
            </div>
        </div>
    </div>

    <div id="ai-summary-modal" class="magnified-image-modal hidden">
        <div id="ai-summary-modal-content">
            <button id="ai-summary-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4>AI æ–‡å­—åˆ†æ - ç†±é–€è©å½™</h4>
            <div id="ai-loading-spinner" class="hidden">
                <p>æ–‡å­—åˆ†æä¸­....</p>
            </div>
            <ul id="ai-summary-result-list">
                </ul>
        </div>
    </div>

    <div id="ai-settings-modal" class="magnified-image-modal hidden">
        <div id="ai-settings-modal-content" class="magnified-image-modal-content">
            <button id="ai-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4>AI è¨­å®š</h4>
            <div class="space-y-4">
                <div>
                    <label for="ai-source-select">AI æ¨¡å‹ä¾†æº:</label>
                    <select id="ai-source-select" class="drawing-tool-select">
                        <option value="gemini-default">ä½¿ç”¨ç›®å‰ Gemini (ä¸å¯ä½¿ç”¨)</option>
                        <option value="gemini-custom" selected>è‡ªè¨‚ Gemini API Key</option>
                    </select>
                </div>
                <div id="gemini-api-key-group" class="hidden">
                    <label for="gemini-api-key-input">Gemini API Key:</label>
                    <input type="password" id="gemini-api-key-input" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Gemini API Key" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="settings-button-group">
                <button id="save-ai-settings-btn" class="btn btn-primary">å„²å­˜è¨­å®š ğŸ’¾</button>
            </div>
        </div>
    </div>

    <div id="url-dispatch-settings-modal" class="magnified-image-modal hidden">
        <div id="url-dispatch-settings-modal-content" class="magnified-image-modal-content">
            <button id="url-dispatch-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4>è¨­å®šæ´¾é€ç¶²å€/HTML</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="url" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">æ´¾é€ç¶²å€</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="html" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">æ´¾é€ HTML</span>
                    </label>
                </div>

                <div id="url-dispatch-section">
                    <div>
                        <label for="dispatch-url-input">ç¶²å€:</label>
                        <input type="text" id="dispatch-url-input" placeholder="è«‹è²¼ä¸Šè¦æ´¾é€çš„ç¶²å€" class="w-full">
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="is-youtube-checkbox">
                        <label for="is-youtube-checkbox">æ­¤é€£çµç‚º YouTube å½±ç‰‡</label>
                    </div>
                </div>

                <div id="html-dispatch-section" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="flex gap-4 mb-4">
                            <label for="dispatch-html-upload-input" class="btn bg-yellow-600 !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                                <i class="fas fa-file-upload mr-2"></i> ä¸Šå‚³ HTML æª”æ¡ˆ â¬†ï¸
                            </label>
                            <input type="file" id="dispatch-html-upload-input" accept=".html" class="hidden">
                            <button id="clear-dispatch-html-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i class="fas fa-trash mr-2"></i> æ¸…é™¤ HTML ğŸ—‘ï¸
                            </button>
                        </div>
                        <p id="dispatch-html-status" class="text-gray-600 text-sm mt-2">ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚</p>
                    </div>
                </div>
            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="clear-dispatch-settings-btn" class="btn btn-red">æ¸…é™¤è¨­å®š ğŸ§¹</button>
                <button id="save-dispatch-settings-btn" class="btn btn-primary">å„²å­˜è¨­å®š ğŸ’¾</button>
            </div>
        </div>
    </div>

    <div id="unsubmitted-students-modal" class="magnified-image-modal hidden">
        <div id="unsubmitted-students-modal-content" class="magnified-image-modal-content">
            <button id="unsubmitted-students-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">æœªä½œç­”å­¸ç”Ÿåå–®</h4>
            <div id="modal-unsubmitted-student-names">
                <p class="text-gray-500 text-sm">æ‰€æœ‰å­¸ç”Ÿçš†å·²ä½œç­”æˆ–ç„¡å­¸ç”Ÿåœ¨ç·š</p>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹é¡Œç›®æ¨¡æ…‹æ¡† -->
    <div id="view-questions-modal" class="magnified-image-modal hidden">
        <div id="view-questions-modal-content" class="magnified-image-modal-content">
            <button id="view-questions-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">æŸ¥çœ‹é¡Œç›®èˆ‡æ­£ç¢ºç­”æ¡ˆ</h4>
            <div id="questions-display-container" class="w-full space-y-4 max-h-96 overflow-y-auto">
                <!-- é¡Œç›®å…§å®¹å°‡å‹•æ…‹å¡«å…¥ -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="save-correct-answers-btn" class="btn btn-green !w-auto px-6">å„²å­˜ä¿®æ”¹</button>
                <button id="cancel-questions-view-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto px-6">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="multiple-choice-settings-modal" class="magnified-image-modal hidden">
        <div id="multiple-choice-settings-modal-content" class="magnified-image-modal-content">
            <button id="multiple-choice-settings-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">é¸æ“‡é¡Œè¨­å®š</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="none" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">ç„¡é¡Œç›®å‡ºé¡Œ (é è¨­ 1-4 é¸é …)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="custom" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">è‡ªè¨‚é¡Œç›®å‡ºé¡Œ</span>
                    </label>
                </div>

                <div id="custom-mc-questions-section" class="hidden w-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="flex flex-col space-y-2">
                            <label for="custom-mc-questions-textarea" class="block text-gray-700 text-sm font-bold">
                                è«‹è¼¸å…¥é¡Œç›® (æˆ–ç”± AI ç”Ÿæˆ)
                            </label>
                            <p class="text-gray-600 text-xs">æ ¼å¼: é¡Œç›®,æ­£ç¢ºç­”æ¡ˆ(1-4æˆ–A-D),é¸é …1,é¸é …2,é¸é …3,é¸é …4 (æ¯è¡Œä¸€é¡Œ)</p>
                            <textarea id="custom-mc-questions-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow" placeholder="ä¾‹å¦‚ï¼š
å°ç£çš„é¦–éƒ½åœ¨å“ªè£¡?,1,å°åŒ—,å°ä¸­,å°å—,é«˜é›„
2+2=?,B,3,4,5,6"></textarea>
                            <p id="custom-mc-questions-status" class="text-red-500 text-sm mt-2 hidden">æ ¼å¼éŒ¯èª¤æˆ–é¡Œç›®ç‚ºç©ºï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚</p>
                        </div>

                        <div class="flex flex-col space-y-4 bg-gray-50 p-4 rounded-lg border">
                            <h5 class="text-lg font-bold text-gray-800 text-center">ğŸ¤– AI æ™ºèƒ½å‡ºé¡Œ</h5>
                            <div>
                                <label for="ai-mc-topic-textarea" class="block text-gray-700 text-sm font-bold mb-2">å‡ºé¡Œä¸»é¡Œã€ç¯„åœæˆ–è¦æ±‚:</label>
                                <textarea id="ai-mc-topic-textarea" rows="3" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="ä¾‹å¦‚ï¼š
- é—œæ–¼å°ç£æ­·å²çš„é¸æ“‡é¡Œ
- é—œæ–¼å…‰åˆä½œç”¨çš„åœ‹ä¸­ç¨‹åº¦æ˜¯éé¡Œ
- è«‹å‡ºæœ‰é—œè–èª•ç¯€çš„è‹±æ–‡å–®å­—é¸æ“‡é¡Œ"></textarea>
                            </div>
                            <div>
                                <label for="ai-mc-count-input" class="block text-gray-700 text-sm font-bold mb-2">å‡ºé¡Œæ•¸é‡ (1-10):</label>
                                <input type="number" id="ai-mc-count-input" min="1" max="10" value="5" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="text-center">
                                <button id="ai-generate-mc-btn" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center mx-auto">
                                    <i id="ai-mc-btn-icon" class="fas fa-magic mr-2"></i>
                                    <span id="ai-mc-btn-text">AI é–‹å§‹å‡ºé¡Œ</span>
                                </button>
                            </div>
                            <div id="ai-mc-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>AI æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- é¡Œåº«ç®¡ç†å€å¡Š -->
                <div id="question-bank-management-section" class="hidden w-full mt-6 bg-blue-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 text-center mb-4">ğŸ“š é¡Œåº«ç®¡ç†</h5>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- é¡Œåº«è¼‰å…¥å€ -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">å¾æª”æ¡ˆè¼‰å…¥é¡Œåº«</label>
                            <input type="file" id="question-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="load-question-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">è¼‰å…¥é¡Œåº«</button>
                        </div>

                        <!-- é¡Œåº«å„²å­˜å€ -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">å„²å­˜ç›®å‰é¡Œç›®ç‚ºé¡Œåº«</label>
                            <input type="text" id="question-bank-name-input" placeholder="è¼¸å…¥é¡Œåº«åç¨±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="save-question-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">å„²å­˜é¡Œåº«</button>
                        </div>
                    </div>

                    <!-- é¡Œåº«åˆ—è¡¨ -->
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">å·²å„²å­˜çš„é¡Œåº«</label>
                        <div id="question-bank-list" class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                            <div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="start-mc-interaction-btn" class="btn btn-primary">ç¢ºèªä¸¦é–‹å§‹äº’å‹• ğŸš€</button>
                <button id="cancel-mc-settings-btn" class="btn btn-gray">å–æ¶ˆ â†©ï¸</button>
            </div>
        </div>
    </div>

    <!-- æ•™å¸«å¯†ç¢¼é©—è­‰æ¨¡æ…‹æ¡† -->
    <div id="teacher-password-modal" class="magnified-image-modal hidden">
        <div id="teacher-password-modal-content" class="magnified-image-modal-content">
            <button id="teacher-password-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">æ•™å¸«ç™»å…¥é©—è­‰</h4>
            <div class="w-full space-y-4">
                <input type="password" id="teacher-password-modal-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-center gap-4">
                    <button id="teacher-password-submit-btn" class="btn btn-primary px-8">ç¢ºèª</button>
                    <button id="teacher-password-cancel-btn" class="btn btn-gray px-8">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆé¸æ¨¡æ…‹æ¡† -->
    <div id="preliminary-selection-modal" class="magnified-image-modal hidden">
        <div id="preliminary-selection-modal-content" class="magnified-image-modal-content">
            <button id="preliminary-selection-modal-close-btn" class="magnified-image-modal-close">Ã—</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">åˆé¸å­¸ç”Ÿä½œå“</h4>
            <p class="text-gray-600 mb-4">è«‹å‹¾é¸é€šéåˆé¸çš„ä½œå“ï¼Œåªæœ‰è¢«é¸ä¸­çš„ä½œå“æœƒé€²å…¥å­¸ç”ŸæŠ•ç¥¨éšæ®µ</p>
            <div class="mb-4">
                <span class="text-sm text-gray-500">å·²é¸: <span id="selected-count">0</span> / <span id="total-count">0</span></span>
            </div>
            <div id="preliminary-selection-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto mb-6">
                <!-- å­¸ç”Ÿä½œå“å°‡å‹•æ…‹å¡«å…¥ -->
            </div>
            <div class="flex justify-end gap-4">
                <button id="confirm-preliminary-selection-btn" class="btn btn-green !w-auto px-6">ç¢ºèªåˆé¸çµæœ</button>
                <button id="cancel-preliminary-selection-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto px-6">å–æ¶ˆ</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import PocketBase SDK
        import PocketBase from 'https://cdn.skypack.dev/pocketbase';

        // --- Global Variables ---
        // Max dimension (px) for user uploaded images to prevent excessively large files.
        const MAX_IMAGE_DIMENSION = 1024; 
        // JPEG compression quality (0.0 to 1.0).
        const JPEG_QUALITY = 0.5; // é™ä½å“è³ªä»¥æ¸›å°‘æª”æ¡ˆå¤§å°ï¼Œé¿å…è¶…é5000å­—å…ƒé™åˆ¶ 

        // PocketBase configuration
        // è‡ªå‹•æª¢æ¸¬ PocketBase ä¼ºæœå™¨åœ°å€ï¼ˆä½¿ç”¨èˆ‡ç•¶å‰é é¢ç›¸åŒçš„ host å’Œ portï¼‰
        const currentHost = window.location.host; // ä¾‹å¦‚: 192.168.0.128:8090 æˆ– 127.0.0.1:8090
        const pocketbaseUrl = `${window.location.protocol}//${currentHost}`; // ä¾‹å¦‚: http://192.168.0.128:8090
        const pb = new PocketBase(pocketbaseUrl); // PocketBase ä¼ºæœå™¨åœ°å€
        
        // Use __app_id for the base application identifier (keep for compatibility)
        const baseAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-classroom-app';
        let userId = null;
        let studentName = null;
        let currentRole = null; // 'teacher' or 'student'
        let classroomCode = null; // NEW: Stores the teacher-defined or student-entered classroom code.
        let classroomRecordId = null; // Stores the actual PocketBase record ID for the classroom
        let currentInteractionMode = null; // To track the active mode for statistics.
        let allStudentResponses = []; // Global variable to store all student responses for charting and lottery.
        let activeStudentNames = []; // NEW: Global variable to store names of all currently active students.
        let lastSelectedStudentCard = null; // To track the previously selected card for the lottery feature.
        let isResponsePaused = false; // NEW: Global state for response pause.
        let lastSelectedModalStudent = null; // NEW: To track the previously selected student in the modal for lottery.

        // é˜²æŠ–å’Œè«‹æ±‚ç®¡ç†ç›¸é—œè®Šæ•¸
        let presenceUpdateDebounceTimer = null;
        let isUpdatingPresence = false;

        // ç°¡å–®çš„ç”¨æˆ¶ç®¡ç†ç³»çµ± (æ›¿ä»£ Firebase Auth)
        function initializeUser() {
            // å¾ localStorage å–å¾—æˆ–ç”¢ç”Ÿç”¨æˆ¶ ID
            userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
                
                // è¨˜éŒ„ç”¨æˆ¶å‰µå»ºæ™‚é–“ï¼Œç”¨æ–¼æœªä¾†çš„æ¸…ç†æ©Ÿåˆ¶
                localStorage.setItem('userCreatedAt', new Date().toISOString());
                console.log('[User] Created new user ID:', userId);
            } else {
                console.log('[User] Using existing user ID:', userId);
                
                // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å¤ªèˆŠï¼ˆè¶…é30å¤©ï¼‰ï¼Œå¦‚æœæ˜¯å‰‡é‡æ–°ç”Ÿæˆ
                const userCreatedAt = localStorage.getItem('userCreatedAt');
                if (userCreatedAt) {
                    const createdDate = new Date(userCreatedAt);
                    const daysSinceCreated = (Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24);
                    
                    if (daysSinceCreated > 30) {
                        console.log(`[User] User ID is ${daysSinceCreated.toFixed(1)} days old, regenerating...`);
                        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('userId', userId);
                        localStorage.setItem('userCreatedAt', new Date().toISOString());
                    }
                }
            }
            
            // ä¸å†è‡ªå‹•æ¢å¾©æ•™å¸«çš„æ•™å®¤ä»£ç¢¼ï¼Œè®“ä½¿ç”¨è€…é‡æ–°é¸æ“‡è§’è‰²
            // è¨»è§£æ‰è‡ªå‹•æ¢å¾©é‚è¼¯
            // if (localStorage.getItem('teacherClassroomCode')) {
            //     classroomCode = localStorage.getItem('teacherClassroomCode');
            //     currentRole = 'teacher';
            // }
            
            console.log('[User] Initialized with ID:', userId);
            document.getElementById('user-id-display').textContent = userId;
            document.getElementById('app-id-display').textContent = baseAppId;
        }

        let interactionModeUnsubscribe = null;
        let questionBanks = []; // Question Bank storage in memory (will be cleared when class ends)
        let studentResponsesUnsubscribe = null;
        let classroomPresenceUnsubscribe = null; // Unsubscribe function for classroom presence listener.
        let cleanupTimerStarted = false; // æ¨™è¨˜æ˜¯å¦å·²å•Ÿå‹•æ¸…ç†å®šæ™‚å™¨

        // Drawing specific variables.
        const canvas = document.getElementById('drawing-canvas'); // Main canvas for student display.
        const ctx = canvas.getContext('2d'); // 2D context of the main canvas.

        let backgroundCanvas = document.createElement('canvas'); // Canvas for teacher's background image.
        let backgroundCtx = backgroundCanvas.getContext('2d');

        let studentImageCanvas = document.createElement('canvas'); 
        let studentImageCtx = studentImageCanvas.getContext('2d');
        let studentUploadedImageDataURL = null; // Stores the scaled and compressed student uploaded image Data URL.

        let drawingCanvas = document.createElement('canvas'); // Canvas for student's drawing strokes.
        let drawingCtx = drawingCanvas.getContext('2d');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        let teacherUploadedBackgroundImageDataURL = null; // Stores the scaled and compressed background image Data URL from Firestore.

        // AI Settings Global Object
        let aiSettings = {
            aiSource: 'gemini-custom', // 'gemini-default' or 'gemini-custom'
            geminiApiKey: '' // Custom API key if 'gemini-custom' is selected
        };
        
        // MODIFIED: Combined Dispatch Settings Global Object
        let dispatchSettings = {
            type: 'url', // 'url' or 'html'
            url: '',
            isYoutube: false, // Only relevant if type is 'url'
            htmlContent: null // Only relevant if type is 'html'
        };

        // éŒ„éŸ³ç›¸é—œè®Šæ•¸æš«æ™‚è¨»éŠ· - HTTPç’°å¢ƒä¸æ”¯æ´
        /*
        // New: Recording specific variables
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let audioDataURL = null;
        let audioStream = null; // To store the MediaStream object
        */

        // NEW: Custom Multiple Choice Questions (Teacher side)
        let customMultipleChoiceQuestions = []; // Stores parsed questions from teacher input
        let currentMultipleChoiceQuestions = null; // Stores questions from Firestore for student/teacher monitor
        let currentDispatchSettings = null; // Stores dispatch settings (URL/HTML) from Firestore

        // NEW: Peer Review System Variables
        let peerReviewActive = false; // Whether peer review is currently active
        let peerReviewUnsubscribe = null; // Unsubscribe function for peer review votes listener
        let peerReviewStatusUnsubscribe = null; // Unsubscribe function for peer review status listener
        let studentVotedWorks = new Set(); // Track which works this student has voted for
        let allPeerReviewVotes = {}; // Global object to store all votes data
        let isLoadingPeerReviewVotes = false; // Prevent concurrent vote loading requests
        let isRestoringVotingHistory = false; // Prevent concurrent voting history restoration
        let recentVoteOperation = false; // Track if student just performed a vote operation
        let lastVoteTime = 0; // è¨˜éŒ„ä¸Šæ¬¡æŠ•ç¥¨æ™‚é–“ï¼Œç”¨æ–¼é™åˆ¶æŠ•ç¥¨é »ç‡
        const MAX_VOTES_PER_STUDENT = 3; // Maximum votes per student per interaction
        const VOTE_COOLDOWN_MS = 500; // æŠ•ç¥¨å†·å»æ™‚é–“ï¼š500æ¯«ç§’
        
        // Canvas content preservation
        let savedCanvasState = null; // Save student's drawing when switching to peer review
        
        // ===== QR Code Generation Function =====
        
        /**
         * ç”Ÿæˆå­¸ç”Ÿç™»å…¥é é¢çš„QR Code
         */
        function generateQRCode(classroomCode) {
            // ç”¢ç”Ÿ http://å€ç¶²IP:port/?mode=student&classroom=æ•™å®¤IDï¼Œå„ªå…ˆç”¨ lanip åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            let lanip = urlParams.get('lanip');
            let studentUrl;
            if (lanip && /^\d+\.\d+\.\d+\.\d+$/.test(lanip)) {
                const port = location.port ? ':' + location.port : '';
                studentUrl = `http://${lanip}${port}/?mode=student&classroom=${classroomCode}`;
            } else {
                studentUrl = `${location.origin}/?mode=student&classroom=${classroomCode}`;
            }
            renderQRCode(studentUrl, classroomCode);
        }

// å°‡ QRCode ç¹ªè£½é‚è¼¯æŠ½å‡ºåˆ°å…¨åŸŸå±¤ç´š
function renderQRCode(studentUrl, classroomCode) {
    const canvas = document.getElementById('qr-code-canvas');
    const qrCodeText = document.getElementById('qr-classroom-code');
    if (!canvas) return;
    try {
        const qr = qrcode(0, 'M');
        qr.addData(studentUrl);
        qr.make();
        const ctx = canvas.getContext('2d');
        const modules = qr.getModuleCount();
        const cellSize = Math.floor(100 / modules);
        const size = cellSize * modules;
        canvas.width = size;
        canvas.height = size;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);
        ctx.fillStyle = '#000000';
        for (let row = 0; row < modules; row++) {
            for (let col = 0; col < modules; col++) {
                if (qr.isDark(row, col)) {
                    ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                }
            }
        }
        if (qrCodeText) qrCodeText.textContent = classroomCode;
    } catch (error) {
        console.error('QR Code generation failed:', error);
    }
}
        
        /**
         * æ›´æ–°QR Codeé¡¯ç¤º
         */
        function updateQRCode() {
            if (classroomCode) {
                // å»¶é²åŸ·è¡Œç¢ºä¿QRCodeåº«å·²è¼‰å…¥
                setTimeout(() => {
                    generateQRCode(classroomCode);
                }, 100);
            }
        }
        
        // ===== PocketBase API å°è£å‡½æ•¸ =====
        
        /**
         * PocketBase éŒ¯èª¤è™•ç†å‡½æ•¸
         */
        function handlePBError(error, operation) {
            console.error(`[PocketBase] ${operation} failed:`, error);
            
            // æ›´è©³ç´°çš„éŒ¯èª¤è§£æ
            console.error('å®Œæ•´éŒ¯èª¤ç‰©ä»¶:', error);
            console.error('éŒ¯èª¤åç¨±:', error.name);
            console.error('éŒ¯èª¤è¨Šæ¯:', error.message);
            console.error('HTTP ç‹€æ…‹:', error.status);
            console.error('å›æ‡‰è³‡æ–™:', error.response);
            
            if (error.response) {
                console.error('å›æ‡‰å…§å®¹:', JSON.stringify(error.response, null, 2));
            }
            
            let message = `æ“ä½œå¤±æ•—: ${operation}`;
            if (error.response?.message) {
                message += ` - ${error.response.message}`;
            }
            if (error.response?.data) {
                console.error('è©³ç´°éŒ¯èª¤è³‡è¨Š:', error.response.data);
                message += `\nè©³ç´°éŒ¯èª¤: ${JSON.stringify(error.response.data, null, 2)}`;
            }
            if (error.message) {
                message += `\néŒ¯èª¤: ${error.message}`;
            }
            showMessage(message, 'error');
        }

        /**
         * æ•™å®¤ç›¸é—œ API å°è£
         */
        const ClassroomAPI = {
            // å»ºç«‹æˆ–æ›´æ–°æ•™å®¤
            async upsert(classroomCode, data) {
                try {
                    // é€å‡ºå‰å¼·åˆ¶é‡ç¹ª backgroundCanvasï¼Œç¢ºä¿ç¶²æ ¼ç‹€æ…‹æ­£ç¢º
                    if (typeof loadBackgroundImage === 'function') {
                        loadBackgroundImage();
                    }
                    // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ•™å¸«å·²ä½¿ç”¨æ­¤æ•™å®¤ä»£ç¢¼
                    const conflictingClassrooms = await pb.collection('classrooms').getList(1, 10, {
                        filter: `code = "${classroomCode}" && app_id = "${baseAppId}"`
                    });
                    
                    if (conflictingClassrooms.items.length > 0) {
                        const existingClassroom = conflictingClassrooms.items[0];
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºåŒä¸€æ•™å¸«
                        if (existingClassroom.teacher_id !== data.teacher_id) {
                            const error = new Error(`æ•™å®¤ä»£ç¢¼ã€Œ${classroomCode}ã€å·²è¢«å…¶ä»–æ•™å¸«ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„ä»£ç¢¼ï¼`);
                            error.isClassroomCodeConflict = true;
                            throw error;
                        }
                        
                        // åŒä¸€æ•™å¸«ï¼Œæ›´æ–°ç¾æœ‰æ•™å®¤
                        const updateData = {
                            ...data,
                            // å¼·åˆ¶é‡ç½®äº’è©•ç›¸é—œç‹€æ…‹
                            peer_review_active: false,
                            peer_review_mode: null,
                            peer_review_works: null,
                            peer_review_timestamp: null,
                            // åˆé¸ç›¸é—œç‹€æ…‹
                            preliminary_selection_active: false,
                            preliminary_selected_students: [],
                            // æ›´æ–°æ´»å‹•æ™‚é–“
                            last_activity: new Date().toISOString()
                        };
                        return await pb.collection('classrooms').update(existingClassroom.id, updateData);
                    } else {
                        // å»ºç«‹æ–°æ•™å®¤ï¼Œç¢ºä¿äº’è©•ç‹€æ…‹ç‚ºåˆå§‹ç‹€æ…‹
                        const createData = {
                            code: classroomCode,
                            app_id: baseAppId,
                            ...data,
                            // ç¢ºä¿åˆå§‹äº’è©•ç‹€æ…‹
                            peer_review_active: false,
                            peer_review_mode: null,
                            peer_review_works: null,
                            peer_review_timestamp: null,
                            // åˆé¸ç›¸é—œç‹€æ…‹
                            preliminary_selection_active: false,
                            preliminary_selected_students: [],
                            // æ´»å‹•æ™‚é–“è¨˜éŒ„
                            last_activity: new Date().toISOString()
                        };
                        return await pb.collection('classrooms').create(createData);
                    }
                } catch (error) {
                    handlePBError(error, 'å»ºç«‹/æ›´æ–°æ•™å®¤');
                    throw error;
                }
            },

            // å–å¾—æ•™å®¤è³‡è¨Š
            async get(classroomCode) {
                try {
                    const records = await pb.collection('classrooms').getList(1, 1, {
                        filter: `code = "${classroomCode}" && app_id = "${baseAppId}"`,
                        sort: '-updated' // æŒ‰æ›´æ–°æ™‚é–“æ’åºï¼Œå–æœ€æ–°çš„è¨˜éŒ„
                    });
                    return records.items.length > 0 ? records.items[0] : null;
                } catch (error) {
                    handlePBError(error, 'å–å¾—æ•™å®¤è³‡è¨Š');
                    throw error;
                }
            },

            // æ›´æ–°æ•™å®¤æ´»å‹•æ™‚é–“
            async updateActivity(classroomRecordId) {
                if (!classroomRecordId) {
                    console.warn('[ClassroomAPI] updateActivity: No classroom record ID provided');
                    return;
                }
                
                try {
                    await pb.collection('classrooms').update(classroomRecordId, {
                        last_activity: new Date().toISOString()
                    });
                } catch (error) {
                    console.warn('[ClassroomAPI] Failed to update activity time:', error);
                    // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œé¿å…å½±éŸ¿ä¸»è¦åŠŸèƒ½
                }
            },

            // æ•™å®¤å›æ”¶ç›¸é—œåŠŸèƒ½
            async cleanupIdleClassrooms(idleTimeHours = 2) {
                try {
                    console.log('[ClassroomAPI] é–‹å§‹æ¸…ç†é–’ç½®æ•™å®¤...');
                    const cutoffTime = new Date();
                    cutoffTime.setHours(cutoffTime.getHours() - idleTimeHours);
                    
                    console.log(`[ClassroomAPI] æŸ¥æ‰¾é–’ç½®æ™‚é–“è¶…é ${idleTimeHours} å°æ™‚çš„æ•™å®¤ï¼ˆæ—©æ–¼ ${cutoffTime.toISOString()}ï¼‰`);
                    
                    // æŸ¥æ‰¾é–’ç½®æ•™å®¤ - PocketBase ä¸æ”¯æ´æ—¥æœŸæ¯”è¼ƒé‹ç®—ç¬¦ï¼Œä½¿ç”¨å®¢æˆ¶ç«¯éæ¿¾
                    console.log('[ClassroomAPI] ç²å–æ‰€æœ‰æ•™å®¤è¨˜éŒ„ä¸¦é€²è¡Œæ—¥æœŸéæ¿¾...');
                    const allClassrooms = await pb.collection('classrooms').getFullList({
                        filter: `app_id = "${baseAppId}"`
                    });
                    
                    const idleClassrooms = allClassrooms.filter(classroom => {
                        // ä¿è­·1ï¼šæ’é™¤ç•¶å‰æ•™å¸«æ­£åœ¨ä½¿ç”¨çš„æ•™å®¤
                        if (classroom.code === classroomCode) {
                            console.log(`[ClassroomAPI] è·³éç•¶å‰æ•™å¸«æ•™å®¤: ${classroom.code}`);
                            return false;
                        }
                        
                        // ä¿è­·2ï¼šæ’é™¤æ­£åœ¨é€²è¡Œäº’å‹•çš„æ•™å®¤ï¼ˆéwaitingç‹€æ…‹ï¼‰
                        if (classroom.active_mode && classroom.active_mode !== 'waiting') {
                            console.log(`[ClassroomAPI] è·³éæ´»èºæ•™å®¤: ${classroom.code}ï¼Œæ¨¡å¼: ${classroom.active_mode}`);
                            return false;
                        }
                        
                        // ä¿è­·3ï¼šæª¢æŸ¥æ•™å®¤å‰µå»ºæ™‚é–“ï¼Œæ–°å‰µå»ºçš„æ•™å®¤éœ€è¦æœ€å°å­˜æ´»æ™‚é–“
                        const MINIMUM_SURVIVAL_TIME_HOURS = 2; // 2å°æ™‚æœ€å°å­˜æ´»æ™‚é–“
                        if (classroom.created) {
                            const createdTime = new Date(classroom.created);
                            const minSurvivalTime = new Date();
                            minSurvivalTime.setHours(minSurvivalTime.getHours() - MINIMUM_SURVIVAL_TIME_HOURS);
                            
                            if (createdTime > minSurvivalTime) {
                                console.log(`[ClassroomAPI] è·³éæ–°å‰µå»ºæ•™å®¤: ${classroom.code}ï¼Œå‰µå»ºæ™‚é–“: ${createdTime.toISOString()}`);
                                return false;
                            }
                        }
                        
                        // ä¿è­·4ï¼šæª¢æŸ¥æœ€å¾Œæ´»å‹•æ™‚é–“
                        if (!classroom.last_activity) {
                            // æ²’æœ‰æ´»å‹•è¨˜éŒ„çš„æ•™å®¤ï¼Œä½†è¦æª¢æŸ¥å‰µå»ºæ™‚é–“
                            if (classroom.created) {
                                const createdTime = new Date(classroom.created);
                                const isOldEnough = createdTime < cutoffTime;
                                if (isOldEnough) {
                                    console.log(`[ClassroomAPI] æ•™å®¤ ${classroom.code} æ²’æœ‰ last_activity è¨˜éŒ„ä¸”å‰µå»ºæ™‚é–“è¶…éé–’ç½®æ™‚é–“ï¼Œè¦–ç‚ºé–’ç½®`);
                                    return true;
                                } else {
                                    console.log(`[ClassroomAPI] æ•™å®¤ ${classroom.code} æ²’æœ‰ last_activity è¨˜éŒ„ä½†å‰µå»ºæ™‚é–“è¼ƒæ–°ï¼Œè·³éæ¸…ç†`);
                                    return false;
                                }
                            } else {
                                console.log(`[ClassroomAPI] æ•™å®¤ ${classroom.code} æ²’æœ‰ä»»ä½•æ™‚é–“è¨˜éŒ„ï¼Œè¦–ç‚ºé–’ç½®`);
                                return true;
                            }
                        }
                        
                        const lastActivity = new Date(classroom.last_activity);
                        const isIdle = lastActivity < cutoffTime;
                        if (isIdle) {
                            console.log(`[ClassroomAPI] æ•™å®¤ ${classroom.code} æœ€å¾Œæ´»å‹•æ™‚é–“: ${lastActivity.toISOString()}ï¼Œè¦–ç‚ºé–’ç½®`);
                        }
                        return isIdle;
                    });
                    
                    console.log(`[ClassroomAPI] æ‰¾åˆ° ${idleClassrooms.length} å€‹é–’ç½®æ•™å®¤éœ€è¦æ¸…ç†`);
                    
                    // é€²ä¸€æ­¥æª¢æŸ¥æ¯å€‹é–’ç½®æ•™å®¤æ˜¯å¦çœŸçš„æ²’æœ‰å­¸ç”Ÿåœ¨ç·š
                    const finalIdleClassrooms = [];
                    for (const classroom of idleClassrooms) {
                        try {
                            // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿåœ¨ç·š
                            const onlineStudents = await pb.collection('student_presence').getFullList({
                                filter: `classroom_code = "${classroom.code}"`
                            });
                            
                            if (onlineStudents.length > 0) {
                                console.log(`[ClassroomAPI] æ•™å®¤ ${classroom.code} é‚„æœ‰ ${onlineStudents.length} å€‹å­¸ç”Ÿåœ¨ç·šï¼Œè·³éæ¸…ç†`);
                                continue;
                            }
                            
                            finalIdleClassrooms.push(classroom);
                        } catch (error) {
                            console.error(`[ClassroomAPI] æª¢æŸ¥æ•™å®¤ ${classroom.code} å­¸ç”Ÿç‹€æ…‹å¤±æ•—:`, error);
                            // å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œä¸è¦æ¸…ç†é€™å€‹æ•™å®¤
                            continue;
                        }
                    }
                    
                    console.log(`[ClassroomAPI] æœ€çµ‚ç¢ºèªéœ€è¦æ¸…ç†çš„æ•™å®¤æ•¸é‡: ${finalIdleClassrooms.length}`);
                    
                    for (const classroom of finalIdleClassrooms) {
                        console.log(`[ClassroomAPI] æ¸…ç†æ•™å®¤: ${classroom.code}`);
                        
                        try {
                            // æ¸…ç†ç›¸é—œè³‡æ–™
                            await this.cleanupClassroomData(classroom.code);
                            
                            // åˆªé™¤æ•™å®¤è¨˜éŒ„
                            await pb.collection('classrooms').delete(classroom.id);
                            
                            console.log(`[ClassroomAPI] æ•™å®¤ ${classroom.code} æ¸…ç†å®Œæˆ`);
                        } catch (error) {
                            console.error(`[ClassroomAPI] æ¸…ç†æ•™å®¤ ${classroom.code} å¤±æ•—:`, error);
                        }
                    }
                    
                    return finalIdleClassrooms.length;
                } catch (error) {
                    console.error('[ClassroomAPI] æ¸…ç†é–’ç½®æ•™å®¤å¤±æ•—:', error);
                    return 0;
                }
            },

            // æ¸…ç†ç‰¹å®šæ•™å®¤çš„æ‰€æœ‰ç›¸é—œè³‡æ–™
            async cleanupClassroomData(classroomCode) {
                try {
                    console.log(`[ClassroomAPI] æ¸…ç†æ•™å®¤ ${classroomCode} çš„ç›¸é—œè³‡æ–™...`);
                    
                    // 1. æ¸…ç†å­¸ç”Ÿå›ç­”
                    const responses = await pb.collection('student_responses').getFullList({
                        filter: `classroom_code = "${classroomCode}"`
                    });
                    for (const response of responses) {
                        await pb.collection('student_responses').delete(response.id);
                    }
                    console.log(`[ClassroomAPI] æ¸…ç†äº† ${responses.length} å€‹å­¸ç”Ÿå›ç­”`);
                    
                    // 2. æ¸…ç†å­¸ç”Ÿåœ¨ç·šç‹€æ…‹
                    const presence = await pb.collection('student_presence').getFullList({
                        filter: `classroom_code = "${classroomCode}"`
                    });
                    for (const p of presence) {
                        await pb.collection('student_presence').delete(p.id);
                    }
                    console.log(`[ClassroomAPI] æ¸…ç†äº† ${presence.length} å€‹å­¸ç”Ÿåœ¨ç·šè¨˜éŒ„`);
                    
                    // 3. æ¸…ç†äº’è©•æŠ•ç¥¨
                    const votes = await pb.collection('peer_reviews').getFullList({
                        filter: `classroom_code = "${classroomCode}"`
                    });
                    for (const vote of votes) {
                        await pb.collection('peer_reviews').delete(vote.id);
                    }
                    console.log(`[ClassroomAPI] æ¸…ç†äº† ${votes.length} å€‹æŠ•ç¥¨è¨˜éŒ„`);
                    
                    console.log(`[ClassroomAPI] æ•™å®¤ ${classroomCode} ç›¸é—œè³‡æ–™æ¸…ç†å®Œæˆ`);
                } catch (error) {
                    console.error(`[ClassroomAPI] æ¸…ç†æ•™å®¤ ${classroomCode} è³‡æ–™å¤±æ•—:`, error);
                    throw error;
                }
            },

            // æ¸…ç†å­¤ç«‹çš„æ•¸æ“šï¼ˆæ²’æœ‰å°æ‡‰æ•™å®¤çš„æ•¸æ“šï¼‰
            async cleanupOrphanedData() {
                try {
                    console.log('[ClassroomAPI] é–‹å§‹æ¸…ç†å­¤ç«‹æ•¸æ“š...');
                    
                    // å–å¾—æ‰€æœ‰å­˜åœ¨çš„æ•™å®¤ä»£ç¢¼
                    const classrooms = await pb.collection('classrooms').getFullList({
                        filter: `app_id = "${baseAppId}"`
                    });
                    const validClassroomCodes = new Set(classrooms.map(c => c.code));
                    console.log(`[ClassroomAPI] æ‰¾åˆ° ${validClassroomCodes.size} å€‹æœ‰æ•ˆæ•™å®¤`);
                    
                    let orphanedCount = 0;
                    
                    // æ¸…ç†å­¤ç«‹çš„å­¸ç”Ÿå›æ‡‰
                    const allResponses = await pb.collection('student_responses').getFullList();
                    for (const response of allResponses) {
                        if (!validClassroomCodes.has(response.classroom_code)) {
                            await pb.collection('student_responses').delete(response.id);
                            orphanedCount++;
                        }
                    }
                    console.log(`[ClassroomAPI] æ¸…ç†äº†å­¤ç«‹çš„å­¸ç”Ÿå›æ‡‰: ${orphanedCount} å€‹`);
                    
                    // æ¸…ç†å­¤ç«‹çš„å­¸ç”Ÿåœ¨ç·šç‹€æ…‹
                    orphanedCount = 0;
                    const allPresence = await pb.collection('student_presence').getFullList();
                    for (const presence of allPresence) {
                        if (!validClassroomCodes.has(presence.classroom_code)) {
                            await pb.collection('student_presence').delete(presence.id);
                            orphanedCount++;
                        }
                    }
                    console.log(`[ClassroomAPI] æ¸…ç†äº†å­¤ç«‹çš„åœ¨ç·šç‹€æ…‹: ${orphanedCount} å€‹`);
                    
                    // æ¸…ç†å­¤ç«‹çš„äº’è©•æŠ•ç¥¨
                    orphanedCount = 0;
                    const allVotes = await pb.collection('peer_reviews').getFullList();
                    for (const vote of allVotes) {
                        if (!validClassroomCodes.has(vote.classroom_code)) {
                            await pb.collection('peer_reviews').delete(vote.id);
                            orphanedCount++;
                        }
                    }
                    console.log(`[ClassroomAPI] æ¸…ç†äº†å­¤ç«‹çš„æŠ•ç¥¨è¨˜éŒ„: ${orphanedCount} å€‹`);
                    
                    console.log('[ClassroomAPI] å­¤ç«‹æ•¸æ“šæ¸…ç†å®Œæˆ');
                } catch (error) {
                    console.error('[ClassroomAPI] æ¸…ç†å­¤ç«‹æ•¸æ“šå¤±æ•—:', error);
                }
            },

            // åˆªé™¤æ•™å®¤ (çµæŸèª²ç¨‹)
            async delete(classroomCode, teacherId = null) {
                try {
                    console.log(`[ClassroomAPI] Starting deletion for classroom: ${classroomCode}`);
                    
                    // å…ˆæª¢æŸ¥æ•™å®¤æ˜¯å¦å­˜åœ¨ä¸¦é©—è­‰æ•™å¸«èº«ä»½
                    const classroomRecords = await pb.collection('classrooms').getList(1, 1, {
                        filter: `code = "${classroomCode}" && app_id = "${baseAppId}"`
                    });
                    
                    if (classroomRecords.items.length === 0) {
                        throw new Error(`æ•™å®¤ ${classroomCode} ä¸å­˜åœ¨`);
                    }
                    
                    const classroom = classroomRecords.items[0];
                    
                    // å¦‚æœæä¾›äº†æ•™å¸«IDï¼Œé©—è­‰æ˜¯å¦ç‚ºæ•™å®¤æ‰€æœ‰è€…
                    if (teacherId && classroom.teacher_id !== teacherId) {
                        const error = new Error('æ‚¨æ²’æœ‰æ¬Šé™åˆªé™¤æ­¤æ•™å®¤ï¼åªæœ‰æ•™å®¤å‰µå»ºè€…å¯ä»¥åˆªé™¤æ•™å®¤ã€‚');
                        error.isPermissionDenied = true;
                        throw error;
                    }
                    
                    // 1. å…ˆåˆªé™¤ç›¸é—œè³‡æ–™ï¼Œé¿å…å¤–éµç´„æŸå•é¡Œ
                    try {
                        console.log(`[ClassroomAPI] Deleting student responses...`);
                        await StudentResponseAPI.deleteByClassroom(classroomCode);
                        console.log(`[ClassroomAPI] Student responses deleted successfully`);
                        
                        // æ·»åŠ å°å»¶é²é¿å…è«‹æ±‚è¡çª
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        console.log(`[ClassroomAPI] Deleting student presence...`);
                        await StudentPresenceAPI.deleteByClassroom(classroomCode);
                        console.log(`[ClassroomAPI] Student presence deleted successfully`);
                        
                        // æ·»åŠ å°å»¶é²é¿å…è«‹æ±‚è¡çª
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        console.log(`[ClassroomAPI] Deleting peer review votes...`);
                        await PeerReviewAPI.deleteByClassroom(classroomCode);
                        console.log(`[ClassroomAPI] Peer review votes deleted successfully`);
                        
                        // æ·»åŠ å°å»¶é²é¿å…è«‹æ±‚è¡çª
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (relatedDataError) {
                        console.warn(`[ClassroomAPI] Failed to delete related data:`, relatedDataError);
                        // ç¹¼çºŒåŸ·è¡Œï¼Œä¸è®“ç›¸é—œè³‡æ–™åˆªé™¤å¤±æ•—é˜»æ­¢æ•™å®¤åˆªé™¤
                    }
                    
                    // 2. æœ€å¾Œåˆªé™¤æ•™å®¤è¨˜éŒ„
                    console.log(`[ClassroomAPI] Finding classroom record...`);
                    const records = await pb.collection('classrooms').getList(1, 1, {
                        filter: `code = "${classroomCode}" && app_id = "${baseAppId}"`
                    });
                    
                    if (records.items.length > 0) {
                        console.log(`[ClassroomAPI] Deleting classroom record...`);
                        await pb.collection('classrooms').delete(records.items[0].id);
                        console.log(`[ClassroomAPI] Classroom deleted successfully`);
                    } else {
                        console.log(`[ClassroomAPI] No classroom found with code: ${classroomCode}`);
                    }
                } catch (error) {
                    handlePBError(error, 'åˆªé™¤æ•™å®¤');
                    throw error;
                }
            },

            // è¨‚é–±æ•™å®¤è®Šæ›´
            subscribe(classroomCode, callback) {
                return pb.collection('classrooms').subscribe('*', function (e) {
                    if (e.record.code === classroomCode && e.record.app_id === baseAppId) {
                        callback(e);
                    }
                });
            }
        };

        /**
         * å­¸ç”Ÿå›æ‡‰ç›¸é—œ API å°è£
         */
        const StudentResponseAPI = {
            // å»ºç«‹æˆ–æ›´æ–°å­¸ç”Ÿå›æ‡‰
            async upsert(classroomCode, studentName, answer) {
                try {
                    // å…ˆæŸ¥æ‰¾ç¾æœ‰å›æ‡‰
                    const existingRecords = await pb.collection('student_responses').getList(1, 1, {
                        filter: `classroom_code = "${classroomCode}" && student_name = "${studentName}"`
                    });

                    const data = {
                        classroom_code: classroomCode,
                        student_name: studentName,
                        answer: typeof answer === 'object' ? JSON.stringify(answer) : answer,
                        timestamp: new Date().toISOString()
                    };

                    if (existingRecords.items.length > 0) {
                        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç­”æ¡ˆï¼Œå¦‚æœæœ‰å‰‡è¨˜éŒ„è­¦å‘Šä½†ä»å…è¨±æ›´æ–°ï¼ˆæ”¯æ´è€å¸«é‡æ–°é–‹å§‹äº’å‹•çš„æƒ…æ³ï¼‰
                        if (existingRecords.items[0].answer) {
                            console.warn(`[Student] ${studentName} æ­£åœ¨æ›´æ–°å·²å­˜åœ¨çš„ç­”æ¡ˆ`);
                        }
                        return await pb.collection('student_responses').update(existingRecords.items[0].id, data);
                    } else {
                        return await pb.collection('student_responses').create(data);
                    }
                } catch (error) {
                    handlePBError(error, 'é€å‡ºå­¸ç”Ÿå›æ‡‰');
                    throw error;
                }
            },

            // å–å¾—æ•™å®¤æ‰€æœ‰å­¸ç”Ÿå›æ‡‰
            async getByClassroom(classroomCode) {
                try {
                    const records = await pb.collection('student_responses').getFullList({
                        filter: `classroom_code = "${classroomCode}"`,
                        sort: '-timestamp'
                    });
                    return records;
                } catch (error) {
                    handlePBError(error, 'å–å¾—å­¸ç”Ÿå›æ‡‰');
                    throw error;
                }
            },

            // æ¸…é™¤æ•™å®¤æ‰€æœ‰å­¸ç”Ÿå›æ‡‰
            async deleteByClassroom(classroomCode) {
                try {
                    console.log(`[StudentResponseAPI] Deleting responses for classroom: ${classroomCode}`);
                    const records = await pb.collection('student_responses').getFullList({
                        filter: `classroom_code = "${classroomCode}"`
                    });
                    console.log(`[StudentResponseAPI] Found ${records.length} responses to delete`);
                    
                    for (let i = 0; i < records.length; i++) {
                        const record = records[i];
                        await pb.collection('student_responses').delete(record.id);
                        
                        // æ¯ 5 å€‹è¨˜éŒ„æ·»åŠ å°å»¶é²ï¼Œé¿å…è«‹æ±‚éæ–¼é »ç¹
                        if ((i + 1) % 5 === 0 && i < records.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }
                    console.log(`[StudentResponseAPI] Successfully deleted ${records.length} responses`);
                } catch (error) {
                    handlePBError(error, 'æ¸…é™¤å­¸ç”Ÿå›æ‡‰');
                    throw error;
                }
            },

            // è¨‚é–±å­¸ç”Ÿå›æ‡‰è®Šæ›´
            subscribe(classroomCode, callback) {
                // ç›´æ¥è¿”å› PocketBase çš„å–æ¶ˆè¨‚é–±å‡½æ•¸
                return pb.collection('student_responses').subscribe('*', function (e) {
                    if (e.record.classroom_code === classroomCode) {
                        callback(e);
                    }
                });
            }
        };

        /**
         * å­¸ç”Ÿåœ¨ç·šç‹€æ…‹ç›¸é—œ API å°è£
         */
        const StudentPresenceAPI = {
            // æ›´æ–°å­¸ç”Ÿåœ¨ç·šç‹€æ…‹
            async upsert(classroomCode, userId, studentName) {
                try {
                    // å…ˆæŸ¥æ‰¾ç¾æœ‰ç‹€æ…‹
                    const existingRecords = await pb.collection('student_presence').getList(1, 1, {
                        filter: `classroom_code = "${classroomCode}" && user_id = "${userId}"`
                    });

                    const data = {
                        classroom_code: classroomCode,
                        user_id: userId,
                        student_name: studentName,
                        last_seen: new Date().toISOString()
                    };

                    if (existingRecords.items.length > 0) {
                        return await pb.collection('student_presence').update(existingRecords.items[0].id, data);
                    } else {
                        return await pb.collection('student_presence').create(data);
                    }
                } catch (error) {
                    handlePBError(error, 'æ›´æ–°åœ¨ç·šç‹€æ…‹');
                    throw error;
                }
            },

            // å–å¾—æ•™å®¤åœ¨ç·šå­¸ç”Ÿ (åŠ å…¥é˜²æŠ–å’Œé‡è©¦æ©Ÿåˆ¶)
            async getByClassroom(classroomCode, retryCount = 0) {
                const maxRetries = 2;
                try {
                    // æš«æ™‚ç§»é™¤æ™‚é–“éæ¿¾ä»¥ä¾¿æ¸¬è©¦ï¼Œç”Ÿç”¢ç’°å¢ƒå¯ä»¥é‡æ–°å•Ÿç”¨æ™‚é–“éæ¿¾
                    const records = await pb.collection('student_presence').getFullList({
                        filter: `classroom_code = "${classroomCode}"`,
                        sort: '-last_seen'
                    });
                    return records;
                } catch (error) {
                    // å¦‚æœæ˜¯è‡ªå‹•å–æ¶ˆéŒ¯èª¤ä¸”é‚„æœ‰é‡è©¦æ¬¡æ•¸ï¼Œå‰‡é‡è©¦
                    if (error.message.includes('autocancelled') && retryCount < maxRetries) {
                        console.warn(`[StudentPresenceAPI] Request autocancelled, retrying... (${retryCount + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 200 * (retryCount + 1))); // éå¢å»¶é²
                        return this.getByClassroom(classroomCode, retryCount + 1);
                    }
                    
                    // å¦‚æœæ˜¯è‡ªå‹•å–æ¶ˆéŒ¯èª¤ä½†å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œè¿”å›ç©ºé™£åˆ—è€Œä¸æ˜¯æ‹‹å‡ºéŒ¯èª¤
                    if (error.message.includes('autocancelled')) {
                        console.warn('[StudentPresenceAPI] Request autocancelled after all retries, returning empty array');
                        return [];
                    }
                    
                    handlePBError(error, 'å–å¾—åœ¨ç·šå­¸ç”Ÿ');
                    throw error;
                }
            },

            // æ¸…é™¤æ•™å®¤æ‰€æœ‰åœ¨ç·šç‹€æ…‹
            async deleteByClassroom(classroomCode) {
                try {
                    console.log(`[StudentPresenceAPI] Deleting presence records for classroom: ${classroomCode}`);
                    const records = await pb.collection('student_presence').getFullList({
                        filter: `classroom_code = "${classroomCode}"`
                    });
                    console.log(`[StudentPresenceAPI] Found ${records.length} presence records to delete`);
                    
                    for (let i = 0; i < records.length; i++) {
                        const record = records[i];
                        await pb.collection('student_presence').delete(record.id);
                        
                        // æ¯ 3 å€‹è¨˜éŒ„æ·»åŠ å°å»¶é²ï¼Œé¿å…è«‹æ±‚éæ–¼é »ç¹
                        if ((i + 1) % 3 === 0 && i < records.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }
                    console.log(`[StudentPresenceAPI] Successfully deleted ${records.length} presence records`);
                } catch (error) {
                    handlePBError(error, 'æ¸…é™¤åœ¨ç·šç‹€æ…‹');
                    throw error;
                }
            },

            // æ¸…é™¤ç‰¹å®šå­¸ç”Ÿçš„åœ¨ç·šç‹€æ…‹
            async deleteByUserAndClassroom(classroomCode, userId) {
                try {
                    console.log(`[StudentPresenceAPI] Deleting presence for user ${userId} in classroom ${classroomCode}`);
                    const records = await pb.collection('student_presence').getFullList({
                        filter: `classroom_code = "${classroomCode}" && user_id = "${userId}"`
                    });
                    
                    for (const record of records) {
                        await pb.collection('student_presence').delete(record.id);
                    }
                    console.log(`[StudentPresenceAPI] Successfully deleted presence for user ${userId}`);
                } catch (error) {
                    handlePBError(error, 'æ¸…é™¤å­¸ç”Ÿåœ¨ç·šç‹€æ…‹');
                    throw error;
                }
            },

            // è¨‚é–±åœ¨ç·šç‹€æ…‹è®Šæ›´
            subscribe(classroomCode, callback) {
                return pb.collection('student_presence').subscribe('*', function (e) {
                    if (e.record.classroom_code === classroomCode) {
                        callback(e);
                    }
                });
            }
        };

        /**
         * åŒå„•äº’è©•ç›¸é—œ API å°è£
         */
        const PeerReviewAPI = {
            // æäº¤è©•åˆ†
            async create(classroomCode, reviewerName, reviewedName, score) {
                try {
                    return await pb.collection('peer_reviews').create({
                        classroom_code: classroomCode,
                        reviewer_name: reviewerName,
                        reviewed_name: reviewedName,
                        score: score
                    });
                } catch (error) {
                    handlePBError(error, 'æäº¤è©•åˆ†');
                    throw error;
                }
            },

            // å–å¾—è©•åˆ†çµ±è¨ˆ
            async getStats(classroomCode) {
                try {
                    const records = await pb.collection('peer_reviews').getFullList({
                        filter: `classroom_code = "${classroomCode}"`
                    });
                    return records;
                } catch (error) {
                    handlePBError(error, 'å–å¾—è©•åˆ†çµ±è¨ˆ');
                    throw error;
                }
            },

            // æ¸…é™¤è©•åˆ†è³‡æ–™
            async deleteByClassroom(classroomCode) {
                try {
                    const records = await pb.collection('peer_reviews').getFullList({
                        filter: `classroom_code = "${classroomCode}"`
                    });
                    for (const record of records) {
                        await pb.collection('peer_reviews').delete(record.id);
                    }
                } catch (error) {
                    handlePBError(error, 'æ¸…é™¤è©•åˆ†è³‡æ–™');
                    throw error;
                }
            },

            // è¨­ç½®åŒå„•äº’è©•æ´»å‹•ç‹€æ…‹
            async setActive(classroomCode, active) {
                try {
                    // æ›´æ–°æ•™å®¤çš„åŒå„•äº’è©•ç‹€æ…‹
                    const classrooms = await pb.collection('classrooms').getFullList({
                        filter: `code = "${classroomCode}"`
                    });
                    if (classrooms.length > 0) {
                        await pb.collection('classrooms').update(classrooms[0].id, {
                            peer_review_active: active
                        });
                    }
                } catch (error) {
                    handlePBError(error, 'è¨­ç½®åŒå„•äº’è©•ç‹€æ…‹');
                    throw error;
                }
            },

            // æ¸…é™¤æ‰€æœ‰è©•åˆ†
            async clearAllVotes(classroomCode) {
                try {
                    return await this.deleteByClassroom(classroomCode);
                } catch (error) {
                    handlePBError(error, 'æ¸…é™¤æ‰€æœ‰è©•åˆ†');
                    throw error;
                }
            }
        };

        // ===== åŸæœ‰è®Šæ•¸ç¹¼çºŒ =====
        

        // --- DOM Elements Caching ---
        const views = {
            entry: document.getElementById('entry-view'),
            teacherClassroomCode: document.getElementById('teacher-classroom-code-view'), // NEW VIEW
            teacherMenu: document.getElementById('teacher-menu-view'),
            teacherMonitor: document.getElementById('teacher-monitor-view'),
            studentName: document.getElementById('student-name-view'),
            studentWaiting: document.getElementById('student-waiting-view'),
            studentInteraction: document.getElementById('student-interaction-view'),
            studentPeerReview: document.getElementById('student-peer-review-view'), // NEW VIEW
        };

        const interactionUIs = {
            true_false: document.getElementById('interaction-true-false'),
            multiple_choice: document.getElementById('interaction-multiple-choice'),
            text_input: document.getElementById('interaction-text-input'),
            drawing: document.getElementById('interaction-drawing'),
            url_dispatch: document.getElementById('interaction-url-dispatch'), // Now handles both URL and HTML
            // recording: document.getElementById('interaction-recording'), // éŒ„éŸ³UIæš«æ™‚è¨»éŠ· - HTTPç’°å¢ƒä¸æ”¯æ´
            quick_answer: document.getElementById('interaction-quick-answer'), // Quick answer UI
        };

        // --- Core Logic Functions ---
        /**
         * Displays the specified view section.
         * @param {string} viewName - The name of the view to display (key in `views` object).
         */
        function showView(viewName) {
            const body = document.querySelector('body');
            body.classList.remove('initial-view-background');

            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                if (viewName === 'entry') {
                    body.classList.add('initial-view-background');
                } else if (viewName === 'teacherMenu') {
                    updateQRCode(); // ç•¶é¡¯ç¤ºæ•™å¸«é¢æ¿æ™‚æ›´æ–°QR Code
                } else if (viewName === 'teacherClassroomCode') {
                    // Reset generate button when entering classroom code view
                    const generateBtn = document.getElementById('generate-classroom-code-btn');
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'ç”Ÿæˆä»£ç¢¼';
                        generateBtn.classList.remove('btn-gray');
                        generateBtn.classList.add('btn-green');
                    }
                }
            }
        }
        
        /**
         * Displays the UI for a specific interaction mode within the student interface.
         * @param {string} mode - The interaction mode (e.g., 'true_false', 'drawing', 'recording', 'url_dispatch').
         * @param {boolean} [isResumingFromPause=false] - True if this is part of resuming from a paused state.
         */
        function showInteractionUI(mode, isResumingFromPause = false) {
             Object.values(interactionUIs).forEach(ui => ui.classList.add('hidden'));
             // Clear URL dispatch content if switching to another mode
             if (mode !== 'url_dispatch' && interactionUIs.url_dispatch) {
                interactionUIs.url_dispatch.innerHTML = ''; // Clear content for URL/HTML dispatch
                interactionUIs.url_dispatch.style.cssText = ''; // Reset container styles
             }

             if (interactionUIs[mode]) {
                interactionUIs[mode].classList.remove('hidden');
                resetStudentUIState(mode, isResumingFromPause); // Pass the flag

                // Special handling for quick answer mode
                if (mode === 'quick_answer') {
                    startQuickAnswer();
                    listenToQuickAnswerUpdates();
                }
             }
        }

        /**
         * Resets the student UI state, e.g., clears input fields or enables buttons.
         * @param {string} mode - The current interaction mode.
         * @param {boolean} [isResumingFromPause=false] - True if this reset is part of resuming from a paused state.
         */
        function resetStudentUIState(mode, isResumingFromPause = false) {
            const grayClass = 'bg-gray-400';
            const hoverClassMap = {
                '1': 'hover:bg-blue-600', '2': 'hover:bg-yellow-600',
                '3': 'hover:bg-green-600', '4': 'hover:bg-red-600'
            };
            
            // Ensure all interaction UIs are enabled by default before applying pause state
            document.querySelectorAll('#student-interaction-view button, #student-interaction-view textarea, #student-interaction-view input[type="file"], #student-interaction-view select, #student-interaction-view input[type="radio"]').forEach(el => {
                el.disabled = false;
                // Re-add original classes if they were removed by pause state
                if (el.classList.contains('btn-gray')) {
                    el.classList.remove('btn-gray');
                    el.classList.add('btn-primary'); // Assuming primary is default for many
                }
            });
            // Re-enable canvas interaction
            canvas.style.pointerEvents = 'auto';

            switch(mode) {
                case 'true_false':
                    interactionUIs[mode].querySelectorAll('.answer-btn').forEach(btn => {
                        btn.disabled = false;
                        // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ç‹€æ…‹æ¨£å¼å’Œæ¨™è¨˜
                        btn.classList.remove(grayClass, 'opacity-50', 'cursor-not-allowed', 'ring-4', 'ring-yellow-400', 'ring-opacity-75');
                        btn.removeAttribute('data-submitted'); // æ¸…é™¤æäº¤æ¨™è¨˜
                        // æ¢å¾©åŸå§‹èƒŒæ™¯è‰²
                        if (btn.dataset.answer === 'O') btn.classList.replace('bg-gray-400', 'bg-green-500');
                        if (btn.dataset.answer === 'X') btn.classList.replace('bg-gray-400', 'bg-red-500');
                        // æ¢å¾©æ‡¸åœæ•ˆæœ
                        btn.classList.add('hover:scale-110');
                    });
                    break;
                case 'multiple_choice':
                    // Reset default MC options
                    const defaultMcOptions = document.getElementById('default-mc-options');
                    defaultMcOptions.querySelectorAll('.answer-btn').forEach(btn => {
                        btn.disabled = false;
                        // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ç‹€æ…‹æ¨£å¼å’Œæ¨™è¨˜
                        btn.classList.remove(grayClass, 'opacity-50', 'cursor-not-allowed', 'ring-4', 'ring-yellow-400', 'ring-opacity-75');
                        btn.removeAttribute('data-submitted'); // æ¸…é™¤æäº¤æ¨™è¨˜
                        // æ¢å¾©åŸå§‹èƒŒæ™¯è‰²
                        if (btn.dataset.answer === '1') btn.classList.replace('bg-gray-400', 'bg-blue-500');
                        if (btn.dataset.answer === '2') btn.classList.replace('bg-gray-400', 'bg-yellow-500');
                        if (btn.dataset.answer === '3') btn.classList.replace('bg-gray-400', 'bg-green-500');
                        if (btn.dataset.answer === '4') btn.classList.replace('bg-gray-400', 'bg-red-500');
                        // æ¢å¾©æ‡¸åœæ•ˆæœ
                        btn.classList.add(hoverClassMap[btn.dataset.answer], 'hover:scale-110');
                    });
                    // Reset custom MC options (but preserve submission state)
                    document.getElementById('custom-mc-questions-container').innerHTML = '';
                    // NEW: åªæœ‰åœ¨ä¸æ˜¯å¾æš«åœç‹€æ…‹æ¢å¾©æ™‚æ‰é‡ç½®æŒ‰éˆ•ï¼Œé¿å…è¦†è“‹å·²æäº¤ç‹€æ…‹
                    if (!isResumingFromPause) {
                        const submitBtn = document.getElementById('submit-custom-mc-btn');
                        submitBtn.disabled = false;
                        submitBtn.classList.replace('btn-gray', 'btn-primary');
                        submitBtn.textContent = 'é€å‡ºå…¨éƒ¨ç­”æ¡ˆ âœ‰ï¸';
                    }
                    break;
                case 'text_input':
                    // NEW: åªæœ‰åœ¨ä¸æ˜¯å¾æš«åœç‹€æ…‹æ¢å¾©ä¸”æ²’æœ‰å·²æäº¤ç­”æ¡ˆæ™‚æ‰é‡ç½®
                    if (!isResumingFromPause) {
                        // Check if student already has a submitted answer
                        checkAndRestoreTextAnswer();
                    }
                    break;
                case 'drawing':
                    // Only clear the drawing canvas if it's NOT resuming from a pause.
                    // If isResumingFromPause is true, it means we are re-enabling controls
                    // within the *same* drawing session after a pause, so preserve the drawing.
                    if (!isResumingFromPause) {
                         clearDrawingCanvas(); // Clears only the student's drawing layer.
                         studentUploadedImageDataURL = null; // Clear student uploaded image too
                         studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                         
                         // æª¢æŸ¥ä¸¦æ¢å¾©ç¹ªåœ–æäº¤ç‹€æ…‹
                         checkAndRestoreDrawingAnswer();
                    }
                    
                    // Reset drawing tools to default values.
                    const colorSelect = document.getElementById('color-select');
                    const sizeSelect = document.getElementById('size-select');
                    const penToolBtn = document.getElementById('pen-tool-btn');
                    const eraserBtn = document.getElementById('eraser-btn');

                    colorSelect.value = 'black';
                    sizeSelect.value = '2';
                    drawingCtx.strokeStyle = 'black'; 
                    drawingCtx.lineWidth = 2;
                    drawingCtx.globalCompositeOperation = 'source-over'; 
                    
                    penToolBtn.classList.add('border-blue-500');
                    eraserBtn.classList.remove('border-blue-500');

                    updateColorSwatch(colorSelect.value);
                    break;
                case 'url_dispatch': // This mode now handles both URL and HTML
                    // Content is dynamically generated, no specific reset needed here beyond clearing in showInteractionUI
                    break;
                /*
                // éŒ„éŸ³æ¨¡å¼è™•ç†æš«æ™‚è¨»éŠ· - HTTPç’°å¢ƒä¸æ”¯æ´
                case 'recording':
                    // Reset recording state
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                    }
                    audioChunks = [];
                    audioBlob = null;
                    audioDataURL = null;
                    document.getElementById('audio-preview').classList.add('hidden');
                    document.getElementById('audio-preview').src = '';
                    document.getElementById('start-recording-btn').disabled = false;
                    document.getElementById('stop-recording-btn').disabled = true;
                    document.getElementById('play-recording-btn').disabled = true;
                    document.getElementById('reset-recording-btn').disabled = true;
                    document.getElementById('submit-recording-btn').disabled = true;
                    
                    // æª¢æŸ¥éŒ„éŸ³æ”¯æ´å’Œæä¾›æŒ‡å°
                    checkRecordingSupport();
                    break;
                */
                case 'quick_answer':
                    // Reset quick answer state
                    quickAnswerActive = false;
                    quickAnswerWinner = null;
                    quickAnswerWinnerDisplayed = false;
                    
                    // å–æ¶ˆæ¶ç­”ç›£è½å™¨ - åŠ å…¥é¡å‹æª¢æŸ¥
                    if (quickAnswerSubscription && typeof quickAnswerSubscription === 'function') {
                        quickAnswerSubscription();
                        quickAnswerSubscription = null;
                    }
                    
                    document.getElementById('quick-answer-status-text').textContent = 'ç­‰å¾…æ¶ç­”é–‹å§‹...';
                    document.getElementById('quick-answer-result').classList.add('hidden');
                    document.getElementById('quick-answer-locked').classList.add('hidden');
                    document.getElementById('quick-answer-button-container').innerHTML = '';
                    document.getElementById('quick-answer-button-container').classList.add('pointer-events-none');
                    break;
            }
        }

        /**
         * Toggles the enabled/disabled state of student interaction elements.
         * @param {boolean} disable - True to disable, false to enable.
         */
        function toggleStudentInteractionElements(disable) {
            const studentInteractionView = document.getElementById('student-interaction-view');
            // Select all interactive elements within the student interaction view, excluding the pause overlay itself.
            const interactiveElements = studentInteractionView.querySelectorAll(
                'button, textarea, input[type="file"], select, input[type="radio"]' // Added input[type="radio"]
            );

            interactiveElements.forEach(el => {
                // Only disable if the element is not the pause overlay itself or its children
                if (!el.closest('#student-pause-overlay')) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºå·²æäº¤ç­”æ¡ˆçš„æŒ‰éˆ•ï¼Œå¦‚æœæ˜¯å‰‡ä¸è¦é‡æ–°å•Ÿç”¨
                    if (!disable) {
                        // æª¢æŸ¥å„ç¨®å·²æäº¤ç‹€æ…‹çš„æ¨™è¨˜
                        if (el.hasAttribute('data-submitted') || 
                            el.textContent.includes('å·²é€å‡º') || 
                            el.textContent.includes('å·²æäº¤') ||
                            el.textContent.includes('âœ“')) {
                            // ä¿æŒå·²æäº¤æŒ‰éˆ•çš„ç¦ç”¨ç‹€æ…‹
                            return;
                        }
                    }
                    
                    el.disabled = disable;
                    if (disable) {
                        // Add a class for visual feedback if needed, e.g., gray out
                        if (el.tagName === 'BUTTON' && !el.classList.contains('btn-gray')) {
                            el.classList.add('btn-gray');
                            el.classList.remove('btn-primary', 'btn-green', 'btn-orange', 'btn-purple', 'btn-teal', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-yellow-600', 'hover:bg-yellow-700'); // Remove original colors
                        }
                    } else {
                        // Re-enable and restore original styles
                        if (el.tagName === 'BUTTON' && el.classList.contains('btn-gray')) {
                            el.classList.remove('btn-gray');
                            // Restore based on common button types or specific IDs
                            if (el.id === 'submit-text-btn' || el.id === 'submit-drawing-btn' || el.id === 'submit-custom-mc-btn') { // ç§»é™¤submit-recording-btn - éŒ„éŸ³åŠŸèƒ½å·²è¨»éŠ·
                                el.classList.add('btn-primary');
                            } else if (el.classList.contains('answer-btn')) {
                                // For answer buttons, re-apply their specific colors
                                if (el.dataset.answer === 'O') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === 'X') el.classList.add('bg-red-500');
                                else if (el.dataset.answer === '1') el.classList.add('bg-blue-500');
                                else if (el.dataset.answer === '2') el.classList.add('bg-yellow-500');
                                else if (el.dataset.answer === '3') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === '4') el.classList.add('bg-red-500');
                            } else if (el.id === 'start-recording-btn') {
                                el.classList.add('btn-green');
                            } else if (el.id === 'stop-recording-btn') {
                                el.classList.add('btn-red');
                            } else if (el.id === 'play-recording-btn') {
                                el.classList.add('btn-primary');
                            } else if (el.id === 'reset-recording-btn') {
                                el.classList.add('btn-orange');
                            } else if (el.id === 'pen-tool-btn') {
                                el.classList.add('border-blue-500'); // Pen button border
                            }
                        }
                    }
                }
            });

            // Handle canvas interaction separately
            canvas.style.pointerEvents = disable ? 'none' : 'auto';

            // Handle recording specific buttons that might be disabled by default
            if (currentInteractionMode === 'recording' && !disable) {
                // Only enable start if not already recording
                if (mediaRecorder && mediaRecorder.state === 'inactive') {
                    document.getElementById('start-recording-btn').disabled = false;
                }
                // Other recording buttons remain disabled until recording starts/stops
            }
        }
        
        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         * @param {'info' | 'success' | 'error'} type - The message type, influencing its color.
         */
        function showMessage(message, type = 'info') {
            const msgBox = document.getElementById('message-box');
            const msgContent = document.getElementById('message-content');
            msgContent.textContent = message;
            msgBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform text-white';
            switch (type) {
                case 'success': msgBox.classList.add('bg-green-500'); break;
                case 'error': msgBox.classList.add('bg-red-500'); break;
                case 'info': msgBox.classList.add('bg-blue-500'); break;
                default: msgBox.classList.add('bg-blue-500'); break;
            }
            msgBox.classList.remove('hidden');
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 3000); // Auto-hide after 3 seconds.
        }

        /**
         * Question Bank Management Functions
         */
        function updateQuestionBankList() {
            const list = document.getElementById('question-bank-list');
            if (questionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ç›®å‰æ²’æœ‰å„²å­˜çš„é¡Œåº«</div>';
            } else {
                list.innerHTML = questionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadQuestionBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">è¼‰å…¥</button>
                            <button onclick="deleteQuestionBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadQuestionBankFromFile() {
            const fileInput = document.getElementById('question-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('è«‹é¸æ“‡ä¸€å€‹txtæª”æ¡ˆ', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('åªèƒ½ä¸Šå‚³txtæ ¼å¼çš„æª”æ¡ˆ', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');

                // Check if bank with same name exists
                const existingIndex = questionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`é¡Œåº«ã€Œ${fileName}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                        questionBanks[existingIndex] = { name: fileName, content: content };
                    } else {
                        return;
                    }
                } else {
                    questionBanks.push({ name: fileName, content: content });
                }

                updateQuestionBankList();
                showMessage(`é¡Œåº«ã€Œ${fileName}ã€è¼‰å…¥æˆåŠŸ`, 'success');
                fileInput.value = ''; // Clear file input
            };

            reader.onerror = function() {
                showMessage('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveQuestionBankFromTextarea() {
            const nameInput = document.getElementById('question-bank-name-input');
            const textarea = document.getElementById('custom-mc-questions-textarea');
            const name = nameInput.value.trim();
            const content = textarea.value.trim();

            if (!name) {
                showMessage('è«‹è¼¸å…¥é¡Œåº«åç¨±', 'error');
                return;
            }

            if (!content) {
                showMessage('é¡Œç›®å…§å®¹ä¸èƒ½ç‚ºç©º', 'error');
                return;
            }

            // Check if bank with same name exists
            const existingIndex = questionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`é¡Œåº«ã€Œ${name}ã€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†è“‹ï¼Ÿ`)) {
                    questionBanks[existingIndex] = { name: name, content: content };
                } else {
                    return;
                }
            } else {
                questionBanks.push({ name: name, content: content });
            }

            updateQuestionBankList();
            showMessage(`é¡Œåº«ã€Œ${name}ã€å„²å­˜æˆåŠŸ`, 'success');
            nameInput.value = ''; // Clear name input
        }

        function loadQuestionBankToTextarea(index) {
            if (index >= 0 && index < questionBanks.length) {
                const textarea = document.getElementById('custom-mc-questions-textarea');
                textarea.value = questionBanks[index].content;
                showMessage(`é¡Œåº«ã€Œ${questionBanks[index].name}ã€å·²è¼‰å…¥åˆ°è¼¸å…¥æ¡†`, 'success');
            }
        }

        function deleteQuestionBank(index) {
            if (index >= 0 && index < questionBanks.length) {
                const bankName = questionBanks[index].name;
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é¡Œåº«ã€Œ${bankName}ã€å—ï¼Ÿ`)) {
                    questionBanks.splice(index, 1);
                    updateQuestionBankList();
                    showMessage(`é¡Œåº«ã€Œ${bankName}ã€å·²åˆªé™¤`, 'success');
                }
            }
        }

        // Make functions globally accessible for onclick handlers
        window.loadQuestionBankToTextarea = loadQuestionBankToTextarea;
        window.deleteQuestionBank = deleteQuestionBank;

        function clearAllQuestionBanks() {
            questionBanks = [];
            updateQuestionBankList();
        }

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // --- Firebase Functions ---

        /**
         * (Teacher) Sets the current interaction mode and clears old student response data.
         * @param {string} mode - 'true_false', 'multiple_choice', 'text_input', 'drawing', 'url_dispatch', 'recording', or 'waiting'.
         * @param {object} [options={}] - Optional settings for the mode, e.g., custom questions.
         */
        async function setInteractionMode(mode, options = {}) {
            console.log(`[Teacher] Setting mode to: ${mode}`);
            currentInteractionMode = mode; 

            const showStatisticsBtn = document.getElementById('show-statistics-btn');
            const downloadMediaBtn = document.getElementById('download-media-btn');
            const aiTextSummaryBtn = document.getElementById('ai-text-summary-btn');
            const showUnsubmittedStudentsBtn = document.getElementById('show-unsubmitted-students-btn');
            const viewQuestionsBtn = document.getElementById('view-questions-btn');
            const downloadResponsesBtn = document.getElementById('download-responses-btn');

            // MODIFIED: Show statistics button for true_false and multiple_choice (both default and custom)
            showStatisticsBtn.classList.toggle('hidden', mode !== 'true_false' && mode !== 'multiple_choice');
            
            // NEW: Show view questions button only for multiple_choice with custom questions
            const hasCustomQuestions = mode === 'multiple_choice' && options.customQuestions && options.customQuestions.length > 0;
            viewQuestionsBtn.classList.toggle('hidden', !hasCustomQuestions);
            
            // NEW: Show peer review button only for text_input and drawing modes
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            startPeerReviewBtn.classList.toggle('hidden', mode !== 'text_input' && mode !== 'drawing');
            
            // NEW: Show preliminary selection button only for text_input and drawing modes
            const startPreliminarySelectionBtn = document.getElementById('start-preliminary-selection-btn');
            startPreliminarySelectionBtn.classList.toggle('hidden', mode !== 'text_input' && mode !== 'drawing');
            
            // NEW: Reset peer review button state when starting new interaction
            if (mode !== 'waiting') {
                peerReviewActive = false;
                startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> é–‹å§‹äº’è©• â¤ï¸';
                document.getElementById('peer-review-stats-container').classList.add('hidden');
                
                // Reset peer review status in PocketBase for new interaction
                // (TODO: Implement peer review API when migrating peer review functionality)
                
                // Clear student voting history for new interaction
                studentVotedWorks.clear();
                
                // Clear saved canvas state for new interaction
                savedCanvasState = null;
            }
            downloadMediaBtn.classList.toggle('hidden', mode !== 'drawing' && mode !== 'recording');
            aiTextSummaryBtn.classList.toggle('hidden', mode !== 'text_input');
            // Note: Unsubmitted students button visibility is now handled dynamically by updateUnsubmittedStudentsButtonVisibility()
            // NEW: Show download responses button for text_input mode and multiple_choice with custom questions
            const showDownloadBtn = mode === 'text_input' || (mode === 'multiple_choice' && hasCustomQuestions);
            downloadResponsesBtn.classList.toggle('hidden', !showDownloadBtn);

            // NEW: Hide pause button for URL/HTML dispatch modes
            const togglePauseBtn = document.getElementById('toggle-pause-btn');
            togglePauseBtn.classList.toggle('hidden', mode === 'url_dispatch');

            try {
                // Clear previous student responses unless it's a waiting state.
                if (mode !== 'waiting') {
                    await StudentResponseAPI.deleteByClassroom(classroomCode);
                console.log("[Teacher] Cleared all previous student responses.");
                lastSelectedStudentCard = null; // Clear highlight on monitor view
            }

            // Prepare data payload for PocketBase
            let backgroundImageFileName = null;
            if (mode === 'drawing' && classroomRecordId) {
                // å–å¾— classroom æœ€æ–°è³‡æ–™ï¼Œå– background_image_file æ¬„ä½
                try {
                    const classroom = await pb.collection('classrooms').getOne(classroomRecordId);
                    backgroundImageFileName = classroom.background_image_file || null;
                } catch (e) {
                    backgroundImageFileName = null;
                }
            }
            const payload = { 
                active_mode: mode,
                background_image: backgroundImageFileName,
                teacher_id: userId, // Store teacher ID
                is_paused: isResponsePaused // Use current local pause state
            };
                        
            // MODIFIED: Add combined dispatch settings if in that mode.
                if (mode === 'url_dispatch') {
                    payload.dispatch_settings = JSON.stringify(dispatchSettings); // Send the entire dispatchSettings object as JSON
                } else {
                    payload.dispatch_settings = null; // Clear dispatch settings if not in URL_DISPATCH mode
                }

                // NEW: Add custom multiple choice questions if in that mode.
                if (mode === 'multiple_choice' && options.hasOwnProperty('customQuestions')) {
                    payload.multiple_choice_questions = JSON.stringify(options.customQuestions);
                } else {
                    payload.multiple_choice_questions = null; // Clear if not multiple_choice mode or if customQuestions not provided
                }
                currentMultipleChoiceQuestions = payload.multiple_choice_questions ? JSON.parse(payload.multiple_choice_questions) : null; // Update global for teacher monitor

                await ClassroomAPI.upsert(classroomCode, payload);
                
                // æ›´æ–°æ•™å®¤æ´»å‹•æ™‚é–“
                if (classroomRecordId) {
                    await ClassroomAPI.updateActivity(classroomRecordId);
                }

                // Handle student responses listener based on mode
                if (studentResponsesUnsubscribe && typeof studentResponsesUnsubscribe === 'function') {
                    studentResponsesUnsubscribe();
                    studentResponsesUnsubscribe = null;
                }

                if (mode === 'url_dispatch') { // Now handles both URL and HTML
                    // For URL/HTML dispatch, the monitor view shows online students, handled by presence listener.
                    // Clear existing responses display if any.
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                    // Hide lottery and unsubmitted students buttons in url_dispatch mode
                    const drawLotteryBtn = document.getElementById('draw-lottery-btn');
                    const showUnsubmittedBtn = document.getElementById('show-unsubmitted-students-btn');
                    if (drawLotteryBtn) drawLotteryBtn.classList.add('hidden');
                    if (showUnsubmittedBtn) showUnsubmittedBtn.classList.add('hidden');
                } else if (mode === 'waiting') {
                    // When going to 'waiting' mode, ensure the student responses container is cleared
                    // and shows the "waiting" message.
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                } else { // For other interaction modes (true_false, multiple_choice, text_input, drawing, recording, quick_answer)
                    listenToStudentSubmissions(mode); // Ensure this listener is active
                }

                // Special handling for quick answer mode - show teacher controls
                if (mode === 'quick_answer') {
                    console.log('[Teacher] Setting up quick answer controls...');
                    const quickAnswerControls = document.getElementById('quick-answer-controls');
                    const quickAnswerStatus = document.getElementById('quick-answer-status');
                    const winnerDisplay = document.getElementById('quick-answer-winner-display');
                    const restartBtn = document.getElementById('restart-quick-answer-btn');
                    
                    if (quickAnswerControls) {
                        quickAnswerControls.classList.remove('hidden');
                        console.log('[Teacher] Showed quick answer controls panel');
                    }
                    if (quickAnswerStatus) {
                        quickAnswerStatus.textContent = 'é»æ“Šä¸‹æ–¹é–‹å§‹æ¶ç­”...';
                        console.log('[Teacher] Updated initial status');
                    }
                    if (winnerDisplay) winnerDisplay.classList.add('hidden');
                    if (restartBtn) restartBtn.classList.add('hidden');
                    
                    // Hide lottery and unsubmitted students buttons in quick answer mode
                    const drawLotteryBtn = document.getElementById('draw-lottery-btn');
                    const showUnsubmittedBtn = document.getElementById('show-unsubmitted-students-btn');
                    if (drawLotteryBtn) drawLotteryBtn.classList.add('hidden');
                    if (showUnsubmittedBtn) showUnsubmittedBtn.classList.add('hidden');
                    
                    // Reset quick answer state
                    quickAnswerActive = false;
                    quickAnswerWinner = null;
                    quickAnswerWinnerDisplayed = false;
                } else {
                    // Hide quick answer controls for other modes
                    const quickAnswerControls = document.getElementById('quick-answer-controls');
                    if (quickAnswerControls) {
                        quickAnswerControls.classList.add('hidden');
                    }
                    // Show lottery button only for specific modes (é url_dispatch)
                    const drawLotteryBtn = document.getElementById('draw-lottery-btn');
                    if (drawLotteryBtn) {
                        if (mode === 'true_false' || mode === 'multiple_choice' || mode === 'text_input' || mode === 'drawing') {
                            drawLotteryBtn.classList.remove('hidden');
                        } else {
                            drawLotteryBtn.classList.add('hidden');
                        }
                    }
                    // Note: showUnsubmittedBtn is shown/hidden based on response data, not mode
                }

                // Update unsubmitted students button visibility after mode change
                updateUnsubmittedStudentsButtonVisibility(mode);

            } catch (error) {
                console.error("è¨­å®šäº’å‹•æ¨¡å¼æˆ–æ¸…é™¤å­¸ç”Ÿè³‡æ–™å¤±æ•—:", error);
                showMessage("æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç®¡ç†å“¡ã€‚", "error");
            }
        }

        /**
         * (Student) Listens for changes in the teacher's interaction mode and switches the student interface accordingly.
         */
        function listenToInteractionMode() {
            // Ensure only one interaction mode listener is active for the student
            if (interactionModeUnsubscribe) interactionModeUnsubscribe(); 

            interactionModeUnsubscribe = ClassroomAPI.subscribe(classroomCode, async (e) => {
                console.log('[Student] Classroom update received:', e.action, e.record);
                
                const studentPauseOverlay = document.getElementById('student-pause-overlay');
                const interactionMultipleChoice = document.getElementById('interaction-multiple-choice');

                if (e.action === 'delete') {
                    // Teacher has ended the class session (classroom deleted)
                    console.log("[Student] Teacher has ended the class session.");
                    // æ¸…ç†æ‰€æœ‰ç›¸é—œç‹€æ…‹
                    const currentClassroomCode = classroomCode; // ä¿å­˜ç•¶å‰æ•™å®¤ä»£ç¢¼
                    classroomCode = null; // Clear student's classroom code
                    classroomRecordId = null; // Clear classroom record ID
                    studentName = null; // Clear student's name
                    currentRole = null; // Clear current role
                    currentInteractionMode = null; // Reset global mode for student
                    isResponsePaused = false; // Reset global pause state for student
                    allStudentResponses = []; // Clear responses if any
                    
                    // é‡ç½® UI é¡¯ç¤º
                    document.getElementById('user-id-display').textContent = userId; // Reset user ID display
                    
                    // æ¸…ç†æœ¬åœ°å„²å­˜
                    localStorage.removeItem('studentClassroomCode');
                    localStorage.removeItem('studentName');
                    
                    // æ¸…é™¤URLåƒæ•¸ï¼Œé˜²æ­¢å­¸ç”Ÿè‡ªå‹•é‡æ–°ç™»å…¥
                    if (window.location.search) {
                        const url = new URL(window.location);
                        url.search = ''; // æ¸…é™¤æ‰€æœ‰URLåƒæ•¸
                        window.history.replaceState({}, document.title, url.pathname);
                        console.log('[Student] Cleared URL parameters to prevent auto re-login');
                    }
                    
                    console.log(`[Student] Cleaned up local state for classroom: ${currentClassroomCode}`);
                    
                    // å…ˆé¡¯ç¤ºè¨Šæ¯è®“å­¸ç”ŸçŸ¥é“èª²ç¨‹çµæŸ
                    showMessage('ğŸ“ è€å¸«å·²çµæŸèª²ç¨‹ï¼Œç³»çµ±å°‡æ–¼ 3 ç§’å¾Œè‡ªå‹•é‡æ–°æ•´ç†ï¼Œç¢ºä¿æ‚¨ä¸‹æ¬¡èƒ½æ­£å¸¸ç™»å…¥...', 'info');
                    showView('entry'); // Go back to the initial entry screen
                    
                    // Unsubscribe from student responses and presence if they were active
                    if (studentResponsesUnsubscribe && typeof studentResponsesUnsubscribe === 'function') {
                        studentResponsesUnsubscribe();
                        studentResponsesUnsubscribe = null;
                    }
                    // IMPORTANT: Unsubscribe student's presence listener as well when class ends
                    if (classroomPresenceUnsubscribe && typeof classroomPresenceUnsubscribe === 'function') {
                        classroomPresenceUnsubscribe();
                        classroomPresenceUnsubscribe = null;
                    }
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay if class ends
                    
                    // å€’æ•¸è¨ˆæ™‚ä¸¦è‡ªå‹•é‡æ–°æ•´ç†é é¢
                    let countdown = 3;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            showMessage(`ğŸ“ è€å¸«å·²çµæŸèª²ç¨‹ï¼Œç³»çµ±å°‡æ–¼ ${countdown} ç§’å¾Œè‡ªå‹•é‡æ–°æ•´ç†ï¼Œç¢ºä¿æ‚¨ä¸‹æ¬¡èƒ½æ­£å¸¸ç™»å…¥...`, 'info');
                        } else {
                            clearInterval(countdownInterval);
                            showMessage('ğŸ”„ æ­£åœ¨é‡æ–°æ•´ç†é é¢...', 'info');
                            setTimeout(() => {
                                console.log('[Student] Auto-refreshing page to ensure complete state reset');
                                window.location.reload();
                            }, 500);
                        }
                    }, 1000);
                    
                    return; // Exit the function as the session is over
                } else if (e.record && e.record.active_mode === 'drawing') {
                    // å­¸ç”Ÿç«¯é€²å…¥ç¹ªåœ–é¡Œæ™‚è‡ªå‹•è¼‰å…¥èƒŒæ™¯åœ–ç‰‡
                    const bgFileName = e.record.background_image;
                    if (bgFileName) {
                        // å–å¾— classroom å®Œæ•´è³‡æ–™ï¼ˆå« file æ¬„ä½ï¼‰
                        pb.collection('classrooms').getOne(e.record.id)
                            .then(classroom => {
                                if (classroom.background_image_file) {
                                    const url = pb.files.getURL(classroom, classroom.background_image_file);
                                    teacherUploadedBackgroundImageDataURL = url;
                                    loadBackgroundImage();
                                }
                            })
                            .catch(err => {
                                if (err && (err.isAbort || err.name === 'AbortError')) {
                                    // è¢«è‡ªå‹•å–æ¶ˆçš„è«‹æ±‚ï¼Œå¿½ç•¥å³å¯
                                    console.log('[PocketBase] getOne request was auto-cancelled.');
                                } else {
                                    // å…¶ä»–éŒ¯èª¤æ‰é¡¯ç¤º
                                    console.error('[PocketBase] getOne error:', err);
                                }
                            });
                    }
                    // ä¸å†æ–¼æ­¤æ¸…ç†å­¸ç”Ÿç‹€æ…‹ï¼Œåƒ…æ–¼ classroom è¢«åˆªé™¤æ™‚æ‰æ¸…ç†
                }

                const data = e.record;
                const newMode = data.active_mode || 'waiting';
                const newIsResponsePaused = data.is_paused || false;
                const newBackgroundImage = data.background_image || null;
                const newMultipleChoiceQuestions = data.multiple_choice_questions ? JSON.parse(data.multiple_choice_questions) : null;
                const newDispatchSettings = data.dispatch_settings ? JSON.parse(data.dispatch_settings) : null;

                // Determine if the interaction mode itself has changed
                const modeChanged = (currentInteractionMode !== newMode);
                // Determine if the pause state has changed within the same mode
                const pauseStateChanged = (currentInteractionMode === newMode && isResponsePaused !== newIsResponsePaused);
                // Determine if we are resuming from a pause (mode is same, was paused, now not paused)
                const isResumingFromPause = (currentInteractionMode === newMode) && isResponsePaused && !newIsResponsePaused;

                // Update global states *before* acting on them
                currentInteractionMode = newMode;
                isResponsePaused = newIsResponsePaused;
                teacherUploadedBackgroundImageDataURL = newBackgroundImage; // Update teacher background image
                currentMultipleChoiceQuestions = newMultipleChoiceQuestions; // Update custom MC questions
                currentDispatchSettings = newDispatchSettings; // Update dispatch settings

                console.log(`[Student] Detected mode: ${currentInteractionMode}, Paused: ${isResponsePaused}, Mode Changed: ${modeChanged}`);

                // æª¢æŸ¥æ˜¯å¦åœ¨äº’è©•æ¨¡å¼ï¼Œå¦‚æœæ˜¯å‰‡ä¸åŸ·è¡Œè¦–åœ–åˆ‡æ›
                const isInPeerReviewMode = !views.studentPeerReview.classList.contains('hidden');
                
                if (isInPeerReviewMode) {
                    return; // åœ¨äº’è©•æ¨¡å¼æ™‚ä¸åŸ·è¡Œå¾ŒçºŒçš„è¦–åœ–åˆ‡æ›é‚è¼¯
                }

                if (currentInteractionMode === 'waiting') {
                    showView('studentWaiting');
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay in waiting view
                } else {
                    showView('studentInteraction');

                    // Only call showInteractionUI (which calls resetStudentUIState) if the mode truly changed
                    if (modeChanged) {
                        showInteractionUI(currentInteractionMode, false); // Not resuming from pause if mode changed
                    } else if (isResumingFromPause) {
                        // If only resuming from pause, call showInteractionUI with the flag
                        showInteractionUI(currentInteractionMode, true);
                    }
                    // If mode is the same and it's a pause (not resume), we just need to toggle overlay/elements
                    // showInteractionUI handles initial display, but we don't want to reset canvas on pause.

                    if (isResponsePaused) {
                        studentPauseOverlay.classList.remove('hidden');
                        toggleStudentInteractionElements(true); // Disable elements if paused
                    } else {
                        studentPauseOverlay.classList.add('hidden');
                        toggleStudentInteractionElements(false); // Enable elements if not paused
                    }

                    // Specific UI updates that need to happen on every snapshot change
                    if (currentInteractionMode === 'drawing') {
                        requestAnimationFrame(() => {
                            // BUG FIX: Only call setupCanvas (which resizes and clears the drawing canvas)
                            // when the mode truly changes to 'drawing'.
                            // On other updates (like pause/resume or background image change),
                            // we only need to reload images and redraw the combined canvas,
                            // preserving the student's existing drawing.
                            if (modeChanged) {
                                setupCanvas();
                            }
                            loadBackgroundImage(); // Reload background in case teacher changed it
                            loadStudentImage();    // Reload student-uploaded image
                            drawCombinedCanvas();  // Redraw all layers
                        });
                    } else if (currentInteractionMode === 'url_dispatch') { // This mode now handles both URL and HTML
                        if (currentDispatchSettings) {
                            if (currentDispatchSettings.type === 'url' && currentDispatchSettings.url) {
                                displayDispatchedUrl(currentDispatchSettings);
                            } else if (currentDispatchSettings.type === 'html' && currentDispatchSettings.htmlContent) {
                                displayDispatchedHtml(currentDispatchSettings.htmlContent);
                            }
                        } else {
                            console.log('[Student] URLæ´¾é€æ¨¡å¼å·²å•Ÿå‹•ï¼Œä½†å°šæœªæ”¶åˆ°æ´¾é€è¨­å®š');
                        }
                    } else if (currentInteractionMode === 'multiple_choice') { // NEW: Handle custom multiple choice questions
                        await renderMultipleChoiceQuestions(currentMultipleChoiceQuestions);
                        // Apply/remove enlarged-buttons class based on whether custom questions exist
                        if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                            interactionMultipleChoice.classList.add('enlarged-buttons');
                        } else {
                            interactionMultipleChoice.classList.remove('enlarged-buttons');
                        }
                    }
                }
            }, (error) => {
                console.error("[Student] Error listening to interaction mode:", error);
                // This error might indicate a network issue or permission denied, not necessarily class end.
                // So, keep the student in waiting view or current view, and just show an error.
                showMessage("ç„¡æ³•æ¥æ”¶è€å¸«æŒ‡ä»¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
            });
        }
        
        /**
         * (Student) Displays the dispatched URL or YouTube video.
         * @param {object} settings - The URL settings object from Firestore.
         */
        function displayDispatchedUrl(settings) {
            console.log('[Student] é¡¯ç¤ºæ´¾é€ç¶²å€:', settings); // åŠ å…¥é™¤éŒ¯ä¿¡æ¯
            const container = interactionUIs.url_dispatch;
            container.innerHTML = ''; // Clear previous content

            if (settings.isYoutube) {
                const videoId = getYouTubeVideoId(settings.url);
                console.log('YouTube URL:', settings.url, 'Video ID:', videoId); // èª¿è©¦ä¿¡æ¯
                if (videoId) {
                    const embedContainer = document.createElement('div');
                    embedContainer.className = 'youtube-embed-container';
                    
                    // æ·»åŠ è¼‰å…¥ä¸­çš„æç¤º
                    embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>
                        å½±ç‰‡è¼‰å…¥ä¸­...
                    </div>`;
                    
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;
                    console.log('Embed URL:', embedUrl); // èª¿è©¦ä¿¡æ¯
                    
                    // å‰µå»ºiframeå…ƒç´ 
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.frameBorder = '0';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                    iframe.allowFullscreen = true;
                    iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;';
                    
                    // è¼‰å…¥å®Œæˆå¾Œç§»é™¤è¼‰å…¥æç¤º
                    iframe.onload = function() {
                        const loadingDiv = embedContainer.querySelector('div');
                        if (loadingDiv) loadingDiv.remove();
                    };
                    
                    // éŒ¯èª¤è™•ç†
                    iframe.onerror = function() {
                        embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i><br>
                            å½±ç‰‡è¼‰å…¥å¤±æ•—
                        </div>`;
                    };
                    
                    embedContainer.appendChild(iframe);
                    container.appendChild(embedContainer);
                } else {
                    console.error('ç„¡æ•ˆçš„ YouTube ç¶²å€:', settings.url); // èª¿è©¦ä¿¡æ¯
                    container.innerHTML = `<p class="text-red-500">ç„¡æ•ˆçš„ YouTube ç¶²å€ã€‚</p>`;
                }
            } else {
                const card = document.createElement('a');
                card.className = 'url-card';
                card.href = settings.url;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                
                // ç¢ºä¿ä¸€å®šåœ¨æ–°åˆ†é é–‹å•Ÿï¼ŒåŠ å…¥é»æ“Šäº‹ä»¶è™•ç†
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.open(settings.url, '_blank', 'noopener,noreferrer');
                });
                
                card.innerHTML = `
                    <i class="fas fa-external-link-alt url-card-icon"></i>
                    <p class="url-card-text">è€å¸«åˆ†äº«äº†ä¸€å€‹é€£çµ</p>
                    <p class="url-card-link">${settings.url}</p>
                    <small class="text-gray-500 mt-2">ğŸ”— é»æ“Šåœ¨æ–°åˆ†é é–‹å•Ÿ</small>
                `;
                container.appendChild(card);
            }
        }

        /**
         * NEW: (Student) Displays the dispatched HTML content in an iframe.
         * @param {string} htmlContent - The HTML content to display.
         */
        function displayDispatchedHtml(htmlContent) {
            const container = interactionUIs.url_dispatch; // Use the same container
            container.innerHTML = ''; // Clear previous content
            
            const iframe = document.createElement('iframe');
            iframe.id = 'html-content-iframe'; // Re-use the ID for consistency if needed, but it's internal to this function now
            iframe.sandbox = 'allow-scripts allow-same-origin allow-popups allow-forms';
            iframe.srcdoc = htmlContent;
            iframe.style.cssText = 'width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; background-color: white; display: block;';
            container.appendChild(iframe);

            // Add status indicator
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'html-dispatch-indicator';
            statusIndicator.textContent = 'æ•™å¸«æ´¾é€htmlä¸­...';
            container.appendChild(statusIndicator);

            // Apply the specific HTML dispatch container styles to the outer container
            container.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; overflow: hidden; background-color: white; z-index: 1000;';
        }

        /**
         * Extracts YouTube video ID from various URL formats.
         * @param {string} url - The YouTube URL.
         * @returns {string|null} The video ID or null if not found.
         */
        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }


        /**
         * (Student) Submits the answer to PocketBase.
         * @param {string | object} answer - The student's answer.
         */
        async function submitAnswer(answer) {
            // NEW: Prevent submission if paused
            if (isResponsePaused) {
                showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                return;
            }

            if (!studentName || !userId || !classroomCode) {
                console.error("Student name, User ID, or Classroom Code not set. Cannot submit answer.");
                showMessage("å­¸ç”Ÿå§“åã€ç”¨æˆ¶IDæˆ–æ•™å®¤ä»£ç¢¼æœªè¨­å®šï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚", "error");
                return;
            }
            
            // å¦‚æœæ˜¯åœ–ç‰‡ç­”æ¡ˆï¼ˆbase64ï¼‰ï¼Œæª¢æŸ¥ä¸¦å£“ç¸®å¤§å°
            let processedAnswer = answer;
            if (typeof answer === 'string' && answer.startsWith('data:image/')) {
                console.log(`[Student] Original image size: ${answer.length} characters`);
                // æé«˜æœ€å¤§å…è¨±é•·åº¦ï¼Œç•«è³ªå„ªå…ˆ
                if (answer.length > 12000) {
                    console.log('[Student] Image too large, applying additional compression...');
                    try {
                        processedAnswer = await compressImageDataURL(answer, 12000); // ç›®æ¨™12000å­—å…ƒä»¥ä¸‹
                        console.log(`[Student] Compressed image size: ${processedAnswer.length} characters`);
                    } catch (compressionError) {
                        console.warn('[Student] Image compression failed, using original:', compressionError);
                        // å¦‚æœå£“ç¸®å¤±æ•—ï¼Œä»ç„¶å˜—è©¦æäº¤åŸåœ–ç‰‡
                    }
                }
            }
            
            try {
                await StudentResponseAPI.upsert(classroomCode, studentName, processedAnswer);
                console.log(`[Student] ${studentName} submitted answer`);
                showMessage('å›ç­”å·²é€å‡ºï¼', 'success');
                
                // æ›´æ–°æ•™å®¤æ´»å‹•æ™‚é–“
                if (classroomRecordId) {
                    await ClassroomAPI.updateActivity(classroomRecordId);
                }
            } catch (error) {
                console.error("é€å‡ºç­”æ¡ˆå¤±æ•—:", error);
                showMessage("é€å‡ºç­”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
                throw error; // é‡æ–°æ‹‹å‡ºéŒ¯èª¤è®“èª¿ç”¨è€…è™•ç†
            }
        }
        
        /**
         * å£“ç¸®åœ–ç‰‡ Data URL åˆ°æŒ‡å®šå¤§å°ä»¥ä¸‹
         */
        async function compressImageDataURL(dataURL, maxSize) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // æå‡æœ€å¤§å°ºå¯¸é™åˆ¶
                    let { width, height } = img;
                    const maxDimension = 1280; // æé«˜æœ€å¤§å°ºå¯¸
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = height * (maxDimension / width);
                            width = maxDimension;
                        } else {
                            width = width * (maxDimension / height);
                            height = maxDimension;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    // æé«˜é è¨­å£“ç¸®å“è³ª
                    let quality = 0.8;
                    let compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                    // å¦‚æœä»ç„¶å¤ªå¤§ï¼Œé€æ­¥é™ä½å“è³ª
                    while (compressedDataURL.length > maxSize && quality > 0.2) {
                        quality -= 0.05;
                        compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                    }
                    resolve(compressedDataURL);
                };
                img.src = dataURL;
            });
        }
        
        // é˜²æŠ–æ©Ÿåˆ¶è®Šæ•¸
        let responseUpdateTimeout = null;

        /**
         * (Teacher) Listens for all student submissions and dynamically displays them.
         * @param {string} mode - The current interaction mode, used to determine the answer type.
         */
        function listenToStudentSubmissions(mode) {
             if (studentResponsesUnsubscribe && typeof studentResponsesUnsubscribe === 'function') {
                 studentResponsesUnsubscribe();
             }
             
             const container = document.getElementById('student-responses-container');

             // é˜²æŠ–æ›´æ–°å‡½æ•¸
             const updateResponses = async () => {
                try {
                    console.log('[Teacher] Updating student responses...');
                    const responses = await StudentResponseAPI.getByClassroom(classroomCode);
                    
                    container.innerHTML = ''; 
                    lastSelectedStudentCard = null; 

                    if (responses.length === 0) {
                        if (mode !== 'url_dispatch') { 
                            container.innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                        }
                        allStudentResponses = [];
                        clearStudentsByAnswerList();
                        
                        // Update unsubmitted students button when no responses
                        updateUnsubmittedStudentsButtonVisibility(mode);
                        return;
                    }
                    
                    responses.forEach((student) => {
                        const card = document.createElement('div');
                        card.className = 'student-response-item'; 

                        let answerContentHTML = ''; 
                        let parsedAnswer = student.answer;
                        
                        // Try to parse JSON answer if it looks like JSON
                        try {
                            if (typeof student.answer === 'string' && (student.answer.startsWith('[') || student.answer.startsWith('{'))) {
                                parsedAnswer = JSON.parse(student.answer);
                            }
                        } catch (e) {
                            // Keep as string if not valid JSON
                        }
                        
                        if (parsedAnswer === undefined || parsedAnswer === null) {
                            answerContentHTML = `<p class="text-gray-400">å°šæœªä½œç­”</p>`;
                        } else if (mode === 'drawing') {
                            if(String(parsedAnswer).startsWith('data:image')){
                                answerContentHTML = `<img src="${parsedAnswer}" alt="${student.student_name} çš„ç¹ªåœ–" class="w-full h-auto rounded-md border max-h-32 object-contain cursor-pointer magnifiable-image" data-full-image="${parsedAnswer}"/>`;
                            } else {
                                answerContentHTML = `<p class="text-gray-500">ç¹ªåœ–æœªå®Œæˆæˆ–æ ¼å¼éŒ¯èª¤</p>`;
                            }
                        } else if (mode === 'recording') {
                            if (String(parsedAnswer).startsWith('data:audio')) {
                                answerContentHTML = `<audio controls src="${parsedAnswer}" class="w-full"></audio>`;
                            } else {
                                answerContentHTML = `<p class="text-gray-500">éŒ„éŸ³æœªå®Œæˆæˆ–æ ¼å¼éŒ¯èª¤</p>`;
                            }
                        } else if (mode === 'text_input') {
                            answerContentHTML = `<p class="text-gray-700 whitespace-pre-wrap cursor-pointer magnifiable-text" title="é»æ“Šæ”¾å¤§">${parsedAnswer || '(ç©ºç™½)'}</p>`;
                        } else if (mode === 'multiple_choice' && Array.isArray(parsedAnswer) && currentMultipleChoiceQuestions) {
                            answerContentHTML = `<div class="flex flex-col w-full">`;
                            parsedAnswer.forEach((qAns, index) => {
                                const question = currentMultipleChoiceQuestions[qAns.qIndex];
                                if (question) {
                                    const isCorrect = (String(qAns.ans) === String(question.correctAnswer));
                                    answerContentHTML += `
                                        <div class="mc-question-answer">
                                            <i class="icon fas ${isCorrect ? 'fa-check-circle correct-icon' : 'fa-times-circle incorrect-icon'}"></i>
                                            <span class="question-text">Q${qAns.qIndex + 1}:</span>
                                            <span class="student-choice">${qAns.ans}</span>
                                        </div>
                                    `;
                                }
                            });
                            answerContentHTML += `</div>`;
                        }
                        else if (mode === 'quick_answer') {
                            if (parsedAnswer && parsedAnswer.includes('æ¶ç­”æˆåŠŸ')) {
                                answerContentHTML = `<div class="text-center">
                                    <i class="fas fa-trophy text-yellow-500 text-4xl mb-2"></i>
                                    <p class="text-xl font-bold text-green-600">æ¶ç­”æˆåŠŸï¼</p>
                                    <p class="text-lg text-gray-600">ç¬¬ä¸€å</p>
                                </div>`;
                            } else {
                                answerContentHTML = `<p class="text-gray-500">æœªæ¶ç­”æˆ–æ¶ç­”å¤±æ•—</p>`;
                            }
                        }
                        else {
                            answerContentHTML = `<p class="text-2xl font-bold text-blue-600">${parsedAnswer}</p>`;
                        }
                        
                        card.innerHTML = `
                            <div class="name-box">${student.student_name}</div>
                            <div class="answer-box">
                                ${answerContentHTML}
                            </div>
                        `;
                        container.appendChild(card);

                        if (mode === 'drawing') {
                            const imgElement = card.querySelector('.answer-box .magnifiable-image');
                            if (imgElement) {
                                imgElement.addEventListener('click', (e) => {
                                    const fullImageUrl = e.target.dataset.fullImage;
                                    showMagnifyModal({type: 'image', content: fullImageUrl, alt: imgElement.alt});
                                });
                            }
                        }
                        if (mode === 'text_input') {
                            const textElement = card.querySelector('.answer-box .magnifiable-text');
                            if (textElement) {
                                textElement.addEventListener('click', (e) => {
                                    showMagnifyModal({type: 'text', content: textElement.textContent});
                                });
                            }
                        }
                    });

                    // Convert PocketBase format to expected format
                    allStudentResponses = responses.map(r => ({
                        name: r.student_name,
                        answer: r.answer
                    }));

                    // Special handling for quick answer mode
                    if (mode === 'quick_answer') {
                        console.log('Teacher: Processing quick answer responses:', allStudentResponses);
                        const quickAnswerWinners = allStudentResponses.filter(student =>
                            student.answer && student.answer.includes('æ¶ç­”æˆåŠŸ')
                        );
                        console.log('Teacher: Quick answer winners found:', quickAnswerWinners);

                        if (quickAnswerWinners.length > 0) {
                            const winner = quickAnswerWinners[0];
                            console.log('Teacher: Showing winner:', winner.name);
                            showQuickAnswerWinner(winner.name);
                        }
                    }

                    // Update unsubmitted students button visibility
                    updateUnsubmittedStudentsButtonVisibility(mode);

                    if (!statisticsModal.classList.contains('hidden')) {
                        drawChart(allStudentResponses, currentInteractionMode);
                    }
                } catch (error) {
                    console.error("[Teacher] Error processing student submissions:", error);
                }
             };

             // è¨­ç½®ç›£è½å™¨ï¼Œä½¿ç”¨é˜²æŠ–æ©Ÿåˆ¶
             studentResponsesUnsubscribe = StudentResponseAPI.subscribe(classroomCode, async (e) => {
                // æ¸…é™¤ä¹‹å‰çš„å»¶é²æ›´æ–°
                if (responseUpdateTimeout) {
                    clearTimeout(responseUpdateTimeout);
                }
                
                // å»¶é² 300ms å¾Œæ›´æ–°ï¼Œé¿å…éæ–¼é »ç¹çš„è«‹æ±‚
                responseUpdateTimeout = setTimeout(() => {
                    updateResponses();
                }, 300);
             });

             // ç«‹å³åŸ·è¡Œä¸€æ¬¡æ›´æ–°

            updateResponses();

            // å¼·åŒ–ï¼šå…¨åŸŸç›£è½æ‰€æœ‰æ–‡å­—é¡Œæ”¾å¤§
            document.addEventListener('click', function(e) {
                const target = e.target;
                if (target.classList && target.classList.contains('magnifiable-text')) {
                    showMagnifyModal({type: 'text', content: target.textContent});
                }
            });

            // --- æ”¾å¤§å½ˆçª—åŠŸèƒ½ ---
            function showMagnifyModal({type, content, alt}) {
                // ç§»é™¤èˆŠçš„
                const old = document.getElementById('magnify-modal-overlay');
                if (old) old.remove();
                // å»ºç«‹é®ç½©
                const overlay = document.createElement('div');
                overlay.id = 'magnify-modal-overlay';
                overlay.style.cssText = `position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;cursor:pointer;`;
                overlay.addEventListener('click',()=>overlay.remove());
                // å…§å®¹
                let inner = '';
                if(type==='image'){
                    inner = `<img src="${content}" alt="${alt||''}" style="max-width:90vw;max-height:80vh;border-radius:1rem;box-shadow:0 4px 32px #0008;">`;
                }else if(type==='text'){
                    inner = `<div style="background:white;padding:2.5rem 2rem;max-width:90vw;max-height:80vh;overflow:auto;border-radius:1rem;box-shadow:0 4px 32px #0008;font-size:2.2rem;line-height:1.6;white-space:pre-wrap;word-break:break-all;">${content}</div>`;
                }
                overlay.innerHTML = inner;
                document.body.appendChild(overlay);
            }
        }

        /**
         * (Teacher) Listens for student online presence and updates the active student count list.
         * This listener should be persistent as long as the teacher is in the classroom.
         */
        async function listenToClassroomPresence() {
            // Always unsubscribe existing listener first to ensure we listen to the correct classroom
            if (classroomPresenceUnsubscribe && typeof classroomPresenceUnsubscribe === 'function') {
                console.log("Unsubscribing existing presence listener for new classroom setup.");
                classroomPresenceUnsubscribe();
                classroomPresenceUnsubscribe = null;
            }

            if (!classroomCode) {
                console.warn("Classroom code not set, cannot listen to presence.");
                return;
            }

            console.log(`[Teacher] Setting up presence listener for classroom: ${classroomCode}`);

            const activeStudentCountSpan = document.getElementById('active-student-count');
            const modalStudentNamesDiv = document.getElementById('modal-student-names');
            const monitorContainer = document.getElementById('student-responses-container');

            // Initial load of presence data with retry mechanism
            let retryCount = 0;
            const maxRetries = 3;
            
            const loadInitialPresence = async () => {
                try {
                    console.log(`[Teacher] Loading initial presence data (attempt ${retryCount + 1}/${maxRetries})...`);
                    const presenceRecords = await StudentPresenceAPI.getByClassroom(classroomCode);
                    activeStudentNames = presenceRecords.map(record => record.student_name);
                    activeStudentCountSpan.textContent = activeStudentNames.length;
                    console.log(`[Teacher] Initial presence load: found ${activeStudentNames.length} students`, activeStudentNames);
                    
                    // Update the student list modal.
                    modalStudentNamesDiv.innerHTML = ''; 
                    if (activeStudentNames.length === 0) {
                        modalStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>';
                    } else {
                        activeStudentNames.sort().forEach(name => {
                            const p = document.createElement('p');
                            p.textContent = name;
                            modalStudentNamesDiv.appendChild(p);
                        });
                    }
                    
                    // Update unsubmitted students button visibility when presence changes
                    if (currentInteractionMode) {
                        updateUnsubmittedStudentsButtonVisibility(currentInteractionMode);
                    }
                    
                    // è¨­å®šå®šæœŸåˆ·æ–°æ©Ÿåˆ¶ï¼ˆæ¯10ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰
                    if (window.presenceRefreshInterval) {
                        clearInterval(window.presenceRefreshInterval);
                    }
                    window.presenceRefreshInterval = setInterval(async () => {
                        try {
                            const currentRecords = await StudentPresenceAPI.getByClassroom(classroomCode);
                            const currentNames = currentRecords.map(record => record.student_name);
                            if (JSON.stringify(currentNames.sort()) !== JSON.stringify(activeStudentNames.sort())) {
                                console.log(`[Teacher] Periodic refresh detected changes: ${currentNames.length} students`);
                                activeStudentNames = currentNames;
                                activeStudentCountSpan.textContent = activeStudentNames.length;
                                
                                modalStudentNamesDiv.innerHTML = '';
                                if (activeStudentNames.length === 0) {
                                    modalStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>';
                                } else {
                                    activeStudentNames.sort().forEach(name => {
                                        const p = document.createElement('p');
                                        p.textContent = name;
                                        modalStudentNamesDiv.appendChild(p);
                                    });
                                }
                                
                                // Update unsubmitted students button visibility when presence changes
                                if (currentInteractionMode) {
                                    updateUnsubmittedStudentsButtonVisibility(currentInteractionMode);
                                }
                            }
                        } catch (refreshError) {
                            console.warn("[Teacher] Periodic refresh failed:", refreshError);
                        }
                    }, 10000); // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
                    
                } catch (error) {
                    console.error("[Teacher] Error loading initial presence data:", error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.log(`[Teacher] Retrying in 2 seconds... (${retryCount}/${maxRetries})`);
                        setTimeout(loadInitialPresence, 2000);
                    } else {
                        console.error("[Teacher] Failed to load initial presence data after all retries");
                    }
                }
            };
            
            await loadInitialPresence();

            classroomPresenceUnsubscribe = StudentPresenceAPI.subscribe(classroomCode, async (e) => {
                // é˜²æŠ–æ©Ÿåˆ¶ï¼šæ¸…é™¤ä¹‹å‰çš„å®šæ™‚å™¨
                if (presenceUpdateDebounceTimer) {
                    clearTimeout(presenceUpdateDebounceTimer);
                }
                
                // å¦‚æœæ­£åœ¨æ›´æ–°ä¸­ï¼Œå‰‡è·³éæ­¤æ¬¡æ›´æ–°
                if (isUpdatingPresence) {
                    console.log(`[Teacher] Skipping presence update - already in progress`);
                    return;
                }
                
                // è¨­å®šé˜²æŠ–å®šæ™‚å™¨
                presenceUpdateDebounceTimer = setTimeout(async () => {
                    isUpdatingPresence = true;
                    try {
                        console.log(`[Teacher] Presence event received:`, e.action, e.record);
                        
                        // åŠ å…¥çŸ­æš«å»¶é²ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§
                        await new Promise(resolve => setTimeout(resolve, 150));
                        
                        // Reload all presence data to ensure consistency
                        const presenceRecords = await StudentPresenceAPI.getByClassroom(classroomCode);
                        
                        activeStudentNames = presenceRecords.map(record => record.student_name);
                        activeStudentCountSpan.textContent = activeStudentNames.length;
                        
                        console.log(`[Teacher] Updated student count: ${activeStudentNames.length} students`, activeStudentNames);

                        // Update the student list modal.
                        modalStudentNamesDiv.innerHTML = ''; 
                        if (lastSelectedModalStudent) { // Clear highlight in modal when list rebuilds
                            lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                            lastSelectedModalStudent = null;
                        }

                        if (activeStudentNames.length === 0) {
                            modalStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>';
                        } else {
                            activeStudentNames.sort().forEach(name => {
                                const p = document.createElement('p');
                                p.textContent = name;
                                modalStudentNamesDiv.appendChild(p);
                            });
                        }

                        // Update unsubmitted students button visibility when presence changes
                        if (currentInteractionMode) {
                            updateUnsubmittedStudentsButtonVisibility(currentInteractionMode);
                        }

                        // Dynamically update the monitor view if in URL/HTML dispatch mode
                        if (currentInteractionMode === 'url_dispatch') { 
                            monitorContainer.innerHTML = ''; // Clear previous content
                            if (activeStudentNames.length === 0) {
                                monitorContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">æ²’æœ‰å­¸ç”Ÿåœ¨ç·š</p>';
                            } else {
                                activeStudentNames.sort().forEach(name => {
                                    const card = document.createElement('div');
                                    card.className = 'student-response-item';
                                    card.innerHTML = `<div class="name-box">${name}</div><div class="answer-box"><i class="fas fa-check-circle text-green-500 text-2xl"></i></div>`;
                                    monitorContainer.appendChild(card);
                                });
                            }
                        }
                    } catch (error) {
                        // å¦‚æœæ˜¯è‡ªå‹•å–æ¶ˆéŒ¯èª¤ï¼Œä¸è¨˜éŒ„éŒ¯èª¤ï¼Œåªè¨˜éŒ„è­¦å‘Š
                        if (error.message && error.message.includes('autocancelled')) {
                            console.warn("[Teacher] Presence update request was autocancelled, will retry later");
                        } else {
                            console.error("[Teacher] Error processing classroom presence:", error);
                        }
                    } finally {
                        isUpdatingPresence = false;
                    }
                }, 300); // 300ms é˜²æŠ–å»¶é²
            });
        }

        /**
         * (Teacher) Manually refreshes the online student count and responded student count.
         */
        async function manualRefreshCounts() {
            if (!classroomCode) {
                console.warn("Classroom code not set, cannot manually refresh counts.");
                return;
            }
            
            try {
                // ç²å–åœ¨ç·šå­¸ç”Ÿæ•¸é‡ (å·²é·ç§»åˆ° PocketBase)
                const presenceRecords = await StudentPresenceAPI.getByClassroom(classroomCode);
                activeStudentNames = presenceRecords.map(record => record.student_name);
                document.getElementById('active-student-count').textContent = activeStudentNames.length;
            } catch (error) {
                console.error("Manual refresh: Failed to get online student count:", error);
            }

            // ç²å–å­¸ç”Ÿå›æ‡‰æ•¸é‡ (é·ç§»åˆ° PocketBase)
            try {
                const responsesRecords = await StudentResponseAPI.getByClassroom(classroomCode);
                // REMOVED: document.getElementById('responded-student-count').textContent = responsesSnapshot.size;
                
                // å°‡ PocketBase è¨˜éŒ„è½‰æ›ç‚ºåŸæœ¬çš„æ ¼å¼
                const responsesData = responsesRecords.map(record => ({
                    studentName: record.student_name,
                    answer: record.answer,
                    timestamp: record.timestamp,
                    isNominated: record.is_nominated || false
                }));
                allStudentResponses = responsesData; 

                if (!statisticsModal.classList.contains('hidden')) {
                    drawChart(allStudentResponses, currentInteractionMode);
                }
                showMessage('çµ±è¨ˆæ•¸æ“šå·²æ›´æ–°ï¼', 'info');
            } catch (error) {
                console.error("Manual refresh: Failed to get responded student count:", error);
            }
        }


        // --- Magnified Drawing Modal Functions ---
        const magnifiedImageModal = document.getElementById('magnified-image-modal');
        const magnifiedImage = document.getElementById('magnified-image');
        const magnifiedImageModalCloseBtn = document.getElementById('magnified-image-modal-close-btn');

        function showMagnifiedDrawing(imageUrl) {
            magnifiedImage.src = imageUrl;
            magnifiedImageModal.classList.remove('hidden');
        }

        function hideMagnifiedDrawing() {
            magnifiedImageModal.classList.add('hidden');
            magnifiedImage.src = ''; 
        }

        // --- Student List Modal (Teacher Side) ---
        const studentListModal = document.getElementById('student-list-modal');
        const studentListModalCloseBtn = document.getElementById('student-list-modal-close-btn');

        function showStudentListModal() {
            studentListModal.classList.remove('hidden');
        }

        function hideStudentListModal() {
            studentListModal.classList.add('hidden');
            if (lastSelectedModalStudent) { // Clear highlight in modal when closing
                lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                lastSelectedModalStudent = null;
            }
        }

        // --- NEW: Unsubmitted Students Modal Functions ---
        const unsubmittedStudentsModal = document.getElementById('unsubmitted-students-modal');
        const unsubmittedStudentsModalCloseBtn = document.getElementById('unsubmitted-students-modal-close-btn');
        const modalUnsubmittedStudentNamesDiv = document.getElementById('modal-unsubmitted-student-names');

        /**
         * Calculates the list of students who are active but have not submitted an answer.
         * @param {string[]} activeStudents - Array of names of all active students.
         * @param {Object[]} respondedStudents - Array of response objects from students.
         * @returns {string[]} Sorted array of names of unsubmitted students.
         */
        function getUnsubmittedStudents(activeStudents, respondedStudents) {
            // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„å±¬æ€§å 'name' è€Œä¸æ˜¯ 'studentName'
            const respondedNames = new Set(respondedStudents.map(s => s.name || s.studentName));
            return activeStudents.filter(name => !respondedNames.has(name)).sort();
        }

        /**
         * Updates the visibility of the unsubmitted students button based on current mode and student responses.
         * @param {string} mode - The current interaction mode.
         */
        function updateUnsubmittedStudentsButtonVisibility(mode) {
            const showUnsubmittedBtn = document.getElementById('show-unsubmitted-students-btn');
            if (!showUnsubmittedBtn) return;

            // Always hide for certain modes regardless of student status
            if (mode === 'waiting' || mode === 'url_dispatch' || mode === 'quick_answer') {
                showUnsubmittedBtn.classList.add('hidden');
                return;
            }

            // For other modes, show only if there are unsubmitted students
            const unsubmittedStudents = getUnsubmittedStudents(activeStudentNames, allStudentResponses);
            const hasUnsubmittedStudents = unsubmittedStudents.length > 0;
            
            showUnsubmittedBtn.classList.toggle('hidden', !hasUnsubmittedStudents);
        }

        /**
         * Displays the modal with the list of unsubmitted students.
         */
        function showUnsubmittedStudentsModal() {
            console.log('[Teacher] é¡¯ç¤ºæœªä½œç­”å­¸ç”Ÿåˆ—è¡¨');
            console.log('[Teacher] åœ¨ç·šå­¸ç”Ÿ:', activeStudentNames);
            console.log('[Teacher] å·²å›æ‡‰å­¸ç”Ÿ:', allStudentResponses);
            
            const unsubmittedNames = getUnsubmittedStudents(activeStudentNames, allStudentResponses);
            console.log('[Teacher] æœªä½œç­”å­¸ç”Ÿ:', unsubmittedNames);
            
            modalUnsubmittedStudentNamesDiv.innerHTML = '';
            if (unsubmittedNames.length === 0) {
                modalUnsubmittedStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">æ‰€æœ‰å­¸ç”Ÿçš†å·²ä½œç­”æˆ–ç„¡å­¸ç”Ÿåœ¨ç·š</p>';
            } else {
                unsubmittedNames.forEach(name => {
                    const p = document.createElement('p');
                    p.textContent = name;
                    p.className = 'bg-red-100 p-2 rounded-md text-center text-red-700 font-medium overflow-hidden text-ellipsis whitespace-nowrap';
                    modalUnsubmittedStudentNamesDiv.appendChild(p);
                });
            }
            unsubmittedStudentsModal.classList.remove('hidden');
        }

        /**
         * Hides the unsubmitted students modal.
         */
        function hideUnsubmittedStudentsModal() {
            unsubmittedStudentsModal.classList.add('hidden');
        }


        // --- Statistics Chart Modal (Teacher Side) ---
        const statisticsModal = document.getElementById('statistics-modal');
        const chartModalCloseBtn = document.getElementById('chart-modal-close-btn');
        const chartSvg = d3.select("#chart-svg");
        const studentsByAnswerListContainer = document.getElementById('students-by-answer-list-container');
        const studentsByAnswerListTitle = document.getElementById('students-by-answer-list-title');
        const studentsByAnswerNamesParagraph = document.getElementById('students-by-answer-names');


        function showStatisticsModal() {
            statisticsModal.classList.remove('hidden');
            drawChart(allStudentResponses, currentInteractionMode); 
        }

        function hideStatisticsModal() {
            statisticsModal.classList.add('hidden');
            chartSvg.selectAll("*").remove();
            clearStudentsByAnswerList();
        }

        function downloadStudentResponses() {
            if (!allStudentResponses || allStudentResponses.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿå›æ‡‰å¯ä»¥ä¸‹è¼‰ã€‚', 'warning');
                return;
            }

            let csvData = [];
            let filename = '';
            
            if (currentInteractionMode === 'text_input') {
                // æ–‡å­—é¡Œæ¨¡å¼
                csvData.push('å­¸ç”Ÿå§“å,å­¸ç”Ÿå›æ‡‰');
                
                allStudentResponses.forEach(student => {
                    const studentName = student.name || 'æœªçŸ¥å­¸ç”Ÿ';
                    let responseText = student.answer || '';
                    
                    // æ¸…ç†å›æ‡‰æ–‡å­—ä¸­çš„æ›è¡Œç¬¦è™Ÿå’Œé›™å¼•è™Ÿï¼Œé¿å…å½±éŸ¿CSVæ ¼å¼
                    responseText = responseText.replace(/[\r\n]/g, ' ').replace(/"/g, '""');
                    
                    // å¦‚æœå…§å®¹åŒ…å«é€—è™Ÿæˆ–é›™å¼•è™Ÿï¼Œéœ€è¦ç”¨é›™å¼•è™ŸåŒ…åœ
                    if (responseText.includes(',') || responseText.includes('"') || responseText.includes('\n')) {
                        responseText = `"${responseText}"`;
                    }
                    
                    csvData.push(`${studentName},${responseText}`);
                });
                
                const now = new Date();
                const timestamp = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                filename = `å­¸ç”Ÿå›æ‡‰_${timestamp}.csv`;
                
            } else if (currentInteractionMode === 'multiple_choice' && currentMultipleChoiceQuestions) {
                // è‡ªè¨‚é¸æ“‡é¡Œæ¨¡å¼
                
                // ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡Œç›®è³‡è¨Š
                csvData.push('=== é¡Œç›®è³‡è¨Š ===');
                csvData.push('é¡Œè™Ÿ,é¡Œç›®å…§å®¹,é¸é …A,é¸é …B,é¸é …C,é¸é …D,æ­£ç¢ºç­”æ¡ˆ');
                
                currentMultipleChoiceQuestions.forEach((question, index) => {
                    const questionText = `"${question.questionText.replace(/"/g, '""')}"`;
                    const optionA = `"${question.options[0].replace(/"/g, '""')}"`;
                    const optionB = `"${question.options[1].replace(/"/g, '""')}"`;
                    const optionC = `"${question.options[2].replace(/"/g, '""')}"`;
                    const optionD = `"${question.options[3].replace(/"/g, '""')}"`;
                    const correctAnswer = `é¸é …${['A', 'B', 'C', 'D'][parseInt(question.correctAnswer) - 1]}`;
                    
                    csvData.push(`ç¬¬${index + 1}é¡Œ,${questionText},${optionA},${optionB},${optionC},${optionD},${correctAnswer}`);
                });
                
                // ç©ºè¡Œåˆ†éš”
                csvData.push('');
                
                // ç¬¬äºŒéƒ¨åˆ†ï¼šå­¸ç”Ÿç­”é¡Œçµæœ
                csvData.push('=== å­¸ç”Ÿç­”é¡Œçµæœ ===');
                
                // å»ºç«‹è¡¨é ­
                let header = 'å­¸ç”Ÿå§“å';
                currentMultipleChoiceQuestions.forEach((_, index) => {
                    header += `,ç¬¬${index + 1}é¡Œç­”æ¡ˆ,ç¬¬${index + 1}é¡Œçµæœ`;
                });
                header += ',ç¸½åˆ†,ç¸½é¡Œæ•¸,æ­£ç¢ºç‡';
                csvData.push(header);
                
                // å»ºç«‹æ¯å€‹å­¸ç”Ÿçš„ç­”é¡Œçµæœ
                allStudentResponses.forEach(student => {
                    const studentName = student.name || 'æœªçŸ¥å­¸ç”Ÿ';
                    let row = studentName;
                    let correctCount = 0;
                    let totalQuestions = currentMultipleChoiceQuestions.length;
                    
                    if (Array.isArray(student.answer)) {
                        // ç‚ºæ¯é¡ŒåŠ å…¥ç­”æ¡ˆå’Œçµæœ
                        currentMultipleChoiceQuestions.forEach((question, questionIndex) => {
                            const studentAnswer = student.answer.find(ans => ans.qIndex === questionIndex);
                            if (studentAnswer) {
                                const answerText = `é¸é …${['A', 'B', 'C', 'D'][parseInt(studentAnswer.ans) - 1]}`;
                                const isCorrect = String(studentAnswer.ans) === String(question.correctAnswer);
                                const result = isCorrect ? 'æ­£ç¢º' : 'éŒ¯èª¤';
                                if (isCorrect) correctCount++;
                                row += `,${answerText},${result}`;
                            } else {
                                row += ',æœªä½œç­”,éŒ¯èª¤';
                            }
                        });
                    } else {
                        // å¦‚æœå­¸ç”Ÿæ²’æœ‰å›ç­”æˆ–æ ¼å¼ä¸æ­£ç¢º
                        currentMultipleChoiceQuestions.forEach(() => {
                            row += ',æœªä½œç­”,éŒ¯èª¤';
                        });
                    }
                    
                    // åŠ å…¥çµ±è¨ˆè³‡è¨Š
                    const accuracy = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : '0.0';
                    row += `,${correctCount},${totalQuestions},${accuracy}%`;
                    
                    csvData.push(row);
                });
                
                const now = new Date();
                const timestamp = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                filename = `é¸æ“‡é¡Œçµæœ_${timestamp}.csv`;
            } else {
                showMessage('ç›®å‰æ¨¡å¼ä¸æ”¯æ´ä¸‹è¼‰åŠŸèƒ½ã€‚', 'warning');
                return;
            }

            // å»ºç«‹CSVå…§å®¹
            const csvContent = csvData.join('\n');

            // å»ºç«‹ä¸‹è¼‰é€£çµï¼ŒåŠ ä¸ŠBOMç¢ºä¿æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage(`å·²ä¸‹è¼‰å­¸ç”Ÿå›æ‡‰æª”æ¡ˆ: ${filename}`, 'success');
        }

        // NEW: View Questions Modal Functions
        function showViewQuestionsModal() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰è‡ªè¨‚é¡Œç›®å¯ä»¥æŸ¥çœ‹ã€‚', 'info');
                return;
            }
            
            const modal = document.getElementById('view-questions-modal');
            const container = document.getElementById('questions-display-container');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // ç”Ÿæˆé¡Œç›®é¡¯ç¤ºHTML
            currentMultipleChoiceQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-4 rounded-lg border';
                questionDiv.innerHTML = `
                    <h5 class="font-bold text-lg mb-3">ç¬¬ ${index + 1} é¡Œ</h5>
                    <p class="text-gray-800 mb-4">${question.questionText}</p>
                    <div class="space-y-2">
                        <p class="font-medium text-gray-700">é¸é …ï¼š</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${question.options.map((option, optIndex) => 
                                `<div class="p-2 bg-white rounded border text-sm">
                                    ${String.fromCharCode(65 + optIndex)}. ${option}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ­£ç¢ºç­”æ¡ˆï¼š</label>
                        <select class="correct-answer-select w-full p-2 border rounded" data-question-index="${index}">
                            ${question.options.map((option, optIndex) => {
                                const optionValue = String.fromCharCode(65 + optIndex);
                                const isSelected = question.correctAnswer === optionValue || question.correctAnswer === (optIndex + 1).toString();
                                return `<option value="${optionValue}" ${isSelected ? 'selected' : ''}>${optionValue}. ${option}</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            modal.classList.remove('hidden');
        }

        function hideViewQuestionsModal() {
            document.getElementById('view-questions-modal').classList.add('hidden');
        }

        async function saveCorrectAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('æ²’æœ‰é¡Œç›®å¯ä»¥å„²å­˜ã€‚', 'error');
                return;
            }
            
            try {
                // æ›´æ–°currentMultipleChoiceQuestionsä¸­çš„æ­£ç¢ºç­”æ¡ˆ
                const selects = document.querySelectorAll('.correct-answer-select');
                selects.forEach(select => {
                    const questionIndex = parseInt(select.getAttribute('data-question-index'));
                    let newCorrectAnswer = select.value;
                    
                    // NEW: å°‡å­—æ¯æ ¼å¼è½‰æ›ç‚ºæ•¸å­—æ ¼å¼ä»¥ä¿æŒä¸€è‡´æ€§
                    if (newCorrectAnswer === 'A') newCorrectAnswer = '1';
                    else if (newCorrectAnswer === 'B') newCorrectAnswer = '2';
                    else if (newCorrectAnswer === 'C') newCorrectAnswer = '3';
                    else if (newCorrectAnswer === 'D') newCorrectAnswer = '4';
                    
                    if (currentMultipleChoiceQuestions[questionIndex]) {
                        currentMultipleChoiceQuestions[questionIndex].correctAnswer = newCorrectAnswer;
                    }
                });
                
                // æ›´æ–°Firestoreä¸­çš„é¡Œç›®è³‡æ–™
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                await updateDoc(controlRef, {
                    multiple_choice_questions: currentMultipleChoiceQuestions
                });
                
                // NEW: ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿Firestoreæ›´æ–°å®Œæˆï¼Œç„¶å¾Œè§¸ç™¼é‡æ–°æ‰¹æ”¹
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // NEW: è‡ªå‹•é‡æ–°æ‰¹æ”¹æ‰€æœ‰å­¸ç”Ÿå·²æäº¤çš„ç­”æ¡ˆ
                await regradeAllStudentAnswers();
                
                // NEW: ç¢ºä¿æ•™å¸«ç«¯UIä½¿ç”¨æœ€æ–°çš„æ­£ç¢ºç­”æ¡ˆé€²è¡Œæ¸²æŸ“
                // ç”±æ–¼é‡æ–°æ‰¹æ”¹æœƒè§¸ç™¼Firebaseç›£è½å™¨ï¼ŒUIæœƒè‡ªå‹•é‡æ–°æ¸²æŸ“
                
                showMessage('æ­£ç¢ºç­”æ¡ˆå·²æ›´æ–°ä¸¦é‡æ–°æ‰¹æ”¹æ‰€æœ‰ä½œç­”ï¼', 'success');
                hideViewQuestionsModal();
            } catch (error) {
                console.error('æ›´æ–°æ­£ç¢ºç­”æ¡ˆå¤±æ•—:', error);
                showMessage('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        // NEW: é‡æ–°æ‰¹æ”¹æ‰€æœ‰å­¸ç”Ÿç­”æ¡ˆçš„å‡½æ•¸
        async function regradeAllStudentAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                return;
            }

            try {
                const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                const querySnapshot = await getDocs(studentsColRef);
                
                const batch = writeBatch(db);
                let regradeCount = 0;

                querySnapshot.forEach((docSnapshot) => {
                    const studentData = docSnapshot.data();
                    
                    // åªè™•ç†é¸æ“‡é¡Œçš„ç­”æ¡ˆï¼ˆArrayæ ¼å¼ï¼‰
                    if (Array.isArray(studentData.answer)) {
                        // æ›´æ–°å­¸ç”Ÿç­”æ¡ˆæ™‚é–“æˆ³ä»¥è§¸ç™¼UIé‡æ–°æ¸²æŸ“ï¼ˆç­”æ¡ˆå…§å®¹ä¿æŒä¸è®Šï¼‰
                        const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', docSnapshot.id);
                        batch.update(studentRef, {
                            regraded: true,
                            regradeTimestamp: new Date(),
                            timestamp: new Date(), // æ›´æ–°æ™‚é–“æˆ³ä»¥è§¸ç™¼ç›£è½å™¨é‡æ–°è©•åˆ¤ç­”æ¡ˆ
                            forceUpdate: Math.random() // æ·»åŠ éš¨æ©Ÿæ•¸å¼·åˆ¶è§¸ç™¼ç›£è½å™¨
                        });
                        regradeCount++;
                    }
                });

                if (regradeCount > 0) {
                    await batch.commit();
                    console.log(`é‡æ–°æ‰¹æ”¹äº† ${regradeCount} ä½å­¸ç”Ÿçš„ç­”æ¡ˆ`);
                }
            } catch (error) {
                console.error('é‡æ–°æ‰¹æ”¹ç­”æ¡ˆå¤±æ•—:', error);
                throw error;
            }
        }

        function clearStudentsByAnswerList() {
            studentsByAnswerListContainer.classList.add('hidden');
            studentsByAnswerListTitle.textContent = '';
            studentsByAnswerNamesParagraph.textContent = ''; 
        }

        function displayStudentsForAnswer(answer, mode, questionIndex = null) {
            clearStudentsByAnswerList();
            studentsByAnswerListContainer.classList.remove('hidden');

            let filteredStudents;
            let titleText;

            if (mode === 'multiple_choice' && questionIndex !== null && currentMultipleChoiceQuestions) {
                // For custom multiple choice, filter by specific question and correctness
                const question = currentMultipleChoiceQuestions[questionIndex];
                if (!question) {
                    studentsByAnswerListTitle.textContent = `å•é¡Œ ${questionIndex + 1} ä¸å­˜åœ¨ã€‚`;
                    studentsByAnswerNamesParagraph.textContent = '';
                    return;
                }
                
                // 'answer' here is 'correct' or 'incorrect'
                if (answer === 'correct') {
                    filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) === String(question.correctAnswer))
                    );
                    titleText = `å•é¡Œ ${questionIndex + 1} ç­”å°çš„å­¸ç”Ÿï¼š`;
                } else if (answer === 'incorrect') {
                     filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) !== String(question.correctAnswer))
                    );
                    titleText = `å•é¡Œ ${questionIndex + 1} ç­”éŒ¯çš„å­¸ç”Ÿï¼š`;
                } else { // Should not happen with current chart logic
                    filteredStudents = [];
                    titleText = `å•é¡Œ ${questionIndex + 1} çš„å­¸ç”Ÿï¼š`;
                }
            } else {
                // For default multiple choice or true/false
                filteredStudents = allStudentResponses.filter(s => s.answer === answer);
                titleText = `é¸æ“‡ã€Œ${answer}ã€çš„å­¸ç”Ÿï¼š`;
            }

            const studentNames = filteredStudents.map(s => s.name).sort(); 
            studentsByAnswerListTitle.textContent = studentNames.length > 0 ? `${titleText} ${studentNames.join(', ')}` : `${titleText} æ²’æœ‰å­¸ç”Ÿé¸æ“‡æ­¤ç­”æ¡ˆã€‚`;
            studentsByAnswerNamesParagraph.textContent = ''; // Clear this as the title now contains names
        }

        function drawChart(responses, mode) { // Changed parameter name from 'data' to 'responses' to avoid conflict
            chartSvg.selectAll("*").remove(); 
            clearStudentsByAnswerList(); 

            let chartData = {}; // Renamed 'data' to 'chartData'
            const filteredResponses = responses.filter(r => {
                if (mode === 'true_false' && (r.answer === 'O' || r.answer === 'X')) return true;
                if (mode === 'multiple_choice') {
                    if (currentMultipleChoiceQuestions) { // Custom MC
                        return Array.isArray(r.answer);
                    } else { // Default MC
                        return (r.answer >= '1' && r.answer <= '4');
                    }
                }
                return false;
            });

            const totalValidResponses = filteredResponses.length;

            if (totalValidResponses === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ç›®å‰æ²’æœ‰ä½œç­”è³‡æ–™ã€‚");
                return;
            }

            if (mode === 'true_false') {
                chartData = { 'O': 0, 'X': 0 }; // Use chartData
                filteredResponses.forEach(r => { chartData[r.answer]++; });
                drawPieChart(chartData, totalValidResponses); // Pass chartData
            } else if (mode === 'multiple_choice') {
                if (currentMultipleChoiceQuestions) { // Custom Multiple Choice Chart
                    drawCustomMultipleChoiceBarChart(filteredResponses, currentMultipleChoiceQuestions);
                } else { // Default Multiple Choice Chart
                    chartData = { '1': 0, '2': 0, '3': 0, '4': 0 }; // Use chartData
                    filteredResponses.forEach(r => { chartData[r.answer]++; });
                    drawBarChart(chartData, totalValidResponses); // Pass chartData
                }
            }
        }

        function drawPieChart(data, totalValidResponses) {
            const width = +chartSvg.attr("width");
            const height = +chartSvg.attr("height");
            const radius = Math.min(width, height) / 2 - 20;
            const g = chartSvg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
            const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#16a34a', '#dc2626']); // Green for O, Red for X
            const pie = d3.pie().value(d => d[1]).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            const arcs = g.selectAll(".arc").data(pie(Object.entries(data))).enter().append("g").attr("class", "arc");

            arcs.append("path")
                .attr("d", arc) 
                .attr("fill", d => color(d.data[0])) 
                .attr("stroke", "white").style("stroke-width", "2px")
                .on("click", (event, d) => displayStudentsForAnswer(d.data[0], 'true_false')); 

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", "0.35em")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d.data[1] / totalValidResponses) * 100).toFixed(1) : 0;
                    return `${d.data[0]}: ${d.data[1]} (${percentage}%)`;
                }) 
                .style("font-size", "14px").style("text-anchor", "middle").style("fill", "white");
        }

        function drawBarChart(data, totalValidResponses) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 30, left: 40};
            const x = d3.scaleBand().range([0, width]).padding(0.1).domain(Object.keys(data));
            const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(Object.values(data)) || 1]); 
            const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#2563eb', '#ca8a04', '#16a34a', '#dc2626']);
            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
            g.append("g").call(d3.axisLeft(y).ticks(Math.min(10, d3.max(Object.values(data)) || 1)).tickFormat(d3.format('d')));

            g.selectAll(".bar").data(Object.entries(data)).enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2) 
                .attr("y", d => y(d[1])) 
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[1])) 
                .attr("fill", d => color(d[0]))
                .on("click", (event, d) => displayStudentsForAnswer(d[0], 'multiple_choice')); 
            
            g.selectAll(".bar-label").data(Object.entries(data)).enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2) 
                .attr("y", d => y(d[1]) - 5) 
                .attr("text-anchor", "middle").style("font-size", "12px")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d[1] / totalValidResponses) * 100).toFixed(1) : 0;
                    return `${d[1]} (${percentage}%)`;
                }); 
        }

        /**
         * NEW: Draws a bar chart for custom multiple choice questions, showing correctness rate per question.
         * @param {Array} responses - All student responses.
         * @param {Array} questions - The custom multiple choice questions.
         */
        function drawCustomMultipleChoiceBarChart(responses, questions) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 60, left: 40}; // Increased bottom margin for question labels
            
            const questionStats = questions.map((q, qIndex) => {
                let correctCount = 0;
                let answeredCount = 0; // Count students who attempted this question

                responses.forEach(studentResponse => {
                    if (Array.isArray(studentResponse.answer)) {
                        const studentQAnswer = studentResponse.answer.find(ans => ans.qIndex === qIndex);
                        if (studentQAnswer) {
                            answeredCount++;
                            if (String(studentQAnswer.ans) === String(q.correctAnswer)) {
                                correctCount++;
                            }
                        }
                    }
                });
                return {
                    questionIndex: qIndex,
                    questionText: `Q${qIndex + 1}`, // Display as Q1, Q2 etc.
                    correctCount: correctCount,
                    answeredCount: answeredCount,
                    correctRate: answeredCount > 0 ? (correctCount / answeredCount) * 100 : 0
                };
            });

            // Filter out questions with no attempts if desired, or show 0%
            const displayStats = questionStats.filter(s => s.answeredCount > 0);
            if (displayStats.length === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ç›®å‰æ²’æœ‰å­¸ç”Ÿä½œç­”ä»»ä½•è‡ªè¨‚é¸æ“‡é¡Œã€‚");
                return;
            }

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.2)
                .domain(displayStats.map(d => d.questionText));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 100]); // Percentage from 0 to 100

            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // X-axis
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)") // Rotate labels for readability
                .style("text-anchor", "end");

            // Y-axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

            // Bars
            g.selectAll(".bar")
                .data(displayStats)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.questionText))
                .attr("y", d => y(d.correctRate))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.correctRate))
                .attr("fill", "#2563eb") // A nice blue color
                .on("click", (event, d) => displayStudentsForAnswer('correct', 'multiple_choice', d.questionIndex)); // Click to show correct students

            // Labels on bars
            g.selectAll(".bar-label")
                .data(displayStats)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => `${d.correctRate.toFixed(1)}%`);

            // Y-axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("ç­”å°ç‡ (%)");
        }


        // --- Drawing Board Logic ---
        function setupCanvas() {
            const canvasElement = document.getElementById('drawing-canvas');
            if (!canvasElement.offsetParent) return; // Don't setup if not visible
            let renderedWidth = canvasElement.clientWidth;
            let renderedHeight = canvasElement.clientHeight;

            canvasElement.width = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedWidth)); 
            canvasElement.height = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedHeight));

            [backgroundCanvas, studentImageCanvas, drawingCanvas].forEach(c => {
                c.width = canvasElement.width;
                c.height = canvasElement.height;
            });

            drawingCtx.lineJoin = 'round';
            drawingCtx.lineCap = 'round';
            drawingCtx.strokeStyle = document.getElementById('color-select').value;
            drawingCtx.lineWidth = parseInt(document.getElementById('size-select').value);
            drawingCtx.globalCompositeOperation = 'source-over';

            // Only clear drawingCanvas if it's a new session, not just a resize within the same session.
            // This is handled by the `resetStudentUIState` function now.
            // For setupCanvas, it's about setting dimensions and initial drawing context properties.
            // The actual clearing should be conditional based on pause state.
            // However, for a fresh setup (e.g., first time entering drawing mode), it should be cleared.
            // The logic in resetStudentUIState is responsible for this.
            // So, here, we just ensure the canvases are ready.
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
        }

        function loadBackgroundImage() {
            backgroundCtx.clearRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);

            // ç•«ç¶²æ ¼ï¼ˆå¦‚æœæœ‰é–‹å•Ÿï¼‰
            if (window._showGridOnDrawingCanvas) {
                const gridSpacing = 40; // px
                backgroundCtx.save();
                backgroundCtx.strokeStyle = '#e5e7eb';
                backgroundCtx.lineWidth = 1;
                for (let x = gridSpacing; x < backgroundCanvas.width; x += gridSpacing) {
                    backgroundCtx.beginPath();
                    backgroundCtx.moveTo(x, 0);
                    backgroundCtx.lineTo(x, backgroundCanvas.height);
                    backgroundCtx.stroke();
                }
                for (let y = gridSpacing; y < backgroundCanvas.height; y += gridSpacing) {
                    backgroundCtx.beginPath();
                    backgroundCtx.moveTo(0, y);
                    backgroundCtx.lineTo(backgroundCanvas.width, y);
                    backgroundCtx.stroke();
                }
                backgroundCtx.restore();
            }

            if (teacherUploadedBackgroundImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = backgroundCanvas.width / backgroundCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = backgroundCanvas.width / imgRatio;
                        drawWidth = backgroundCanvas.width;
                        offsetY = (backgroundCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = backgroundCanvas.height * imgRatio;
                        drawHeight = backgroundCanvas.height;
                        offsetX = (backgroundCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    backgroundCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = teacherUploadedBackgroundImageDataURL;
            } else {
                drawCombinedCanvas();
            }
            // åˆå§‹åŒ–ç¶²æ ¼ç‹€æ…‹
            if (window._showGridOnDrawingCanvas === undefined) {
                window._showGridOnDrawingCanvas = false;
            }
        // ç¶²æ ¼é–‹é—œäº‹ä»¶
        document.getElementById('toggle-grid-checkbox').addEventListener('change', function() {
            window._showGridOnDrawingCanvas = this.checked;
            loadBackgroundImage();
        });
        }

        function loadStudentImage() {
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);

            if (studentUploadedImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = studentImageCanvas.width / studentImageCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = studentImageCanvas.width / imgRatio;
                        drawWidth = studentImageCanvas.width;
                        offsetY = (studentImageCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = studentImageCanvas.height * imgRatio;
                        drawHeight = studentImageCanvas.height;
                        offsetX = (studentImageCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    studentImageCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = studentUploadedImageDataURL;
            } else {
                drawCombinedCanvas();
            }
        }

        function drawCombinedCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundCanvas, 0, 0);
            ctx.drawImage(studentImageCanvas, 0, 0);
            ctx.drawImage(drawingCanvas, 0, 0);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const { offsetX, offsetY } = getMousePos(e); 
            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(offsetX, offsetY);
            drawingCtx.stroke();
            [lastX, lastY] = [offsetX, offsetY];
            drawCombinedCanvas();
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect(); 
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rawOffsetX = clientX - rect.left;
            const rawOffsetY = clientY - rect.top;
            const scaleX = canvas.width / rect.width; 
            const scaleY = canvas.height / rect.height;
            return { offsetX: rawOffsetX * scaleX, offsetY: rawOffsetY * scaleY };
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const { offsetX, offsetY } = getMousePos(e); 
            [lastX, lastY] = [offsetX, offsetY];
        }

        function stopDrawing() { isDrawing = false; }
        
        function clearDrawingCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawCombinedCanvas();
        }

        function updateColorSwatch(color) {
            const swatch = document.getElementById('current-color-swatch');
            if (swatch) swatch.style.backgroundColor = color;
        }
        
        // --- AI Settings Modal Functions ---
        const aiSettingsModal = document.getElementById('ai-settings-modal');
        const aiSettingsModalCloseBtn = document.getElementById('ai-settings-modal-close-btn');
        const aiSourceSelect = document.getElementById('ai-source-select');
        const geminiApiKeyGroup = document.getElementById('gemini-api-key-group');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const saveAiSettingsBtn = document.getElementById('save-ai-settings-btn');

        function showAISettingsModal() {
            aiSourceSelect.value = aiSettings.aiSource;
            geminiApiKeyInput.value = aiSettings.geminiApiKey;
            geminiApiKeyGroup.classList.toggle('hidden', aiSettings.aiSource !== 'gemini-custom');
            aiSettingsModal.classList.remove('hidden');
        }

        function hideAISettingsModal() {
            aiSettingsModal.classList.add('hidden');
        }

        function saveAISettings() {
            aiSettings.aiSource = aiSourceSelect.value;
            aiSettings.geminiApiKey = geminiApiKeyInput.value.trim();
            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
            showMessage('AI è¨­å®šå·²å„²å­˜ï¼', 'success');
            hideAISettingsModal();
        }

        function loadAISettings() {
            const savedSettings = localStorage.getItem('aiSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    if (parsedSettings.aiSource) aiSettings.aiSource = parsedSettings.aiSource;
                    // MODIFIED: If geminiApiKey is empty after loading, set default.
                    aiSettings.geminiApiKey = parsedSettings.geminiApiKey || 'AIzaSyBrVKhaUXzUCdfGCGixLlivPuhyOiKDFE0'; 
                } catch (e) {
                    console.error("Failed to parse AI settings from localStorage:", e);
                    // If parsing fails, set default API key
                    aiSettings.geminiApiKey = 'AIzaSyBrVKhaUXzUCdfGCGixLlivPuhyOiKDFE0';
                }
            } else {
                // If no settings are saved at all, set default API key
                aiSettings.geminiApiKey = 'AIzaSyBrVKhaUXzUCdfGCGixLlivPuhyOiKDFE0';
            }
        }

        // --- New: URL/HTML Dispatch Settings Modal Functions (Combined) ---
        const urlDispatchModal = document.getElementById('url-dispatch-settings-modal');
        const urlDispatchModalCloseBtn = document.getElementById('url-dispatch-settings-modal-close-btn');
        
        const urlDispatchSection = document.getElementById('url-dispatch-section');
        const htmlDispatchSection = document.getElementById('html-dispatch-section');
        const dispatchTypeRadios = document.querySelectorAll('input[name="dispatchType"]');

        const urlInput = document.getElementById('dispatch-url-input');
        const isYoutubeCheckbox = document.getElementById('is-youtube-checkbox');
        
        const dispatchHtmlUploadInput = document.getElementById('dispatch-html-upload-input');
        const clearDispatchHtmlBtn = document.getElementById('clear-dispatch-html-btn');
        const dispatchHtmlStatus = document.getElementById('dispatch-html-status');

        function showUrlDispatchSettingsModal() {
            // Set radio button based on current dispatchSettings.type
            document.querySelector(`input[name="dispatchType"][value="${dispatchSettings.type}"]`).checked = true;
            
            // Show/hide sections based on type
            urlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'html');
            htmlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'url');

            // Populate URL fields
            urlInput.value = dispatchSettings.url;
            isYoutubeCheckbox.checked = dispatchSettings.isYoutube;

            // Update HTML status
            dispatchHtmlStatus.textContent = dispatchSettings.htmlContent ? 'å·²ä¸Šå‚³ HTML æª”æ¡ˆã€‚' : 'ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚';

            urlDispatchModal.classList.remove('hidden');
        }

        function hideUrlDispatchSettingsModal() {
            urlDispatchModal.classList.add('hidden');
        }

        function saveDispatchSettings() { // Renamed from saveUrlDispatchSettings
            dispatchSettings.type = document.querySelector('input[name="dispatchType"]:checked').value;

            if (dispatchSettings.type === 'url') {
                let inputUrl = urlInput.value.trim();
                
                // ç¢ºä¿URLæœ‰æ­£ç¢ºçš„å”è­°å‰ç¶´
                if (inputUrl && !inputUrl.startsWith('http://') && !inputUrl.startsWith('https://')) {
                    inputUrl = 'https://' + inputUrl;
                }
                
                dispatchSettings.url = inputUrl;
                dispatchSettings.isYoutube = isYoutubeCheckbox.checked;
                dispatchSettings.htmlContent = null; // Clear HTML content if switching to URL
                
                console.log('[Teacher] å„²å­˜æ´¾é€ç¶²å€:', urlInput.value.trim(), 'â†’', inputUrl); // é™¤éŒ¯ä¿¡æ¯
            } else { // type === 'html'
                // htmlContent is updated via handleHtmlFile or clearDispatchHtml
                dispatchSettings.url = ''; // Clear URL if switching to HTML
                dispatchSettings.isYoutube = false; // Clear YouTube flag
            }
            
            localStorage.setItem('dispatchSettings', JSON.stringify(dispatchSettings));
            showMessage('æ´¾é€è¨­å®šå·²å„²å­˜ï¼', 'success');
            hideUrlDispatchSettingsModal();
        }

        function clearDispatchSettings() { // Renamed from clearUrlDispatchSettings
            urlInput.value = '';
            isYoutubeCheckbox.checked = false;
            dispatchHtmlUploadInput.value = ''; // Clear file input
            dispatchHtmlStatus.textContent = 'ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚';

            dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null }; // Reset global variable
            localStorage.removeItem('dispatchSettings'); // Clear from localStorage
            
            // Reset UI to default (URL selected)
            document.querySelector('input[name="dispatchType"][value="url"]').checked = true;
            urlDispatchSection.classList.remove('hidden');
            htmlDispatchSection.classList.add('hidden');
        }

        function loadDispatchSettings() { // Renamed from loadUrlDispatchSettings
            const savedSettings = localStorage.getItem('dispatchSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Ensure all properties are set, even if null in saved data
                    dispatchSettings.type = parsedSettings.type || 'url';
                    dispatchSettings.url = parsedSettings.url || '';
                    dispatchSettings.isYoutube = parsedSettings.isYoutube || false;
                    dispatchSettings.htmlContent = parsedSettings.htmlContent || null;
                } catch (e) {
                    console.error("Failed to parse dispatch settings from localStorage:", e);
                    // Reset to default if parsing fails
                    dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null };
                }
            }
        }

        /**
         * NEW: Handles HTML file upload within the combined dispatch settings modal.
         * @param {File} file - The HTML file to process.
         */
        function handleDispatchHtmlFile(file) {
            if (!file || !file.type.includes('html')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                dispatchSettings.htmlContent = event.target.result; // Update global state
                dispatchHtmlStatus.textContent = `å·²ä¸Šå‚³æª”æ¡ˆ: ${file.name}`;
                showMessage('HTML æª”æ¡ˆå·²ä¸Šå‚³ï¼', 'success');
            };
            reader.readAsText(file);
        }


        /*
        // éŒ„éŸ³åŠŸèƒ½æš«æ™‚è¨»éŠ· - HTTPç’°å¢ƒä¸æ”¯æ´éº¥å…‹é¢¨æ¬Šé™
        // --- New: Recording Functions (Student Side) ---
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const playRecordingBtn = document.getElementById('play-recording-btn');
        const resetRecordingBtn = document.getElementById('reset-recording-btn');
        const submitRecordingBtn = document.getElementById('submit-recording-btn');
        const audioPreview = document.getElementById('audio-preview');
        const recordingStatusText = document.getElementById('recording-status-text');
        const recordingStatusIcon = document.getElementById('recording-status-icon');

        /**
         * æª¢æŸ¥éŒ„éŸ³æ”¯æ´å’Œæ¬Šé™ç‹€æ…‹
         */
        async function checkRecordingSupport() {
            // æª¢æŸ¥åŸºæœ¬æ”¯æ´
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                recordingStatusText.textContent = 'ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½';
                recordingStatusIcon.classList.remove('fa-microphone-alt');
                recordingStatusIcon.classList.add('fa-exclamation-triangle', 'text-red-500');
                startRecordingBtn.disabled = true;
                showMessage('ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½ã€‚è«‹ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Firefoxæˆ–Safariã€‚', 'error');
                return;
            }

            // æª¢æŸ¥HTTPSè¦æ±‚
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1' && location.hostname !== '192.168.0.128') {
                recordingStatusText.textContent = 'éœ€è¦HTTPSé€£æ¥æ‰èƒ½éŒ„éŸ³';
                recordingStatusIcon.classList.remove('fa-microphone-alt');
                recordingStatusIcon.classList.add('fa-lock', 'text-orange-500');
                startRecordingBtn.disabled = true;
                showMessage('éŒ„éŸ³åŠŸèƒ½éœ€è¦å®‰å…¨é€£æ¥(HTTPS)ã€‚è«‹ä½¿ç”¨https://é–‹é ­çš„ç¶²å€ã€‚', 'warning');
                return;
            }

            // æª¢æŸ¥æ¬Šé™ç‹€æ…‹
            try {
                const permission = await navigator.permissions.query({ name: 'microphone' });
                if (permission.state === 'denied') {
                    recordingStatusText.textContent = 'éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±';
                    recordingStatusIcon.classList.remove('fa-microphone-alt');
                    recordingStatusIcon.classList.add('fa-microphone-slash', 'text-red-500');
                    showMessage('éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹é»æ“Šç¶²å€åˆ—å·¦å´åœ–ç¤ºï¼Œå…è¨±éº¥å…‹é¢¨æ¬Šé™å¾Œé‡æ–°æ•´ç†é é¢ã€‚', 'error');
                } else if (permission.state === 'granted') {
                    recordingStatusText.textContent = 'æº–å‚™éŒ„éŸ³ (æ¬Šé™å·²å…è¨±)';
                    recordingStatusIcon.classList.remove('text-gray-400');
                    recordingStatusIcon.classList.add('text-green-500');
                } else {
                    recordingStatusText.textContent = 'æº–å‚™éŒ„éŸ³ (é»æ“ŠæŒ‰éˆ•æ™‚æœƒè¦æ±‚æ¬Šé™)';
                    recordingStatusIcon.classList.remove('text-gray-400');
                    recordingStatusIcon.classList.add('text-blue-500');
                }
            } catch (err) {
                // permissions API ä¸æ”¯æ´çš„ç€è¦½å™¨
                recordingStatusText.textContent = 'æº–å‚™éŒ„éŸ³...';
                recordingStatusIcon.classList.remove('text-gray-400');
                recordingStatusIcon.classList.add('text-blue-500');
            }
        }

        /**
         * Starts the audio recording process.
         */
        async function startRecording() {
            try {
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´éŒ„éŸ³åŠŸèƒ½
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½');
                }

                // æª¢æŸ¥HTTPSè¦æ±‚ (é™¤äº†localhost)
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    showMessage('éŒ„éŸ³åŠŸèƒ½éœ€è¦HTTPSé€£æ¥ã€‚è«‹ä½¿ç”¨https://é–‹é ­çš„ç¶²å€æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚', 'error');
                    return;
                }

                // æç¤ºç”¨æˆ¶å…è¨±éº¥å…‹é¢¨æ¬Šé™
                recordingStatusText.textContent = 'è«‹å…è¨±ç€è¦½å™¨å­˜å–éº¥å…‹é¢¨...';
                recordingStatusIcon.classList.remove('text-gray-400');
                recordingStatusIcon.classList.add('fa-spin', 'text-blue-500');

                // Request access to microphone with specific constraints
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100,
                        channelCount: 1
                    }
                };

                audioStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Try to use audio/wav first for better iOS compatibility.
                // Fallback to audio/webm if wav is not supported.
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    mimeType = 'audio/wav';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4'; // Another common format
                } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                    mimeType = 'audio/ogg';
                }

                mediaRecorder = new MediaRecorder(audioStream, { mimeType: mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType }); // Use the actual mimeType recorded
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        audioDataURL = reader.result;
                        audioPreview.src = audioDataURL;
                        audioPreview.classList.remove('hidden');
                        playRecordingBtn.disabled = false;
                        resetRecordingBtn.disabled = false;
                        submitRecordingBtn.disabled = false;
                        recordingStatusText.textContent = 'éŒ„éŸ³å®Œæˆï¼Œå¯è©¦è½æˆ–é€å‡º';
                        recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                        recordingStatusIcon.classList.add('text-green-500');
                    };
                    reader.readAsDataURL(audioBlob);

                    // Stop all tracks to release microphone
                    audioStream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = 'æ­£åœ¨éŒ„éŸ³...';
                recordingStatusIcon.classList.remove('text-gray-400');
                recordingStatusIcon.classList.add('fa-spin', 'text-red-500');
                showMessage('é–‹å§‹éŒ„éŸ³', 'info');
            } catch (err) {
                console.error('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™:', err);
                
                // æ ¹æ“šä¸åŒéŒ¯èª¤é¡å‹æä¾›å…·é«”æŒ‡å°
                let errorMessage = 'éŒ„éŸ³å¤±æ•—ï¼š';
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage += 'éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ã€‚\n\nè§£æ±ºæ–¹æ³•ï¼š\n1. é»æ“Šç¶²å€åˆ—å·¦å´çš„ğŸ”’æˆ–â“˜åœ–ç¤º\n2. å…è¨±ã€Œéº¥å…‹é¢¨ã€æ¬Šé™\n3. é‡æ–°æ•´ç†é é¢å¾Œå†è©¦';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessage += 'æ‰¾ä¸åˆ°éº¥å…‹é¢¨è¨­å‚™ã€‚\n\nè«‹æª¢æŸ¥ï¼š\n1. éº¥å…‹é¢¨æ˜¯å¦æ­£ç¢ºé€£æ¥\n2. å…¶ä»–æ‡‰ç”¨ç¨‹å¼æ˜¯å¦æ­£åœ¨ä½¿ç”¨éº¥å…‹é¢¨';
                } else if (err.name === 'NotSupportedError') {
                    errorMessage += 'ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½ã€‚\n\nå»ºè­°ï¼š\n1. æ›´æ–°ç€è¦½å™¨åˆ°æœ€æ–°ç‰ˆæœ¬\n2. ä½¿ç”¨Chromeã€Firefoxæˆ–Safari';
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMessage += 'éº¥å…‹é¢¨è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨ã€‚\n\nè«‹é—œé–‰å…¶ä»–ä½¿ç”¨éº¥å…‹é¢¨çš„æ‡‰ç”¨ç¨‹å¼å¾Œå†è©¦ã€‚';
                } else if (err.message.includes('HTTPS')) {
                    errorMessage += err.message;
                } else {
                    errorMessage += `æœªçŸ¥éŒ¯èª¤ (${err.name || err.message})ã€‚\n\nè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–è¯ç¹«æŠ€è¡“æ”¯æ´ã€‚`;
                }
                
                showMessage(errorMessage, 'error');
                // Reset buttons if permission fails
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = 'éŒ„éŸ³å¤±æ•—';
                recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                recordingStatusIcon.classList.add('text-gray-400');
            }
        }

        /**
         * Stops the audio recording.
         */
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stopRecordingBtn.disabled = true;
            }
        }

        /**
         * Plays the recorded audio.
         */
        function playRecording() {
            if (audioPreview.src) {
                audioPreview.play();
                showMessage('æ­£åœ¨æ’­æ”¾éŒ„éŸ³', 'info');
            } else {
                showMessage('æ²’æœ‰å¯æ’­æ”¾çš„éŒ„éŸ³', 'info');
            }
        }

        /**
         * Resets the recording state, allowing for a new recording.
         */
        function resetRecording() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            audioChunks = [];
            audioBlob = null;
            audioDataURL = null;
            audioPreview.src = '';
            audioPreview.classList.add('hidden');

            startRecordingBtn.disabled = false;
            stopRecordingBtn.disabled = true;
            playRecordingBtn.disabled = true;
            resetRecordingBtn.disabled = true;
            submitRecordingBtn.disabled = true;
            recordingStatusText.textContent = 'æº–å‚™éŒ„éŸ³...';
            recordingStatusIcon.classList.remove('fa-spin', 'text-red-500', 'text-green-500');
            recordingStatusIcon.classList.add('text-gray-400');
            showMessage('éŒ„éŸ³å·²é‡ç½®', 'info');
        }

        // --- End Recording Functions ---
        // éŒ„éŸ³åŠŸèƒ½è¨»éŠ·çµæŸ */

        /**
         * (Teacher) Ends the entire class session, clears all student data and presence for the current classroom code.
         */
        async function endClassSession() {
            markClassEnded(); // Mark that class has been properly ended
            clearAllQuestionBanks(); // Clear question banks from memory
            showMessage('æ­£åœ¨çµæŸèª²ç¨‹ä¸¦æ¸…ç©ºè³‡æ–™...', 'info');

            if (interactionModeUnsubscribe && typeof interactionModeUnsubscribe === 'function') {
                interactionModeUnsubscribe();
            }
            if (studentResponsesUnsubscribe && typeof studentResponsesUnsubscribe === 'function') {
                studentResponsesUnsubscribe();
            }
            if (classroomPresenceUnsubscribe && typeof classroomPresenceUnsubscribe === 'function') { // Only unsubscribe presence here
                classroomPresenceUnsubscribe();
                classroomPresenceUnsubscribe = null;
            }
            
            // æ¸…ç†å®šæœŸåˆ·æ–°æ©Ÿåˆ¶
            if (window.presenceRefreshInterval) {
                clearInterval(window.presenceRefreshInterval);
                window.presenceRefreshInterval = null;
                console.log("[Teacher] Cleared presence refresh interval");
            }
            
            // æ¸…ç†é˜²æŠ–å®šæ™‚å™¨
            if (presenceUpdateDebounceTimer) {
                clearTimeout(presenceUpdateDebounceTimer);
                presenceUpdateDebounceTimer = null;
                console.log("[Teacher] Cleared presence update debounce timer");
            }
            
            // é‡ç½®æ›´æ–°ç‹€æ…‹
            isUpdatingPresence = false;
            
            interactionModeUnsubscribe = studentResponsesUnsubscribe = null; // Reset others

            try {
                // Delete the entire classroom and related data for the current classroomCode
                if (classroomCode) {
                    await ClassroomAPI.delete(classroomCode, userId);
                    console.log(`[Teacher] Cleared all data for classroom: ${classroomCode}`);
                }
                
                classroomCode = null; // Clear the classroom code after ending session
                classroomRecordId = null; // Clear classroom record ID
                localStorage.removeItem('teacherClassroomCode'); // Clear from local storage

                studentName = null;
                currentRole = null;
                currentInteractionMode = null;
                allStudentResponses = [];
                activeStudentNames = []; // NEW: Clear active student names
                lastSelectedStudentCard = null;
                lastSelectedModalStudent = null; // NEW: Clear modal lottery highlight
                isResponsePaused = false; // NEW: Reset pause state
                currentMultipleChoiceQuestions = null; // NEW: Clear custom MC questions

                document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                document.getElementById('active-student-count').textContent = '0';
                // REMOVED: document.getElementById('responded-student-count').textContent = '0';
                document.getElementById('teacher-image-status').textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');

                // Clear URL/HTML dispatch settings and teacher background image when ending interaction
                clearDispatchSettings(); // Use the combined clear function
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false; // NEW: Reset pause state
                updateTeacherPauseButtonUI(); // NEW: Update pause button UI

                // é‡æ–°åˆå§‹åŒ–ç”¨æˆ¶ (æ›¿ä»£ Firebase re-authentication)
                initializeUser();
                console.log("Re-initialized user after ending session.");

                showView('entry'); // Show the entry view
                showMessage('èª²ç¨‹å·²çµæŸï¼Œè³‡æ–™å·²æ¸…ç©ºã€‚', 'success');

            } catch (error) {
                console.error("çµæŸèª²ç¨‹ä¸¦æ¸…ç©ºè³‡æ–™å¤±æ•—:", error);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ¬Šé™éŒ¯èª¤
                if (error.isPermissionDenied) {
                    showMessage(error.message, "error");
                } else {
                    showMessage("çµæŸèª²ç¨‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç®¡ç†å“¡ã€‚", "error");
                }
            }
        }

        // NEW: Pause/Resume Response Logic
        const togglePauseBtn = document.getElementById('toggle-pause-btn');
        const togglePauseBtnText = document.getElementById('toggle-pause-btn-text');

        /**
         * Toggles the pause state for student responses in Firestore.
         */
        async function toggleResponsePause() {
            if (!classroomCode) {
                showMessage('è«‹å…ˆé–‹å•Ÿä¸€å€‹æ•™å®¤ï¼', 'error');
                return;
            }
            if (!classroomRecordId) {
                showMessage('æ•™å®¤è¨˜éŒ„IDä¸å­˜åœ¨ï¼Œç„¡æ³•æ›´æ–°æš«åœç‹€æ…‹ï¼', 'error');
                return;
            }
            try {
                isResponsePaused = !isResponsePaused; // Toggle local state
                
                // ç›´æ¥ä½¿ç”¨ PocketBase æ›´æ–°ï¼Œé¿å… ClassroomAPI.upsert çš„è¡çªæª¢æŸ¥
                await pb.collection('classrooms').update(classroomRecordId, { 
                    is_paused: isResponsePaused,
                    last_activity: new Date().toISOString() // åŒæ™‚æ›´æ–°æ´»å‹•æ™‚é–“
                });
                
                showMessage(`å­¸ç”Ÿå›è¦†å·²${isResponsePaused ? 'æš«åœ' : 'æ¢å¾©'}ï¼`, 'info');
                updateTeacherPauseButtonUI();
            } catch (error) {
                console.error("åˆ‡æ›æš«åœå›è¦†ç‹€æ…‹å¤±æ•—:", error);
                showMessage("åˆ‡æ›ç‹€æ…‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
                isResponsePaused = !isResponsePaused; // Revert local state on error
                updateTeacherPauseButtonUI(); // é‚„åŸæŒ‰éˆ•ç‹€æ…‹
            }
        }

        /**
         * Updates the teacher's pause button UI based on the `isResponsePaused` state.
         */
        function updateTeacherPauseButtonUI() {
            if (isResponsePaused) {
                togglePauseBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                togglePauseBtnText.textContent = 'æ¢å¾©';
                togglePauseBtn.querySelector('i').classList.replace('fa-pause', 'fa-play');
            } else {
                togglePauseBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                togglePauseBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtnText.textContent = 'æš«åœ';
                togglePauseBtn.querySelector('i').classList.replace('fa-play', 'fa-pause');
            }
        }


        // --- Event Listeners ---
        
        /**
         * NEW: Processes an image file (from upload or paste), resizes it, and applies it.
         * @param {File} file - The image file to process.
         * @param {boolean} isTeacher - True if the image is for the teacher's background.
         */
        function handleImageFile(file, isTeacher) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);

                    if (isTeacher) {
                        teacherUploadedBackgroundImageDataURL = dataUrl;
                        // For teacher image, we need to pass statusId, previewId, previewContainerId
                        // These are not directly available in handleImageFile without context.
                        // Let's assume these are passed as arguments or accessed globally.
                        // Re-evaluate how setupImageUpload calls this.
                        document.getElementById('teacher-image-status').textContent = 'å·²ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                        document.getElementById('teacher-image-preview').src = dataUrl;
                        document.getElementById('teacher-image-preview-container').classList.remove('hidden');
                        showMessage('èƒŒæ™¯åœ–ç‰‡å·²ä¸Šå‚³ï¼', 'success');
                    } else {
                        studentUploadedImageDataURL = dataUrl;
                        showMessage('åœ–ç‰‡å·²ä¸Šå‚³ï¼', 'success');
                        loadStudentImage();
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * MODIFIED: Sets up image upload functionality for both file input and pasting.
         */
        const setupImageUpload = (inputId, statusId, previewContainerId, previewId, clearBtnId, isTeacher) => {
            const input = document.getElementById(inputId);
            const clearBtn = document.getElementById(clearBtnId);
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input to allow re-uploading the same file
                if (file) {
                    // Pass the IDs to handleImageFile for teacher-specific updates
                    if (isTeacher) {
                        handleImageFileForTeacher(file, statusId, previewContainerId, previewId);
                    } else {
                        handleImageFile(file, isTeacher);
                    }
                }
            });

            clearBtn.addEventListener('click', async () => {
                if (isTeacher) {
                    try {
                        if (!classroomRecordId) {
                            showMessage('è«‹å…ˆå»ºç«‹æ•™å®¤å†æ¸…é™¤åœ–ç‰‡ï¼', 'error');
                            return;
                        }
                        // æ¸…é™¤ PocketBase ä¸Šçš„èƒŒæ™¯åœ–æª”æ¬„ä½
                        await pb.collection('classrooms').update(classroomRecordId, {
                            background_image_file: null,
                            background_image: ''
                        });
                        teacherUploadedBackgroundImageDataURL = null;
                        document.getElementById(statusId).textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                        document.getElementById(previewId).src = '';
                        document.getElementById(previewContainerId).classList.add('hidden');
                        showMessage('èƒŒæ™¯åœ–ç‰‡å·²æ¸…é™¤ï¼', 'info');
                    } catch (err) {
                        showMessage('æ¸…é™¤èƒŒæ™¯åœ–ç‰‡å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚', 'error');
                        console.error('æ¸…é™¤èƒŒæ™¯åœ–ç‰‡å¤±æ•—:', err);
                    }
                } else {
                    studentUploadedImageDataURL = null;
                    studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                    showMessage('åœ–ç‰‡å·²æ¸…é™¤ï¼', 'info');
                    drawCombinedCanvas();
                }
            });
        };

        // NEW: Separate function for teacher image handling to pass specific DOM IDs
        async function handleImageFileForTeacher(file, statusId, previewContainerId, previewId) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const img = new Image();
                img.onload = async () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    // Convert canvas to Blob for upload
                    tempCanvas.toBlob(async (blob) => {
                        if (!blob) {
                            showMessage('åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚', 'error');
                            return;
                        }
                        // Prepare FormData for PocketBase file upload
                        const formData = new FormData();
                        formData.append('background_image_file', blob, 'background.jpg');
                        // Optionally update other fields if needed
                        try {
                            if (!classroomRecordId) {
                                showMessage('è«‹å…ˆå»ºç«‹æ•™å®¤å†ä¸Šå‚³åœ–ç‰‡ï¼', 'error');
                                return;
                            }
                            // Upload file to PocketBase classroom record
                            const updated = await pb.collection('classrooms').update(classroomRecordId, formData);
                            // Update UI preview
                            const dataUrl = URL.createObjectURL(blob);
                            teacherUploadedBackgroundImageDataURL = dataUrl;
                            document.getElementById(statusId).textContent = 'å·²ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                            document.getElementById(previewId).src = dataUrl;
                            document.getElementById(previewContainerId).classList.remove('hidden');
                            showMessage('èƒŒæ™¯åœ–ç‰‡å·²ä¸Šå‚³ä¸¦åŒæ­¥åˆ°æ•™å®¤ï¼', 'success');
                        } catch (err) {
                            showMessage('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚', 'error');
                            console.error('PocketBase åœ–ç‰‡ä¸Šå‚³å¤±æ•—:', err);
                        }
                    }, 'image/jpeg', JPEG_QUALITY);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }


        function setupEventListeners() {
            // Entry screen.
            document.getElementById('teacher-entry-btn').addEventListener('click', () => {
                // æ”¯æ´ ?role=teacher&password=xxx ä¹Ÿèƒ½è‡ªå‹•è·³éå¯†ç¢¼è¦–çª—
                const urlParams = new URLSearchParams(window.location.search);
                const role = urlParams.get('role');
                const password = urlParams.get('password');
                if ((urlParams.get('passwd') === 'no') || (role === 'teacher' && password)) {
                    showView('teacherClassroomCode');
                } else {
                    document.getElementById('teacher-password-modal').classList.remove('hidden');
                }
            });
            document.getElementById('student-entry-btn').addEventListener('click', () => {
                currentRole = 'student';
                showView('studentName');
            });

            // NEW: Teacher classroom code input.
            document.getElementById('teacher-classroom-code-back-btn').addEventListener('click', () => showView('entry'));
            document.getElementById('teacher-classroom-code-submit-btn').addEventListener('click', async () => {
                const code = document.getElementById('teacher-classroom-code-input').value.trim();
                
                // åªéœ€è¦é©—è­‰æ•™å®¤ä»£ç¢¼ï¼Œå¯†ç¢¼å·²åœ¨æ¨¡æ…‹æ¡†ä¸­é©—è­‰é
                if (!code) {
                    showMessage('è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼', 'error');
                    return;
                }
                
                try {
                    console.log('[Teacher] Starting classroom creation process...');
                    console.log('[Teacher] Cleaning up any existing state...');
                    
                    // æ¸…ç†ä»»ä½•èˆŠçš„ç›£è½å™¨å’Œç‹€æ…‹
                    if (classroomPresenceUnsubscribe && typeof classroomPresenceUnsubscribe === 'function') {
                        console.log('[Teacher] Unsubscribing old presence listener...');
                        classroomPresenceUnsubscribe();
                        classroomPresenceUnsubscribe = null;
                    }
                    if (interactionModeUnsubscribe && typeof interactionModeUnsubscribe === 'function') {
                        console.log('[Teacher] Unsubscribing old interaction mode listener...');
                        interactionModeUnsubscribe();
                        interactionModeUnsubscribe = null;
                    }
                    if (studentResponsesUnsubscribe && typeof studentResponsesUnsubscribe === 'function') {
                        console.log('[Teacher] Unsubscribing old student responses listener...');
                        studentResponsesUnsubscribe();
                        studentResponsesUnsubscribe = null;
                    }
                    
                    // é‡ç½®ç›¸é—œç‹€æ…‹
                    activeStudentNames = [];
                    allStudentResponses = [];
                    currentInteractionMode = null;
                    isResponsePaused = false;
                    
                    // é‡ç½® UI é¡¯ç¤º
                    document.getElementById('active-student-count').textContent = '0';
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">æ­£åœ¨ç­‰å¾…å­¸ç”Ÿä½œç­”...</p>';
                    
                    classroomCode = code;

                    currentRole = 'teacher';
                    document.getElementById('end-class-button-text').textContent = `ä¸‹èª² æ•™å®¤ä»£ç¢¼: ${classroomCode}`;
                    document.getElementById('end-class-monitor-button-text').textContent = `ä¸‹èª² æ•™å®¤ä»£ç¢¼: ${classroomCode}`;
                    localStorage.setItem('teacherClassroomCode', classroomCode);

                    // å…ˆæŸ¥è©¢æ˜¯å¦å·²å­˜åœ¨è©² classroomCode
                    let classroomRecord = null;
                    try {
                        const result = await pb.collection('classrooms').getList(1, 1, { filter: `code = "${classroomCode}"` });
                        if (result.items.length > 0) {
                            classroomRecord = result.items[0];
                        }
                    } catch (e) {
                        // ignore, treat as not found
                    }

                    if (!classroomRecord) {
                        // ä¸å­˜åœ¨æ‰å»ºç«‹æ–°æ•™å®¤
                        const initialData = {
                            active_mode: 'waiting',
                            teacher_id: userId,
                            is_paused: false,
                            background_image: '',
                            dispatch_settings: '',
                            multiple_choice_questions: '',
                            peer_review_active: false,
                            preliminary_selection_active: false,
                            preliminary_selected_students: [],
                            app_id: baseAppId,
                            code: classroomCode,
                            last_activity: new Date().toISOString()
                        };
                        classroomRecord = await pb.collection('classrooms').create(initialData);
                    }
                    classroomRecordId = classroomRecord.id;
                    
                    isResponsePaused = false; // Initialize local state
                    updateTeacherPauseButtonUI(); // Update button UI
                    currentMultipleChoiceQuestions = null; // Ensure this is cleared on new class

                    await listenToClassroomPresence(); // Ensure presence listener is active
                    showView('teacherMenu');
                    document.getElementById('teacher-classroom-code-input').value = ''; // Clear input
                    
                    // å•Ÿå‹•æ•™å®¤å›æ”¶åŠŸèƒ½ï¼ˆåƒ…åœ¨æ•™å¸«ç™»å…¥æ™‚å•Ÿå‹•ä¸€æ¬¡ï¼‰
                    if (!cleanupTimerStarted) {
                        console.log('[Teacher] æ•™å¸«ç™»å…¥æˆåŠŸï¼Œå»¶é²5åˆ†é˜å¾Œå•Ÿå‹•æ•™å®¤å›æ”¶åŠŸèƒ½');
                        // å»¶é²5åˆ†é˜å¾Œå•Ÿå‹•æ¸…ç†åŠŸèƒ½ï¼Œé¿å…èª¤åˆªå‰›å‰µå»ºçš„æ•™å®¤
                        setTimeout(() => {
                            console.log('[Teacher] é–‹å§‹å•Ÿå‹•æ•™å®¤å›æ”¶åŠŸèƒ½');
                            startClassroomCleanupTimer();
                        }, 5 * 60 * 1000); // 5åˆ†é˜å»¶é²
                        cleanupTimerStarted = true;
                    }
                    
                } catch (error) {
                    console.error("å»ºç«‹æ•™å®¤å¤±æ•—:", error);
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ•™å®¤ä»£ç¢¼è¡çªéŒ¯èª¤
                    if (error.isClassroomCodeConflict) {
                        showMessage(error.message, "error");
                    } else {
                        showMessage("å»ºç«‹æ•™å®¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
                    }
                }
            });
            
            // Add Enter key support for classroom code input
            document.getElementById('teacher-classroom-code-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('teacher-classroom-code-submit-btn').click();
            });
            
            // Reset generate button when user types manually
            document.getElementById('teacher-classroom-code-input').addEventListener('input', () => {
                const generateBtn = document.getElementById('generate-classroom-code-btn');
                if (generateBtn.textContent.includes('å·²ç”Ÿæˆ')) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ç”Ÿæˆä»£ç¢¼';
                    generateBtn.classList.replace('btn-gray', 'btn-green');
                }
            });
            
            // Generate classroom code button
            document.getElementById('generate-classroom-code-btn').addEventListener('click', async () => {
                const generateBtn = document.getElementById('generate-classroom-code-btn');
                const originalText = generateBtn.textContent;
                
                try {
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'ç”Ÿæˆä¸­...';
                    
                    // Generate a unique 4-digit classroom code
                    const newCode = await generateUniqueClassroomCode();
                    
                    // Set the code in the input field
                    document.getElementById('teacher-classroom-code-input').value = newCode;
                    
                    generateBtn.textContent = 'å·²ç”Ÿæˆ âœ“';
                    generateBtn.classList.replace('btn-green', 'btn-gray');
                    
                    // Auto-submit after generating
                    setTimeout(() => {
                        document.getElementById('teacher-classroom-code-submit-btn').click();
                    }, 500);
                    
                } catch (error) {
                    console.error('ç”Ÿæˆæ•™å®¤ä»£ç¢¼å¤±æ•—:', error);
                    showMessage('ç”Ÿæˆæ•™å®¤ä»£ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                    generateBtn.disabled = false;
                    generateBtn.textContent = originalText;
                }
            });
            
            // Function to generate unique 4-digit classroom code
            async function generateUniqueClassroomCode() {
                let attempts = 0;
                const maxAttempts = 100;
                
                while (attempts < maxAttempts) {
                    // Generate 4-digit code (1000-9999)
                    const code = Math.floor(Math.random() * 9000) + 1000;
                    const codeStr = code.toString();
                    
                    try {
                        // Check if code already exists in database
                        const existingClassrooms = await pb.collection('classrooms').getList(1, 1, {
                            filter: `code = "${codeStr}"`
                        });
                        
                        if (existingClassrooms.items.length === 0) {
                            console.log(`ç”Ÿæˆå”¯ä¸€æ•™å®¤ä»£ç¢¼: ${codeStr}`);
                            return codeStr;
                        }
                        
                        attempts++;
                        console.log(`ä»£ç¢¼ ${codeStr} å·²å­˜åœ¨ï¼Œé‡æ–°ç”Ÿæˆ... (å˜—è©¦ ${attempts}/${maxAttempts})`);
                        
                    } catch (error) {
                        console.error('æª¢æŸ¥ä»£ç¢¼è¡çªæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        attempts++;
                    }
                }
                
                throw new Error('ç„¡æ³•ç”Ÿæˆå”¯ä¸€çš„æ•™å®¤ä»£ç¢¼ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
            
            // Student name and classroom code submission.
            document.getElementById('submit-name-btn').addEventListener('click', async () => {
                const studentClassroomCode = document.getElementById('student-classroom-code-input').value.trim();
                const name = document.getElementById('student-name-input').value.trim();

                if (!studentClassroomCode) {
                    showMessage('è«‹å‹™å¿…è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼', 'error');
                    return;
                }
                if (!name) {
                    showMessage('è«‹å‹™å¿…è¼¸å…¥å§“åï¼', 'error');
                    return;
                }

                classroomCode = studentClassroomCode; // Set global classroom code for student
                
                // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
                showMessage('æ­£åœ¨é€²å…¥æ•™å®¤...', 'info');
                
                // æª¢æŸ¥ç¶²è·¯é€£æ¥
                if (!navigator.onLine) {
                    showMessage('ç¶²è·¯é€£æ¥ç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­ç½®', 'error');
                    return;
                }
                
                // Check if the classroom exists and is active
                try {
                    // æª¢æ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½®ä¸¦é¡¯ç¤ºèª¿è©¦é¢æ¿
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const debugPanel = document.getElementById('mobile-debug');
                    const debugInfo = document.getElementById('debug-info');
                    
                    // æ¸…ç©ºä¹‹å‰çš„èª¿è©¦è³‡è¨Š
                    debugInfo.textContent = '';
                    
                    // é¡¯ç¤ºèª¿è©¦è³‡è¨Šçš„å‡½æ•¸
                    function addDebugInfo(message) {
                        console.log(message); // åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°
                        debugInfo.textContent += message + '\n';
                        if (isMobile) {
                            debugPanel.style.display = 'block';
                        }
                    }
                    
                    addDebugInfo('=== å­¸ç”Ÿç™»å…¥èª¿è©¦è³‡è¨Š ===');
                    addDebugInfo(`æ™‚é–“: ${new Date().toLocaleString()}`);
                    addDebugInfo(`ç€è¦½å™¨: ${navigator.userAgent}`);
                    addDebugInfo(`æ˜¯å¦ç‚ºæ‰‹æ©Ÿ: ${isMobile}`);
                    addDebugInfo(`ç¶²è·¯ç‹€æ…‹: ${navigator.onLine ? 'å·²é€£ç·š' : 'é›¢ç·š'}`);
                    addDebugInfo(`ç•¶å‰URL: ${window.location.href}`);
                    addDebugInfo(`æ•™å®¤ä»£ç¢¼: ${classroomCode}`);
                    addDebugInfo(`å­¸ç”Ÿå§“å: ${name}`);
                    addDebugInfo(`ä½¿ç”¨è€…ID: ${userId}`);
                    addDebugInfo(`PocketBase URL: ${pb.baseUrl}`);
                    addDebugInfo(`å®Œæ•´ API URL: ${pb.baseUrl}/api/collections/classrooms/records`);
                    addDebugInfo('é–‹å§‹æŸ¥è©¢æ•™å®¤...');
                    
                    const classroom = await ClassroomAPI.get(classroomCode);
                    addDebugInfo(`æ•™å®¤æŸ¥è©¢å®Œæˆ`);
                    addDebugInfo(`æŸ¥è©¢çµæœ: ${classroom ? 'æ‰¾åˆ°æ•™å®¤' : 'æœªæ‰¾åˆ°æ•™å®¤'}`);
                    
                    if (classroom) {
                        addDebugInfo(`âœ“ æ•™å®¤å­˜åœ¨`);
                        addDebugInfo(`æ•™å®¤ID: ${classroom.id}`);
                        addDebugInfo(`æ•™å®¤ä»£ç¢¼: ${classroom.code}`);
                        addDebugInfo(`APP ID: ${classroom.app_id}`);
                        addDebugInfo(`æ•™å¸«ID: ${classroom.teacher_id}`);
                        addDebugInfo(`æ´»å‹•æ¨¡å¼: ${classroom.active_mode}`);
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰åŒåå­¸ç”Ÿå·²åœ¨ç·š
                        addDebugInfo('é–‹å§‹æª¢æŸ¥å§“åé‡è¤‡...');
                        try {
                            const existingStudents = await pb.collection('student_presence').getFullList({
                                filter: `classroom_code = "${classroomCode}" && student_name = "${name}"`
                            });
                            
                            if (existingStudents.length > 0) {
                                // æª¢æŸ¥æ˜¯å¦æ˜¯åŒä¸€å€‹ç”¨æˆ¶ï¼ˆåŒä¸€å€‹ user_idï¼‰
                                const sameUser = existingStudents.find(student => student.user_id === userId);
                                if (sameUser) {
                                    addDebugInfo('âœ“ åŒä¸€ç”¨æˆ¶é‡æ–°ç™»å…¥ï¼Œå…è¨±é€²å…¥');
                                } else {
                                    addDebugInfo(`âœ— å§“åé‡è¤‡ï¼š${name} å·²è¢«å…¶ä»–å­¸ç”Ÿä½¿ç”¨`);
                                    showMessage(`å§“åã€Œ${name}ã€å·²è¢«ç­ä¸Šå…¶ä»–åŒå­¸ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„å§“åï¼`, 'error');
                                    return;
                                }
                            } else {
                                addDebugInfo('âœ“ å§“åæª¢æŸ¥é€šéï¼Œç„¡é‡è¤‡');
                            }
                        } catch (nameCheckError) {
                            addDebugInfo(`âš  å§“åæª¢æŸ¥å¤±æ•—: ${nameCheckError.message}ï¼Œç¹¼çºŒç™»å…¥æµç¨‹`);
                            console.warn('[Student] Name duplicate check failed:', nameCheckError);
                            // ä¸é˜»æ­¢ç™»å…¥æµç¨‹ï¼Œä½†è¨˜éŒ„è­¦å‘Š
                        }
                        
                        // å„²å­˜æ•™å®¤è¨˜éŒ„ID
                        classroomRecordId = classroom.id;
                        
                        studentName = name;
                        document.getElementById('user-id-display').textContent = `${userId} (${studentName})`;
                        document.getElementById('student-welcome-msg').textContent = `ä½ å¥½ï¼Œ${studentName}ï¼`;
                        
                        // è¨­ç½®å­¸ç”Ÿåœ¨ç·šç‹€æ…‹
                        addDebugInfo('é–‹å§‹è¨­ç½®åœ¨ç·šç‹€æ…‹...');
                        try {
                            // å…ˆå˜—è©¦ç™»è¨˜åœ¨ç·šç‹€æ…‹
                            await StudentPresenceAPI.upsert(classroomCode, userId, studentName);
                            addDebugInfo('âœ“ åœ¨ç·šç‹€æ…‹è¨­ç½®å®Œæˆ');
                            
                            // é¡å¤–é©—è­‰ï¼šå†æ¬¡æª¢æŸ¥æ˜¯å¦æˆåŠŸç™»è¨˜
                            await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…500msç¢ºä¿æ•¸æ“šå·²åŒæ­¥
                            const verifyRecords = await pb.collection('student_presence').getFullList({
                                filter: `classroom_code = "${classroomCode}" && user_id = "${userId}"`
                            });
                            if (verifyRecords.length > 0) {
                                addDebugInfo(`âœ“ åœ¨ç·šç‹€æ…‹é©—è­‰æˆåŠŸ: ${verifyRecords[0].student_name}`);
                            } else {
                                addDebugInfo('âš  åœ¨ç·šç‹€æ…‹é©—è­‰å¤±æ•—ï¼Œå°‡é‡è©¦...');
                                // é‡è©¦ä¸€æ¬¡
                                await StudentPresenceAPI.upsert(classroomCode, userId, studentName);
                                addDebugInfo('âœ“ åœ¨ç·šç‹€æ…‹é‡è©¦å®Œæˆ');
                            }
                        } catch (presenceError) {
                            addDebugInfo(`âœ— è¨­ç½®åœ¨ç·šç‹€æ…‹å¤±æ•—: ${presenceError.message}`);
                            // ä¸é˜»æ­¢ç™»å…¥æµç¨‹ï¼Œä½†è¨˜éŒ„éŒ¯èª¤
                            console.error('[Student] Presence setup failed:', presenceError);
                        }
                        
                        // é–‹å§‹ç›£è½
                        addDebugInfo('é–‹å§‹è¨­ç½®ç›£è½å™¨...');
                        try {
                            listenToInteractionMode();
                            listenToPeerReviewStatus();
                            addDebugInfo('âœ“ ç›£è½å™¨è¨­ç½®å®Œæˆ');
                        } catch (listenError) {
                            addDebugInfo(`âœ— ç›£è½å™¨è¨­ç½®å¤±æ•—: ${listenError.message}`);
                        }
                        
                        showView('studentWaiting');
                        showMessage(`æ­¡è¿ ${studentName}ï¼å·²æˆåŠŸé€²å…¥æ•™å®¤ ${classroomCode}`, 'success');
                        addDebugInfo('=== ç™»å…¥æˆåŠŸ ===');
                    } else {
                        addDebugInfo('âœ— æ•™å®¤ä¸å­˜åœ¨æˆ–æŸ¥è©¢çµæœç‚ºç©º');
                        showMessage('æ•™å®¤ä»£ç¢¼ä¸å­˜åœ¨æˆ–è€å¸«å°šæœªé–‹å•Ÿæ•™å®¤ï¼è«‹ç¢ºèªæ•™å®¤ä»£ç¢¼æ˜¯å¦æ­£ç¢ºã€‚', 'error');
                    }
                } catch (error) {
                    const debugPanel = document.getElementById('mobile-debug');
                    const debugInfo = document.getElementById('debug-info');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    function addErrorInfo(message) {
                        console.error(message);
                        debugInfo.textContent += message + '\n';
                        if (isMobile) {
                            debugPanel.style.display = 'block';
                        }
                    }
                    
                    addErrorInfo("=== ç™»å…¥å¤±æ•—è©³ç´°éŒ¯èª¤ ===");
                    addErrorInfo(`éŒ¯èª¤ç‰©ä»¶: ${error}`);
                    addErrorInfo(`éŒ¯èª¤é¡å‹: ${typeof error}`);
                    addErrorInfo(`éŒ¯èª¤å»ºæ§‹å­: ${error.constructor.name}`);
                    addErrorInfo(`éŒ¯èª¤è¨Šæ¯: ${error.message}`);
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰å›æ‡‰ç‰©ä»¶
                    if (error.response) {
                        addErrorInfo(`HTTP ç‹€æ…‹ç¢¼: ${error.response.status}`);
                        addErrorInfo(`HTTP ç‹€æ…‹æ–‡å­—: ${error.response.statusText}`);
                        if (error.response.data) {
                            addErrorInfo(`å›æ‡‰è³‡æ–™: ${JSON.stringify(error.response.data)}`);
                        }
                    }
                    
                    // æª¢æŸ¥ç¶²è·¯ç›¸é—œéŒ¯èª¤
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        addErrorInfo("åˆ¤æ–·: é€™æ˜¯ç¶²è·¯é€£æ¥éŒ¯èª¤");
                    }
                    
                    // æä¾›æ›´å…·é«”çš„éŒ¯èª¤è¨Šæ¯
                    let errorMessage = "é€²å…¥æ•™å®¤å¤±æ•—";
                    
                    if (error.message && error.message.includes('Failed to fetch')) {
                        errorMessage = "ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ï¼š\n1. ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸\n2. ä¼ºæœå™¨æ˜¯å¦æ­£åœ¨é‹è¡Œ\n3. URLå’ŒåŸ è™Ÿæ˜¯å¦æ­£ç¢º";
                    } else if (error.response) {
                        switch (error.response.status) {
                            case 404:
                                errorMessage = "æ‰¾ä¸åˆ°è©²æ•™å®¤ï¼Œè«‹ç¢ºèªæ•™å®¤ä»£ç¢¼æ˜¯å¦æ­£ç¢º";
                                break;
                            case 400:
                                errorMessage = "è«‹æ±‚æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦";
                                break;
                            case 403:
                                errorMessage = "æ²’æœ‰æ¬Šé™è¨ªå•è©²æ•™å®¤";
                                break;
                            case 500:
                                errorMessage = "ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
                                break;
                            default:
                                errorMessage = `ä¼ºæœå™¨éŒ¯èª¤ (${error.response.status}): ${error.response.statusText}`;
                        }
                    } else if (error.name === 'NetworkError') {
                        errorMessage = "ç¶²è·¯é€£æ¥å•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­ç½®";
                    } else if (error.message) {
                        errorMessage = `éŒ¯èª¤ï¼š${error.message}`;
                    }
                    
                    showMessage(errorMessage, "error");
                    addErrorInfo(`é¡¯ç¤ºçµ¦ä½¿ç”¨è€…çš„éŒ¯èª¤è¨Šæ¯: ${errorMessage}`);
                }
            });
            
            // ç‚ºå­¸ç”Ÿå§“åè¼¸å…¥æ¡†æ·»åŠ Enteréµæ”¯æŒ
            document.getElementById('student-name-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('submit-name-btn').click();
                }
            });
            
            // ç‚ºå­¸ç”Ÿæ•™å®¤ä»£ç¢¼è¼¸å…¥æ¡†æ·»åŠ Enteréµæ”¯æŒ
            document.getElementById('student-classroom-code-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // å¦‚æœæ•™å®¤ä»£ç¢¼å·²å¡«å…¥ï¼Œè·³åˆ°å§“åè¼¸å…¥æ¡†
                    if (e.target.value.trim()) {
                        document.getElementById('student-name-input').focus();
                    }
                }
            });

            // Teacher mode selection.
            // MODIFIED: Multiple Choice button now opens a modal
            document.getElementById('multiple-choice-settings-btn').addEventListener('click', () => {
                // æª¢æŸ¥åœ¨ç·šå­¸ç”Ÿæ•¸
                const activeStudentCount = parseInt(document.getElementById('active-student-count').textContent) || 0;
                if (activeStudentCount === 0) {
                    showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿåœ¨ç·šï¼Œç„¡æ³•é–‹å§‹äº’å‹•ï¼è«‹ç­‰å¾…å­¸ç”ŸåŠ å…¥å¾Œå†è©¦ã€‚', 'warning');
                    return;
                }
                
                // Initialize modal state based on current customMultipleChoiceQuestions
                const mcQuestionTypeNone = document.querySelector('input[name="mcQuestionType"][value="none"]');
                const mcQuestionTypeCustom = document.querySelector('input[name="mcQuestionType"][value="custom"]');
                const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
                const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
                const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');

                if (customMultipleChoiceQuestions && customMultipleChoiceQuestions.length > 0) {
                    mcQuestionTypeCustom.checked = true;
                    customMcQuestionsSection.classList.remove('hidden');
                    document.getElementById('question-bank-management-section').classList.remove('hidden');
                    // Reconstruct textarea content from customMultipleChoiceQuestions
                    customMcQuestionsTextarea.value = customMultipleChoiceQuestions.map(q =>
                        `${q.questionText},${q.correctAnswer},${q.options.join(',')}`
                    ).join('\n');
                } else {
                    mcQuestionTypeNone.checked = true;
                    customMcQuestionsSection.classList.add('hidden');
                    document.getElementById('question-bank-management-section').classList.add('hidden');
                    customMcQuestionsTextarea.value = '';
                }
                customMcQuestionsStatus.classList.add('hidden'); // Hide status on open
                multipleChoiceSettingsModal.classList.remove('hidden');
            });

            // Other teacher mode selection buttons (unchanged, directly set mode)
            document.querySelectorAll('#teacher-menu-view button[data-mode]:not(#multiple-choice-settings-btn)').forEach(button => {
                button.addEventListener('click', async () => {
                    // æª¢æŸ¥åœ¨ç·šå­¸ç”Ÿæ•¸
                    const activeStudentCount = parseInt(document.getElementById('active-student-count').textContent) || 0;
                    if (activeStudentCount === 0) {
                        showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿåœ¨ç·šï¼Œç„¡æ³•é–‹å§‹äº’å‹•ï¼è«‹ç­‰å¾…å­¸ç”ŸåŠ å…¥å¾Œå†è©¦ã€‚', 'warning');
                        return;
                    }
                    
                    const mode = button.dataset.mode;
                    // MODIFIED: Check dispatch settings for url_dispatch
                    if (mode === 'url_dispatch') {
                        if (dispatchSettings.type === 'url' && !dispatchSettings.url) {
                            showMessage('è«‹å…ˆè¨­å®šè¦æ´¾é€çš„ç¶²å€ï¼', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        } else if (dispatchSettings.type === 'html' && !dispatchSettings.htmlContent) {
                            showMessage('è«‹å…ˆä¸Šå‚³è¦æ´¾é€çš„ HTML æª”æ¡ˆï¼', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        }
                    }
                    showView('teacherMonitor');
                    await setInteractionMode(mode); // Set mode and handle student responses listener
                });
            });

            // End interaction button.
            document.getElementById('end-interaction-btn').addEventListener('click', async () => {
                // NEW: Clear peer review data when ending interaction (not just stopping)
                try {
                    // Clear peer review settings - set active to false
                    await PeerReviewAPI.setActive(classroomCode, false);
                    
                    // Clear all votes - THIS IS THE KEY DIFFERENCE FROM STOPPING
                    await PeerReviewAPI.clearAllVotes(classroomCode);
                    
                    peerReviewActive = false;
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    // Reset peer review button text
                    const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> é–‹å§‹äº’è©• â¤ï¸';
                    
                    // Clear student voted works
                    allPeerReviewVotes = {};
                    studentVotedWorks.clear();
                    
                    // Clear saved canvas state
                    savedCanvasState = null;
                    
                    // Clear peer review subscriptions with proper type checking
                    if (peerReviewUnsubscribe && typeof peerReviewUnsubscribe === 'function') {
                        try {
                            peerReviewUnsubscribe();
                        } catch (error) {
                            // Failed to unsubscribe
                        }
                        peerReviewUnsubscribe = null;
                    }
                    if (peerReviewStatusUnsubscribe && typeof peerReviewStatusUnsubscribe === 'function') {
                        try {
                            peerReviewStatusUnsubscribe();
                        } catch (error) {
                            // Failed to unsubscribe
                        }
                        peerReviewStatusUnsubscribe = null;
                    }
                } catch (error) {
                    console.error('Error clearing peer review data:', error);
                }
                
                await setInteractionMode('waiting'); 
                lastSelectedStudentCard = null;
                showView('teacherMenu');
                manualRefreshCounts(); // This will refresh the count display, but the listener is already active.
                // Clear URL/HTML settings and teacher background image when ending interaction
                clearDispatchSettings(); // Use the combined clear function
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = 'ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚å¯é¸æ“‡æª”æ¡ˆæˆ–ç›´æ¥è²¼ä¸Š(Ctrl+V)ã€‚';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false; // NEW: Reset pause state
                updateTeacherPauseButtonUI(); // NEW: Update pause button UI
                customMultipleChoiceQuestions = []; // NEW: Clear custom MC questions on end interaction
            });
            
            // Student answer buttons for default multiple choice.
            document.querySelectorAll('#interaction-true-false .answer-btn, #default-mc-options .answer-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    // NEW: Check pause state before submitting
                    if (isResponsePaused) {
                        showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                        return;
                    }
                    
                    // åœ¨ç•°æ­¥æ“ä½œå‰ä¿å­˜éœ€è¦çš„å…ƒç´ å¼•ç”¨
                    const currentButton = e.currentTarget;
                    const answer = currentButton.dataset.answer;
                    const parentDiv = currentButton.closest('div');
                    
                    // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                    if (!currentButton || !parentDiv) {
                        console.error('Button elements not found');
                        return;
                    }
                    
                    await submitAnswer(answer);
                    
                    // ä½¿ç”¨ä¿å­˜çš„å¼•ç”¨æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ - æ‰€æœ‰æŒ‰éˆ•éƒ½æ‡‰è©²è¢«ç¦ç”¨
                    parentDiv.querySelectorAll('.answer-btn').forEach(b => {
                        b.disabled = true;
                        // çµ±ä¸€çš„ç¦ç”¨æ¨£å¼
                        b.classList.add('opacity-50', 'cursor-not-allowed');
                        b.classList.remove('hover:scale-110', 'hover:bg-blue-600', 'hover:bg-yellow-600', 'hover:bg-green-600', 'hover:bg-red-600');
                        // æ¨™è¨˜ç‚ºå·²æäº¤ï¼Œé˜²æ­¢è¢«å…¶ä»–é‚è¼¯é‡æ–°å•Ÿç”¨
                        b.setAttribute('data-submitted', 'true');
                    });
                    // å°‡é¸ä¸­çš„æŒ‰éˆ•æ¨™è¨˜ç‚ºå·²é¸ä¸­ï¼ˆæ¢å¾©åŸè‰²ä¸¦æ·»åŠ é‚Šæ¡†ï¼‰
                    currentButton.classList.remove('opacity-50');
                    currentButton.classList.add('ring-4', 'ring-yellow-400', 'ring-opacity-75');
                });
            });

            // Text input submission.
            const submitTextBtn = document.getElementById('submit-text-btn');
            if (submitTextBtn) {
                submitTextBtn.addEventListener('click', async (e) => {
                    // NEW: Check pause state before submitting
                    if (isResponsePaused) {
                        showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                        return;
                    }
                    
                    // NEW: Check if already submitted (button state)
                    if (e.currentTarget && (e.currentTarget.disabled || 
                        e.currentTarget.textContent.includes('å·²é€å‡º') || 
                        e.currentTarget.textContent.includes('âœ“') ||
                        e.currentTarget.hasAttribute('data-submitted'))) {
                        showMessage('æ‚¨å·²ç¶“æäº¤éç­”æ¡ˆäº†ï¼', 'warning');
                        return;
                    }
                    
                    const text = document.getElementById('text-input-area').value;
                    if (!text.trim()) {
                        showMessage('è«‹è¼¸å…¥å›ç­”å…§å®¹ã€‚', 'warning');
                        return;
                    }
                    
                    // Disable button immediately to prevent double submission
                    if (e.currentTarget) {
                        e.currentTarget.disabled = true;
                        e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                        e.currentTarget.textContent = 'é€å‡ºä¸­...';
                        e.currentTarget.setAttribute('data-submitted', 'true'); // ç«‹å³æ¨™è¨˜ç‚ºå·²æäº¤
                    }
                    
                    try {
                        await submitAnswer(text);
                        // Update button to show submitted state
                        if (e.currentTarget) {
                            e.currentTarget.textContent = 'å·²é€å‡º âœ“';
                        }
                    } catch (error) {
                        // Re-enable button if submission failed
                        if (e.currentTarget) {
                            e.currentTarget.disabled = false;
                            e.currentTarget.classList.replace('btn-gray', 'btn-primary');
                            e.currentTarget.textContent = 'é€å‡ºå›ç­” âœ‰ï¸';
                            e.currentTarget.removeAttribute('data-submitted'); // ç§»é™¤æäº¤æ¨™è¨˜
                        }
                        console.error('æ–‡å­—é¡Œæäº¤å¤±æ•—:', error);
                        // submitAnswer æœƒé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œé€™è£¡ä¸éœ€è¦å†é¡¯ç¤º
                    }
                });
            }
            
            // Drawing submission.
            document.getElementById('submit-drawing-btn').addEventListener('click', async (e) => {
                e.preventDefault(); // é˜²æ­¢é»˜èªè¡Œç‚º
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                
                const button = e.currentTarget;
                
                // æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦å­˜åœ¨
                if (!button) {
                    console.warn('[Drawing] Button element is null, ignoring click');
                    return;
                }
                
                // æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦å·²ç¶“ç¦ç”¨æˆ–å·²é€å‡º
                if (button.disabled || button.textContent.includes('å·²é€å‡º') || button.textContent.includes('é€å‡ºä¸­')) {
                    console.log('[Drawing] Button already disabled or submitted, ignoring click');
                    return;
                }
                
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                    return;
                }

                const originalText = button.textContent;

                try {
                    // ç«‹å³ç¦ç”¨é€å‡ºæŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    button.disabled = true;
                    button.classList.add('pointer-events-none'); // é¡å¤–ç¦ç”¨é»æ“Š
                    button.textContent = 'é€å‡ºä¸­...';

                    console.log('[Drawing] Starting submission...');

                    // --- Patch: Export with grid if enabled ---
                    const exportCanvas = document.createElement('canvas');
                    exportCanvas.width = canvas.width;
                    exportCanvas.height = canvas.height;
                    const exportCtx = exportCanvas.getContext('2d');


                    // Draw white background
                    exportCtx.fillStyle = 'white';
                    exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

                    // Draw teacher background image if present
                    if (teacherUploadedBackgroundImageDataURL) {
                        const tempImg = new Image();
                        await new Promise((resolve) => {
                            tempImg.onload = () => {
                                const canvasRatio = exportCanvas.width / exportCanvas.height;
                                const imgRatio = tempImg.width / tempImg.height;
                                let drawWidth, drawHeight, offsetX, offsetY;
                                if (imgRatio > canvasRatio) {
                                    drawHeight = exportCanvas.width / imgRatio;
                                    drawWidth = exportCanvas.width;
                                    offsetY = (exportCanvas.height - drawHeight) / 2;
                                    offsetX = 0;
                                } else {
                                    drawWidth = exportCanvas.height * imgRatio;
                                    drawHeight = exportCanvas.height;
                                    offsetX = (exportCanvas.width - drawWidth) / 2;
                                    offsetY = 0;
                                }
                                exportCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                                resolve();
                            };
                            tempImg.src = teacherUploadedBackgroundImageDataURL;
                        });
                    }

                    // Draw grid if enabled (read from checkbox directly for reliability)
                    const gridCheckbox = document.getElementById('toggle-grid-checkbox');
                    const gridEnabled = gridCheckbox && gridCheckbox.checked;
                    if (gridEnabled) {
                        const gridSpacing = 40; // px
                        exportCtx.save();
                        exportCtx.strokeStyle = '#e5e7eb';
                        exportCtx.lineWidth = 1;
                        for (let x = gridSpacing; x < exportCanvas.width; x += gridSpacing) {
                            exportCtx.beginPath();
                            exportCtx.moveTo(x, 0);
                            exportCtx.lineTo(x, exportCanvas.height);
                            exportCtx.stroke();
                        }
                        for (let y = gridSpacing; y < exportCanvas.height; y += gridSpacing) {
                            exportCtx.beginPath();
                            exportCtx.moveTo(0, y);
                            exportCtx.lineTo(exportCanvas.width, y);
                            exportCtx.stroke();
                        }
                        exportCtx.restore();
                    }

                    // Draw student uploaded image if present
                    if (studentUploadedImageDataURL) {
                        const tempImg = new Image();
                        await new Promise((resolve) => {
                            tempImg.onload = () => {
                                const canvasRatio = exportCanvas.width / exportCanvas.height;
                                const imgRatio = tempImg.width / tempImg.height;
                                let drawWidth, drawHeight, offsetX, offsetY;
                                if (imgRatio > canvasRatio) {
                                    drawHeight = exportCanvas.width / imgRatio;
                                    drawWidth = exportCanvas.width;
                                    offsetY = (exportCanvas.height - drawHeight) / 2;
                                    offsetX = 0;
                                } else {
                                    drawWidth = exportCanvas.height * imgRatio;
                                    drawHeight = exportCanvas.height;
                                    offsetX = (exportCanvas.width - drawWidth) / 2;
                                    offsetY = 0;
                                }
                                exportCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                                resolve();
                            };
                            tempImg.src = studentUploadedImageDataURL;
                        });
                    }

                    // Draw drawing strokes
                    exportCtx.drawImage(drawingCanvas, 0, 0);

                    // Export as PNG (lossless, grid lines preserved)
                    const dataUrl = exportCanvas.toDataURL('image/png');
                    await submitAnswer(dataUrl);

                                        // æˆåŠŸå¾Œç¦ç”¨æ‰€æœ‰ç¹ªåœ–äº’å‹•ï¼ˆç•«å¸ƒã€å·¥å…·ã€ä¸Šå‚³ã€æ¸…é™¤ç­‰ï¼‰
                                        const drawingTools = [
                                            'drawing-canvas',
                                            'pen-tool-btn',
                                            'eraser-btn',
                                            'clear-canvas-btn',
                                            'color-select',
                                            'size-select',
                                            'toggle-grid-checkbox',
                                            'student-image-upload-input',
                                            'clear-student-image-btn'
                                        ];
                                        drawingTools.forEach(id => {
                                            const el = document.getElementById(id);
                                            if (el) {
                                                el.disabled = true;
                                                el.style.pointerEvents = 'none';
                                                el.classList.add('opacity-50');
                                            }
                                        });
                                        button.classList.replace('btn-primary', 'btn-gray');
                                        button.textContent = 'å·²é€å‡º âœ“';
                                        console.log('[Drawing] Submission completed successfully');
                } catch (error) {
                    // å¤±æ•—å¾Œæ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    button.disabled = false;
                    button.classList.remove('pointer-events-none');
                    button.textContent = originalText;
                    console.error('Drawing submission failed:', error);
                }
            });

            // Drawing board events.
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            window.addEventListener('resize', () => {
                if (!views.studentInteraction.classList.contains('hidden') && !interactionUIs.drawing.classList.contains('hidden')) {
                    setupCanvas();
                    loadBackgroundImage();
                    loadStudentImage();
                }
            });

            // Drawing tool controls.
            const colorSelect = document.getElementById('color-select');
            const sizeSelect = document.getElementById('size-select');
            const penToolBtn = document.getElementById('pen-tool-btn');
            const eraserBtn = document.getElementById('eraser-btn');
            colorSelect.addEventListener('change', (e) => {
                drawingCtx.strokeStyle = e.target.value; 
                drawingCtx.globalCompositeOperation = 'source-over'; 
                updateColorSwatch(e.target.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500');
            });
            sizeSelect.addEventListener('change', (e) => { drawingCtx.lineWidth = parseInt(e.target.value); });
            penToolBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'source-over'; 
                drawingCtx.strokeStyle = colorSelect.value; 
                drawingCtx.lineWidth = parseInt(sizeSelect.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500'); 
            });
            eraserBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'destination-out';
                drawingCtx.lineWidth = 15;
                penToolBtn.classList.remove('border-blue-500'); 
                eraserBtn.classList.add('border-blue-500'); 
            });
            document.getElementById('clear-canvas-btn').addEventListener('click', clearDrawingCanvas);
            
            // Image upload handlers (teacher and student).
            setupImageUpload('teacher-image-upload-input', 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview', 'clear-teacher-background-btn', true);
            setupImageUpload('student-image-upload-input', null, null, null, 'clear-student-image-btn', false);

            // NEW: Paste event listener for teacher background image
            document.addEventListener('paste', e => {
                // Only allow pasting when the teacher menu is visible
                if (views.teacherMenu.classList.contains('hidden')) {
                    return;
                }
                
                // Don't interfere if the user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            // Call the specific teacher image handler
                            handleImageFileForTeacher(file, 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview');
                            e.preventDefault(); // Prevent the image from being pasted as a file object
                            return; // Exit after handling the first image
                        }
                    }
                }
            });

            // Modal close buttons.
            document.getElementById('student-status-area').addEventListener('click', showStudentListModal);
            studentListModalCloseBtn.addEventListener('click', hideStudentListModal);
            document.getElementById('show-statistics-btn').addEventListener('click', showStatisticsModal);
            
            // QR Code æŒ‰éˆ•äº‹ä»¶
            document.getElementById('qr-code-btn').addEventListener('click', () => {
                if (classroomCode) {
                    // è¤‡è£½ QR code ç•«é¢åˆ°å…¨è¢å¹• canvas
                    const srcCanvas = document.getElementById('qr-code-canvas');
                    const destCanvas = document.getElementById('qr-code-canvas-fullscreen');
                    if (srcCanvas && destCanvas) {
                        const ctx = destCanvas.getContext('2d');
                        ctx.clearRect(0, 0, destCanvas.width, destCanvas.height);
                        ctx.imageSmoothingEnabled = false;
                        ctx.drawImage(srcCanvas, 0, 0, destCanvas.width, destCanvas.height);
                    }
                    document.getElementById('qr-classroom-code-fullscreen').textContent = classroomCode;
                    document.getElementById('qr-code-fullscreen-modal').classList.remove('hidden');
                } else {
                    showMessage('è«‹å…ˆå»ºç«‹æ•™å®¤ï¼', 'warning');
                }
            });

            // é—œé–‰ QR code å…¨è¢å¹•
            document.getElementById('close-qr-fullscreen-btn').addEventListener('click', () => {
                document.getElementById('qr-code-fullscreen-modal').classList.add('hidden');
            });
            
            // NEW: View Questions Button
            document.getElementById('view-questions-btn').addEventListener('click', showViewQuestionsModal);
            document.getElementById('view-questions-modal-close-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('cancel-questions-view-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('save-correct-answers-btn').addEventListener('click', saveCorrectAnswers);
            
            // NEW: Download Responses Button
            document.getElementById('download-responses-btn').addEventListener('click', downloadStudentResponses);
            
            // NEW: Start Peer Review Button
            document.getElementById('start-peer-review-btn').addEventListener('click', startPeerReview);
            
            // NEW: Preliminary Selection Buttons
            document.getElementById('start-preliminary-selection-btn').addEventListener('click', showPreliminarySelectionModal);
            
            // NEW: Exit Peer Review Button (Student)
            document.getElementById('exit-peer-review-btn').addEventListener('click', exitPeerReview);
            chartModalCloseBtn.addEventListener('click', hideStatisticsModal);
            magnifiedImageModalCloseBtn.addEventListener('click', hideMagnifiedDrawing);
            magnifiedImageModal.addEventListener('click', (e) => { if (e.target === magnifiedImageModal) hideMagnifiedDrawing(); });
            document.getElementById('close-message-btn').addEventListener('click', hideMessage);

            // NEW: Unsubmitted Students Modal Listeners
            document.getElementById('show-unsubmitted-students-btn').addEventListener('click', showUnsubmittedStudentsModal);
            unsubmittedStudentsModalCloseBtn.addEventListener('click', hideUnsubmittedStudentsModal);
            unsubmittedStudentsModal.addEventListener('click', (e) => { if (e.target === unsubmittedStudentsModal) hideUnsubmittedStudentsModal(); });

            // NEW: Preliminary Selection Modal Listeners
            const preliminarySelectionModal = document.getElementById('preliminary-selection-modal');
            const preliminarySelectionModalCloseBtn = document.getElementById('preliminary-selection-modal-close-btn');
            preliminarySelectionModalCloseBtn.addEventListener('click', hidePreliminarySelectionModal);
            preliminarySelectionModal.addEventListener('click', (e) => { if (e.target === preliminarySelectionModal) hidePreliminarySelectionModal(); });
            document.getElementById('confirm-preliminary-selection-btn').addEventListener('click', confirmPreliminarySelection);
            document.getElementById('cancel-preliminary-selection-btn').addEventListener('click', hidePreliminarySelectionModal);

            // NEW: Quick Answer Control Buttons
            document.getElementById('restart-quick-answer-btn').addEventListener('click', async () => {
                console.log('[Teacher] Restarting quick answer...');
                
                try {
                    // Clear local state first
                    quickAnswerActive = false;
                    quickAnswerWinner = null;
                    quickAnswerWinnerDisplayed = false;
                    
                    // Clear teacher side winner display
                    const winnerDisplay = document.getElementById('quick-answer-winner-display');
                    const restartBtn = document.getElementById('restart-quick-answer-btn');
                    if (winnerDisplay) winnerDisplay.classList.add('hidden');
                    if (restartBtn) restartBtn.classList.add('hidden');
                    
                    // First clear all student responses to reset student state
                    await StudentResponseAPI.deleteByClassroom(classroomCode);
                    console.log('[Teacher] Cleared all student responses for restart');
                    
                    // Wait a moment to ensure responses are cleared
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Now start new quick answer on teacher side
                    startQuickAnswer();
                    showMessage('å·²é‡æ–°é–‹å§‹æ¶ç­”ï¼', 'success');
                    
                } catch (error) {
                    console.error('[Teacher] Error restarting quick answer:', error);
                    showMessage('é‡æ–°é–‹å§‹æ¶ç­”å¤±æ•—ï¼', 'error');
                }
            });


            // Teacher utility buttons.
            document.getElementById('refresh-student-count-btn').addEventListener('click', manualRefreshCounts);
            // Original lottery button in monitor view (now replaced by modal one)
            document.getElementById('draw-lottery-btn').addEventListener('click', () => {
                if (allStudentResponses.length === 0) return showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿæäº¤ç­”æ¡ˆå¯ä¾›æŠ½ç±¤ã€‚', 'info');
                if (lastSelectedStudentCard) lastSelectedStudentCard.classList.remove('selected-student-border');
                const randomIndex = Math.floor(Math.random() * allStudentResponses.length);
                const selectedStudentName = allStudentResponses[randomIndex].name;
                const studentCards = document.querySelectorAll('#student-responses-container .student-response-item');
                const foundCard = Array.from(studentCards).find(card => card.querySelector('.name-box').textContent === selectedStudentName);
                if (foundCard) {
                    foundCard.classList.add('selected-student-border');
                    lastSelectedStudentCard = foundCard;
                    showMessage(`æ­å–œï¼æŠ½ä¸­å­¸ç”Ÿï¼š${selectedStudentName}`, 'success');
                }
            });
            // NEW: Lottery button inside the student list modal
            document.getElementById('modal-draw-lottery-btn').addEventListener('click', () => {
                if (activeStudentNames.length === 0) {
                    return showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿåœ¨ç·šå¯ä¾›æŠ½ç±¤ã€‚', 'info');
                }

                // Remove highlight from previously selected student in the modal
                if (lastSelectedModalStudent) {
                    lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                }

                // Randomly select a student from all active online students
                const randomIndex = Math.floor(Math.random() * activeStudentNames.length);
                const selectedStudentName = activeStudentNames[randomIndex];

                // Find the corresponding <p> element in the modal
                const studentNameElements = document.querySelectorAll('#modal-student-names p');
                const foundElement = Array.from(studentNameElements).find(p => p.textContent === selectedStudentName);

                if (foundElement) {
                    foundElement.classList.add('modal-selected-student-border');
                    lastSelectedModalStudent = foundElement; // Store the currently selected element
                    showMessage(`æ­å–œï¼æŠ½ä¸­å­¸ç”Ÿï¼š${selectedStudentName}`, 'success');
                } else {
                    // This case should ideally not happen if activeStudentNames is correctly populated
                    // and the modal list is correctly rendered.
                    showMessage(`æŠ½ä¸­å­¸ç”Ÿï¼š${selectedStudentName} (æœªåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°)`, 'info');
                }
            });


            document.getElementById('download-media-btn').addEventListener('click', async (e) => { // Changed ID
                const btn = e.currentTarget;
                if (btn.disabled) return;
                
                let mediaResponses = [];
                let filenamePrefix = '';
                let fileExtension = '';

                if (currentInteractionMode === 'drawing') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:image'));
                    filenamePrefix = 'å­¸ç”Ÿç¹ªåœ–ç­”æ¡ˆ';
                    fileExtension = 'jpg';
                } else if (currentInteractionMode === 'recording') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:audio'));
                    filenamePrefix = 'å­¸ç”ŸéŒ„éŸ³ç­”æ¡ˆ';
                    // Determine file extension based on the actual mimeType used for recording
                    const firstAudioResponse = mediaResponses.find(r => r.answer);
                    if (firstAudioResponse) {
                        const mime = firstAudioResponse.answer.split(',')[0].match(/:(.*?);/)?.[1];
                        if (mime) {
                            if (mime.includes('webm')) fileExtension = 'webm';
                            else if (mime.includes('mp4')) fileExtension = 'mp4';
                            else if (mime.includes('ogg')) fileExtension = 'ogg';
                            else if (mime.includes('wav')) fileExtension = 'wav';
                            else fileExtension = 'bin'; // Fallback for unknown
                        } else {
                            fileExtension = 'bin'; // Fallback if mime type not found in data URL
                        }
                    } else {
                        fileExtension = 'webm'; // Default if no audio responses
                    }
                } else {
                    return showMessage('ç›®å‰æ¨¡å¼ä¸æ”¯æ´ä¸‹è¼‰åª’é«”ã€‚', 'info');
                }

                if (mediaResponses.length === 0) return showMessage(`ç›®å‰æ²’æœ‰${filenamePrefix}å¯ä¾›ä¸‹è¼‰ã€‚`, 'info');
                
                btn.disabled = true;
                showMessage(`æ­£åœ¨æ‰“åŒ…${filenamePrefix}...`, 'info');
                const zip = new JSZip();
                const dataURLToBlob = (dataurl) => {
                    const [header, body] = dataurl.split(',');
                    const mime = header.match(/:(.*?);/)[1];
                    const bstr = atob(body);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while(n--) u8arr[n] = bstr.charCodeAt(n);
                    return new Blob([u8arr], {type:mime});
                };
                
                mediaResponses.forEach(r => {
                    // Ensure unique filenames for students with same name but different recordings if needed
                    // For now, just use student name.
                    zip.file(`${r.name}.${fileExtension}`, dataURLToBlob(r.answer));
                });

                try {
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, `${filenamePrefix}_${new Date().toLocaleDateString('zh-TW')}.zip`);
                    showMessage(`å·²æˆåŠŸæ‰“åŒ… ${mediaResponses.length} å€‹æª”æ¡ˆä¸¦é–‹å§‹ä¸‹è¼‰ã€‚`, 'success');
                } catch (error) {
                    console.error("æ‰“åŒ…åª’é«”å¤±æ•—:", error);
                    showMessage("æ‰“åŒ…åª’é«”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ”¯æ´æˆ–æª”æ¡ˆå¤§å°ã€‚", "error");
                } finally {
                    btn.disabled = false;
                }
            });
            
            // AI-related buttons and modals.
            document.getElementById('ai-text-summary-btn').addEventListener('click', async () => {
                const textResponses = allStudentResponses.filter(r => currentInteractionMode === 'text_input' && r.answer && r.answer.trim()).map(r => r.answer);
                if (textResponses.length === 0) return showMessage('ç›®å‰æ²’æœ‰æ–‡å­—å›ç­”å¯ä¾› AI åˆ†æã€‚', 'info');
                const aiSummaryModal = document.getElementById('ai-summary-modal');
                const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
                const aiSummaryResultList = document.getElementById('ai-summary-result-list');
                aiSummaryModal.classList.remove('hidden');
                aiLoadingSpinner.classList.remove('hidden');
                aiSummaryResultList.innerHTML = '';
                const prompt = `è«‹åˆ†æä»¥ä¸‹å­¸ç”Ÿå›ç­”çš„æ–‡æœ¬å…§å®¹ï¼Œè­˜åˆ¥å‡ºèªç¾©ä¸Šç›¸ä¼¼çš„è©èªæˆ–çŸ­èªï¼Œæ­¸é¡ç‚ºä¸»è¦è©å½™ä¸¦çµ±è¨ˆç¸½å‡ºç¾æ¬¡æ•¸ã€‚åˆ—å‡ºæœ€å¸¸å‡ºç¾çš„10å€‹ä¸»è¦è©å½™ã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œæ’é™¤å¸¸è¦‹åŠ©è©ã€é€£æ¥è©ã€æ¨™é»ç¬¦è™Ÿã€‚ä½¿ç”¨JSONæ ¼å¼è¿”å›çµæœï¼š[{"word": "ä¸»è¦è©å½™1", "count": 10}]ã€‚è‹¥ç„¡æœ‰æ„ç¾©è©å½™ï¼Œè¿”å›ç©ºé™£åˆ—[]ã€‚æ–‡æœ¬å…§å®¹ï¼š\n${textResponses.join('\n\n')}`;
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "count": { "type": "NUMBER" } }, "propertyOrdering": ["word", "count"] } } }
                    };
                    const apiKey = (aiSettings.aiSource === 'gemini-custom' && aiSettings.geminiApiKey) ? aiSettings.geminiApiKey : "";
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                    const result = await response.json();
                    aiLoadingSpinner.classList.add('hidden');
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsedResults = jsonText ? JSON.parse(jsonText) : [];
                    if (parsedResults.length > 0) {
                        parsedResults.sort((a, b) => b.count - a.count).forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.word} (${item.count}æ¬¡)`;
                            aiSummaryResultList.appendChild(li);
                        });
                    } else {
                        aiSummaryResultList.innerHTML = '<li>æ²’æœ‰æ‰¾åˆ°å¸¸ç”¨è©å½™ã€‚</li>';
                    }
                } catch (error) {
                    console.error("AI æ–‡å­—åˆ†æå¤±æ•—:", error);
                    aiLoadingSpinner.classList.add('hidden');
                    aiSummaryResultList.innerHTML = '<li class="error-message">AI åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚</li>';
                }
            });
            document.getElementById('ai-summary-modal-close-btn').addEventListener('click', () => document.getElementById('ai-summary-modal').classList.add('hidden'));
            document.getElementById('ai-settings-btn').addEventListener('click', showAISettingsModal);
            aiSettingsModalCloseBtn.addEventListener('click', hideAISettingsModal);
            saveAiSettingsBtn.addEventListener('click', saveAISettings);
            aiSourceSelect.addEventListener('change', (e) => geminiApiKeyGroup.classList.toggle('hidden', e.target.value !== 'gemini-custom'));

            // New: URL/HTML Dispatch Settings Modal listeners.
            document.getElementById('url-dispatch-settings-btn').addEventListener('click', showUrlDispatchSettingsModal);
            urlDispatchModalCloseBtn.addEventListener('click', hideUrlDispatchSettingsModal);
            document.getElementById('save-dispatch-settings-btn').addEventListener('click', saveDispatchSettings); // Renamed
            document.getElementById('clear-dispatch-settings-btn').addEventListener('click', clearDispatchSettings); // Renamed

            // NEW: Event listeners for dispatch type radio buttons
            dispatchTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const selectedType = e.target.value;
                    urlDispatchSection.classList.toggle('hidden', selectedType === 'html');
                    htmlDispatchSection.classList.toggle('hidden', selectedType === 'url');
                });
            });

            // NEW: HTML upload/clear listeners within the dispatch settings modal
            dispatchHtmlUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input
                if (file) {
                    handleDispatchHtmlFile(file);
                }
            });
            clearDispatchHtmlBtn.addEventListener('click', () => {
                dispatchSettings.htmlContent = null; // Clear content in global state
                dispatchHtmlUploadInput.value = ''; // Clear file input
                dispatchHtmlStatus.textContent = 'ç›®å‰æ²’æœ‰ HTML æª”æ¡ˆã€‚';
                showMessage('HTML æª”æ¡ˆå·²æ¸…é™¤ï¼', 'info');
            });


            /*
            // éŒ„éŸ³äº‹ä»¶ç›£è½å™¨æš«æ™‚è¨»éŠ· - HTTPç’°å¢ƒä¸æ”¯æ´
            // New: Recording button event listeners
            startRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before starting recording
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é–‹å§‹éŒ„éŸ³ã€‚', 'error');
                    return;
                }
                startRecording();
            });
            stopRecordingBtn.addEventListener('click', stopRecording);
            playRecordingBtn.addEventListener('click', playRecording);
            resetRecordingBtn.addEventListener('click', resetRecording);
            submitRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before submitting recording
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºéŒ„éŸ³ã€‚', 'error');
                    return;
                }
                if (audioDataURL) {
                    await submitAnswer(audioDataURL);
                    submitRecordingBtn.disabled = true;
                    submitRecordingBtn.classList.replace('btn-primary', 'btn-gray');
                } else {
                    showMessage('æ²’æœ‰éŒ„éŸ³å¯é€å‡º', 'error');
                }
            });
            */

            // NEW: Toggle Pause Button Event Listener
            togglePauseBtn.addEventListener('click', toggleResponsePause);


            // End Class Session Buttons.
            document.getElementById('end-class-session-menu-btn').addEventListener('click', endClassSession);
            document.getElementById('end-class-session-monitor-btn').addEventListener('click', endClassSession);

            // NEW: Multiple Choice Settings Modal Listeners
            const multipleChoiceSettingsModal = document.getElementById('multiple-choice-settings-modal');
            const multipleChoiceSettingsModalCloseBtn = document.getElementById('multiple-choice-settings-modal-close-btn');
            const mcQuestionTypeRadios = document.querySelectorAll('input[name="mcQuestionType"]');
            const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
            const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
            const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');
            const startMcInteractionBtn = document.getElementById('start-mc-interaction-btn');
            const cancelMcSettingsBtn = document.getElementById('cancel-mc-settings-btn');
            
            // AI Question Generation elements
            const aiGenerateMcBtn = document.getElementById('ai-generate-mc-btn');
            const aiMcTopicTextarea = document.getElementById('ai-mc-topic-textarea');
            const aiMcCountInput = document.getElementById('ai-mc-count-input');
            const aiMcLoadingSpinner = document.getElementById('ai-mc-loading-spinner');
            const aiMcBtnText = document.getElementById('ai-mc-btn-text');
            const aiMcBtnIcon = document.getElementById('ai-mc-btn-icon');

            // Question Bank Management elements
            const questionBankFileInput = document.getElementById('question-bank-file-input');
            const loadQuestionBankBtn = document.getElementById('load-question-bank-btn');
            const questionBankNameInput = document.getElementById('question-bank-name-input');
            const saveQuestionBankBtn = document.getElementById('save-question-bank-btn');
            const questionBankList = document.getElementById('question-bank-list');


            multipleChoiceSettingsModalCloseBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));
            cancelMcSettingsBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));

            // Question Bank Management Event Listeners
            loadQuestionBankBtn.addEventListener('click', loadQuestionBankFromFile);
            saveQuestionBankBtn.addEventListener('click', saveQuestionBankFromTextarea);

            // Teacher Password Modal Event Listeners
            const teacherPasswordModal = document.getElementById('teacher-password-modal');
            const teacherPasswordModalCloseBtn = document.getElementById('teacher-password-modal-close-btn');
            const teacherPasswordInput = document.getElementById('teacher-password-modal-input');
            const teacherPasswordSubmitBtn = document.getElementById('teacher-password-submit-btn');
            const teacherPasswordCancelBtn = document.getElementById('teacher-password-cancel-btn');

            teacherPasswordModalCloseBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordCancelBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordSubmitBtn.addEventListener('click', () => {
                const password = teacherPasswordInput.value.trim();
                
                // é™¤éŒ¯è¨Šæ¯
                console.log('å¯†ç¢¼é©—è­‰ - è¼¸å…¥çš„å¯†ç¢¼:', `"${password}"`);
                console.log('å¯†ç¢¼é©—è­‰ - å¯†ç¢¼é•·åº¦:', password.length);
                
                // ä½¿ç”¨èˆ‡ä¸»ç™»å…¥æµç¨‹ç›¸åŒçš„å¯†ç¢¼åˆ—è¡¨
                const validPasswords = ['tpet', 'teacher', 'admin', '123456'];
                console.log('å¯†ç¢¼é©—è­‰ - æœ‰æ•ˆå¯†ç¢¼åˆ—è¡¨:', validPasswords);
                console.log('å¯†ç¢¼é©—è­‰ - æ˜¯å¦åŒ…å«:', validPasswords.includes(password));
                
                if (validPasswords.includes(password)) {
                    console.log('å¯†ç¢¼é©—è­‰ - æˆåŠŸ');
                    teacherPasswordModal.classList.add('hidden');
                    teacherPasswordInput.value = '';
                    showView('teacherClassroomCode');
                } else {
                    console.log('å¯†ç¢¼é©—è­‰ - å¤±æ•—');
                    showMessage('å¯†ç¢¼éŒ¯èª¤ï¼', 'error');
                    teacherPasswordInput.value = '';
                    teacherPasswordInput.focus();
                }
            });
            teacherPasswordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    teacherPasswordSubmitBtn.click();
                }
            });

            mcQuestionTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isCustomMode = e.target.value === 'custom';
                    customMcQuestionsSection.classList.toggle('hidden', !isCustomMode);
                    document.getElementById('question-bank-management-section').classList.toggle('hidden', !isCustomMode);
                    customMcQuestionsStatus.classList.add('hidden'); // Hide status when changing radio
                });
            });

            startMcInteractionBtn.addEventListener('click', async () => {
                const selectedType = document.querySelector('input[name="mcQuestionType"]:checked').value;
                let questionsToDispatch = null;

                if (selectedType === 'custom') {
                    const parsedQuestions = parseCustomQuestions(customMcQuestionsTextarea.value);
                    if (!parsedQuestions) {
                        customMcQuestionsStatus.classList.remove('hidden');
                        return; // Stop if parsing failed
                    }
                    questionsToDispatch = parsedQuestions;
                    customMultipleChoiceQuestions = parsedQuestions; // Update global for teacher UI
                } else {
                    customMultipleChoiceQuestions = []; // Clear global if switching to none
                }
                
                customMcQuestionsStatus.classList.add('hidden'); // Hide status on successful dispatch
                multipleChoiceSettingsModal.classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('multiple_choice', { customQuestions: questionsToDispatch });
            });

            // AI Question Generation Button Listener
            aiGenerateMcBtn.addEventListener('click', async () => {
                const topic = aiMcTopicTextarea.value.trim();
                const count = parseInt(aiMcCountInput.value);

                if (!topic) {
                    showMessage('è«‹è¼¸å…¥å‡ºé¡Œä¸»é¡Œæˆ–è¦æ±‚ï¼', 'error');
                    return;
                }
                if (!count || count < 1 || count > 10) {
                    showMessage('å‡ºé¡Œæ•¸é‡å¿…é ˆä»‹æ–¼ 1 åˆ° 10 ä¹‹é–“ï¼', 'error');
                    return;
                }
                
                // Show loading state
                aiGenerateMcBtn.disabled = true;
                aiMcBtnText.textContent = 'AI æ€è€ƒä¸­...';
                aiMcBtnIcon.classList.remove('fa-magic');
                aiMcBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiMcLoadingSpinner.classList.remove('hidden');

                const prompt = `è«‹æ ¹æ“šä»¥ä¸‹è¦æ±‚ï¼Œç”Ÿæˆ ${count} é¡Œé¸æ“‡é¡Œã€‚
                è¦æ±‚ï¼š${topic}
                è«‹åš´æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼Œæ¯é¡Œä¸€è¡Œï¼Œä¸¦ç”¨é€—è™Ÿåˆ†éš”æ¯å€‹æ¬„ä½ï¼š
                é¡Œç›®,æ­£ç¢ºç­”æ¡ˆ(1-4),é¸é …1,é¸é …2,é¸é …3,é¸é …4
                è«‹å‹¿åŒ…å«é¡Œè™Ÿã€ä»»ä½•å¤šé¤˜çš„èªªæ˜æ–‡å­—æˆ–ç¨‹å¼ç¢¼å€å¡Šæ¨™è¨˜ã€‚`;

                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 } // Adjust temperature for creativity
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        throw new Error(`AI API request failed with status ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (generatedText) {
                        // Append to existing content, adding a newline if needed
                        const existingText = customMcQuestionsTextarea.value.trim();
                        customMcQuestionsTextarea.value = existingText ? `${existingText}\n${generatedText.trim()}` : generatedText.trim();
                        showMessage('AI é¡Œç›®å·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥å·¦æ–¹ï¼', 'success');
                    } else {
                        throw new Error('AI æœªè¿”å›æœ‰æ•ˆå…§å®¹ã€‚');
                    }

                } catch (error) {
                    console.error("AI é¡Œç›®ç”Ÿæˆå¤±æ•—:", error);
                    showMessage('AI é¡Œç›®ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚', 'error');
                } finally {
                    // Hide loading state
                    aiGenerateMcBtn.disabled = false;
                    aiMcBtnText.textContent = 'AI é–‹å§‹å‡ºé¡Œ';
                    aiMcBtnIcon.classList.add('fa-magic');
                    aiMcBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiMcLoadingSpinner.classList.add('hidden');
                }
            });


            // NEW: Student side custom multiple choice submission
            document.getElementById('submit-custom-mc-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('è€å¸«å·²æš«åœå›è¦†ï¼Œç„¡æ³•é€å‡ºç­”æ¡ˆã€‚', 'error');
                    return;
                }

                // NEW: æª¢æŸ¥æ˜¯å¦å·²ç¶“æäº¤éç­”æ¡ˆ
                const hasSubmitted = await checkIfStudentSubmitted();
                if (hasSubmitted) {
                    showMessage('æ‚¨å·²ç¶“æäº¤éç­”æ¡ˆï¼Œç„¡æ³•é‡è¤‡æäº¤ã€‚', 'error');
                    return;
                }

                const studentAnswers = [];
                const questionContainers = document.querySelectorAll('#custom-mc-questions-container .mc-question-item');
                let allAnswered = true;

                questionContainers.forEach((qContainer, index) => {
                    const selectedOption = qContainer.querySelector(`input[name="question-${index}"]:checked`);
                    if (selectedOption) {
                        studentAnswers.push({ qIndex: index, ans: selectedOption.value });
                    } else {
                        allAnswered = false;
                    }
                });

                if (!allAnswered) {
                    showMessage('è«‹å›ç­”æ‰€æœ‰é¡Œç›®ï¼', 'error');
                    return;
                }

                await submitAnswer(studentAnswers);
                
                // NEW: æ›´æ–°UIé¡¯ç¤ºå·²æäº¤ç‹€æ…‹
                if (e.currentTarget) {
                    e.currentTarget.disabled = true;
                    e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                    e.currentTarget.textContent = 'å·²æäº¤ç­”æ¡ˆ âœ“';
                }
                
                // Disable all radio buttons after submission
                document.querySelectorAll('#custom-mc-questions-container input[type="radio"]').forEach(radio => {
                    radio.disabled = true;
                });
            });
        }

        /**
         * NEW: Parses custom multiple choice questions from a textarea string.
         * Expected format per line: Question,CorrectAnswer(1-4/A-D),Option1,Option2,Option3,Option4
         * @param {string} rawText - The raw string from the textarea.
         * @returns {Array|null} An array of question objects, or null if parsing fails.
         */
        function parseCustomQuestions(rawText) {
            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const questions = [];

            for (const line of lines) {
                // Try splitting by comma first, then by tab if comma yields too few parts
                let parts = line.split(',');
                if (parts.length < 6) {
                    parts = line.split('\t');
                }

                if (parts.length !== 6) {
                    console.error("Invalid line format:", line);
                    return null; // Invalid format
                }

                const questionText = parts[0].trim();
                let correctAnswer = parts[1].trim().toUpperCase();
                const options = parts.slice(2, 6).map(opt => opt.trim());

                // Normalize correct answer to 1, 2, 3, 4
                if (correctAnswer === 'A') correctAnswer = '1';
                else if (correctAnswer === 'B') correctAnswer = '2';
                else if (correctAnswer === 'C') correctAnswer = '3';
                else if (correctAnswer === 'D') correctAnswer = '4';

                if (!['1', '2', '3', '4'].includes(correctAnswer)) {
                    console.error("Invalid correct answer format:", correctAnswer);
                    return null; // Invalid correct answer
                }

                if (questionText === '' || options.some(opt => opt === '')) {
                    console.error("Empty question or option:", line);
                    return null; // Empty question or option
                }

                questions.push({
                    questionText: questionText,
                    correctAnswer: correctAnswer,
                    options: options
                });
            }

            if (questions.length === 0) {
                return null; // No valid questions parsed
            }

            return questions;
        }

        /**
         * NEW: Renders custom multiple choice questions on the student side.
         * @param {Array} questions - An array of question objects.
         */
        async function renderMultipleChoiceQuestions(questions) {
            const defaultMcOptions = document.getElementById('default-mc-options');
            const customMcQuestionsContainer = document.getElementById('custom-mc-questions-container');
            const submitCustomMcBtn = document.getElementById('submit-custom-mc-btn');
            const interactionMultipleChoice = document.getElementById('interaction-multiple-choice');

            if (questions && questions.length > 0) {
                defaultMcOptions.classList.add('hidden');
                customMcQuestionsContainer.classList.remove('hidden');
                submitCustomMcBtn.classList.remove('hidden');
                customMcQuestionsContainer.innerHTML = ''; // Clear previous questions
                interactionMultipleChoice.classList.remove('enlarged-buttons'); // Remove enlarged class for custom questions

                // NEW: æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“æäº¤éç­”æ¡ˆ
                const hasSubmitted = await checkIfStudentSubmitted();
                
                questions.forEach((q, qIndex) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'mc-question-item bg-white p-4 rounded-lg shadow-md';
                    questionDiv.innerHTML = `
                        <p class="font-bold text-lg mb-3 text-gray-800">Q${qIndex + 1}. ${q.questionText}</p>
                        <div class="space-y-2">
                            ${q.options.map((option, optIndex) => `
                                <label class="flex items-center p-2 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50 transition-colors">
                                    <input type="radio" name="question-${qIndex}" value="${optIndex + 1}" class="form-radio text-blue-600 h-5 w-5" ${hasSubmitted ? 'disabled' : ''}>
                                    <span class="ml-3 text-gray-700">${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                    customMcQuestionsContainer.appendChild(questionDiv);
                });

                // NEW: å¦‚æœå·²æäº¤ï¼Œæ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                if (hasSubmitted) {
                    submitCustomMcBtn.disabled = true;
                    submitCustomMcBtn.classList.replace('btn-primary', 'btn-gray');
                    submitCustomMcBtn.textContent = 'å·²æäº¤ç­”æ¡ˆ âœ“';
                    
                    // é¡¯ç¤ºå·²æäº¤çš„ç­”æ¡ˆ
                    await displaySubmittedAnswers();
                }
            } else {
                defaultMcOptions.classList.remove('hidden');
                customMcQuestionsContainer.classList.add('hidden');
                submitCustomMcBtn.classList.add('hidden');
                interactionMultipleChoice.classList.add('enlarged-buttons'); // Add enlarged class for no custom questions
            }
        }

        // NEW: æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“æäº¤éç­”æ¡ˆ
        async function checkIfStudentSubmitted() {
            if (!studentName || !classroomCode) return false;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // æª¢æŸ¥æ˜¯å¦æœ‰é™£åˆ—æ ¼å¼çš„ç­”æ¡ˆï¼ˆè‡ªè¨‚é¸æ“‡é¡Œï¼‰
                    return Array.isArray(data.answer) && data.answer.length > 0;
                }
                return false;
            } catch (error) {
                console.error('æª¢æŸ¥æäº¤ç‹€æ…‹å¤±æ•—:', error);
                return false;
            }
        }

        // NEW: é¡¯ç¤ºå­¸ç”Ÿå·²æäº¤çš„ç­”æ¡ˆ
        async function displaySubmittedAnswers() {
            if (!studentName || !classroomCode) return;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (Array.isArray(data.answer)) {
                        // æ¨™è¨˜å·²é¸æ“‡çš„ç­”æ¡ˆ
                        data.answer.forEach(qAns => {
                            const radio = document.querySelector(`input[name="question-${qAns.qIndex}"][value="${qAns.ans}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥å·²æäº¤ç­”æ¡ˆå¤±æ•—:', error);
            }
        }

        // NEW: æª¢æŸ¥ä¸¦æ¢å¾©æ–‡å­—ç­”æ¡ˆçš„æäº¤ç‹€æ…‹
        async function checkAndRestoreTextAnswer() {
            if (!studentName || !classroomCode) {
                // If no student info, reset to default state
                resetTextInputToDefault();
                return;
            }
            
            try {
                // Query PocketBase for existing student response
                const responses = await pb.collection('student_responses').getList(1, 1, {
                    filter: `classroom_code = "${classroomCode}" && student_name = "${studentName}"`
                });
                
                if (responses.items.length > 0 && responses.items[0].answer) {
                    // Student has already submitted an answer
                    const answer = responses.items[0].answer;
                    
                    // Show the submitted answer in textarea
                    document.getElementById('text-input-area').value = answer;
                    
                    // Update button to show submitted state
                    const submitTextBtn = document.getElementById('submit-text-btn');
                    submitTextBtn.disabled = true;
                    submitTextBtn.classList.remove('btn-primary');
                    submitTextBtn.classList.add('btn-gray');
                    submitTextBtn.textContent = 'å·²é€å‡º âœ“';
                    submitTextBtn.setAttribute('data-submitted', 'true'); // æ¨™è¨˜ç‚ºå·²æäº¤
                } else {
                    // No submission yet, reset to default state
                    resetTextInputToDefault();
                }
            } catch (error) {
                console.error('æª¢æŸ¥æ–‡å­—ç­”æ¡ˆæäº¤ç‹€æ…‹å¤±æ•—:', error);
                // On error, reset to default state
                resetTextInputToDefault();
            }
        }

        // NEW: é‡ç½®æ–‡å­—è¼¸å…¥åˆ°é è¨­ç‹€æ…‹
        function resetTextInputToDefault() {
            document.getElementById('text-input-area').value = '';
            const submitTextBtn = document.getElementById('submit-text-btn');
            submitTextBtn.disabled = false;
            submitTextBtn.classList.remove('btn-gray');
            submitTextBtn.classList.add('btn-primary');
            submitTextBtn.textContent = 'é€å‡ºå›ç­” âœ‰ï¸';
            submitTextBtn.removeAttribute('data-submitted'); // æ¸…é™¤æäº¤æ¨™è¨˜
        }

        // NEW: æª¢æŸ¥ä¸¦æ¢å¾©ç¹ªåœ–ç­”æ¡ˆçš„æäº¤ç‹€æ…‹
        async function checkAndRestoreDrawingAnswer() {
            if (!studentName || !classroomCode) {
                // If no student info, reset to default state
                resetDrawingToDefault();
                return;
            }
            
            try {
                // Query PocketBase for existing student response
                const responses = await pb.collection('student_responses').getList(1, 1, {
                    filter: `classroom_code = "${classroomCode}" && student_name = "${studentName}"`
                });
                
                if (responses.items.length > 0 && responses.items[0].image_data) {
                    // Student has already submitted a drawing
                    // Update button to show submitted state
                    const submitDrawingBtn = document.getElementById('submit-drawing-btn');
                    submitDrawingBtn.disabled = true;
                    submitDrawingBtn.classList.remove('btn-primary');
                    submitDrawingBtn.classList.add('btn-gray', 'pointer-events-none');
                    submitDrawingBtn.textContent = 'å·²é€å‡º âœ“';
                } else {
                    // No submission yet, reset to default state
                    resetDrawingToDefault();
                }
            } catch (error) {
                console.error('æª¢æŸ¥ç¹ªåœ–ç­”æ¡ˆæäº¤ç‹€æ…‹å¤±æ•—:', error);
                // On error, reset to default state
                resetDrawingToDefault();
            }
        }

        // NEW: é‡ç½®ç¹ªåœ–æäº¤æŒ‰éˆ•åˆ°é è¨­ç‹€æ…‹
        function resetDrawingToDefault() {
                        const submitDrawingBtn = document.getElementById('submit-drawing-btn');
                        submitDrawingBtn.disabled = false;
                        submitDrawingBtn.classList.remove('btn-gray', 'pointer-events-none');
                        submitDrawingBtn.classList.add('btn-primary');
                        submitDrawingBtn.textContent = 'é€å‡º ğŸš€';

                        // æ¢å¾©æ‰€æœ‰ç¹ªåœ–å·¥å…·çš„å¯æ“ä½œç‹€æ…‹
                        const drawingTools = [
                            'drawing-canvas',
                            'pen-tool-btn',
                            'eraser-btn',
                            'clear-canvas-btn',
                            'color-select',
                            'size-select',
                            'toggle-grid-checkbox',
                            'student-image-upload-input',
                            'clear-student-image-btn'
                        ];
                        drawingTools.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.disabled = false;
                                el.style.pointerEvents = '';
                                el.classList.remove('opacity-50');
                            }
                        });
        }

        // --- Canvas State Management Functions ---
        
        /**
         * Saves the current canvas state when switching to peer review.
         */
        function saveCanvasState() {
            if (canvas && currentInteractionMode === 'drawing') {
                try {
                    savedCanvasState = {
                        mainCanvas: canvas.toDataURL('image/jpeg', JPEG_QUALITY),
                        drawingCanvas: drawingCanvas.toDataURL('image/jpeg', JPEG_QUALITY),
                        studentImageCanvas: studentImageCanvas.toDataURL('image/jpeg', JPEG_QUALITY),
                        canvasWidth: canvas.width,
                        canvasHeight: canvas.height
                    };
                    console.log('Canvas state saved');
                } catch (error) {
                    console.error('Error saving canvas state:', error);
                }
            }
        }
        
        /**
         * Restores the canvas state when returning from peer review.
         */
        function restoreCanvasState() {
            if (savedCanvasState && canvas && currentInteractionMode === 'drawing') {
                try {
                    // Ensure canvas setup is complete
                    if (canvas.width === 0 || canvas.height === 0) {
                        setupCanvas();
                    }
                    
                    // Restore canvas dimensions
                    canvas.width = savedCanvasState.canvasWidth;
                    canvas.height = savedCanvasState.canvasHeight;
                    drawingCanvas.width = savedCanvasState.canvasWidth;
                    drawingCanvas.height = savedCanvasState.canvasHeight;
                    studentImageCanvas.width = savedCanvasState.canvasWidth;
                    studentImageCanvas.height = savedCanvasState.canvasHeight;
                    
                    let imagesLoaded = 0;
                    const totalImages = 2; // drawing and student image
                    
                    function checkAllImagesLoaded() {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            // All images loaded, recompose the final canvas
                            redrawCanvas();
                            console.log('Canvas state restored');
                        }
                    }
                    
                    // Restore drawing canvas content
                    if (savedCanvasState.drawingCanvas && savedCanvasState.drawingCanvas !== 'data:,') {
                        const drawingImg = new Image();
                        drawingImg.onload = function() {
                            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                            drawingCtx.drawImage(drawingImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        drawingImg.onerror = function() {
                            console.warn('Failed to load drawing canvas');
                            checkAllImagesLoaded();
                        };
                        drawingImg.src = savedCanvasState.drawingCanvas;
                    } else {
                        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                    // Restore student image canvas content
                    if (savedCanvasState.studentImageCanvas && savedCanvasState.studentImageCanvas !== 'data:,') {
                        const studentImg = new Image();
                        studentImg.onload = function() {
                            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                            studentImageCtx.drawImage(studentImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        studentImg.onerror = function() {
                            console.warn('Failed to load student image canvas');
                            checkAllImagesLoaded();
                        };
                        studentImg.src = savedCanvasState.studentImageCanvas;
                    } else {
                        studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                } catch (error) {
                    console.error('Error restoring canvas state:', error);
                    // Fallback: just redraw what we can
                    redrawCanvas();
                }
            }
        }
        
        /**
         * Redraws the main canvas by compositing all layers.
         */
        function redrawCanvas() {
            if (!canvas || !ctx) return;
            
            // Clear main canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background (teacher's background image)
            if (teacherUploadedBackgroundImageDataURL && backgroundCanvas) {
                try {
                    ctx.drawImage(backgroundCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing background canvas:', error);
                }
            }
            
            // Draw student's uploaded image
            if (studentUploadedImageDataURL && studentImageCanvas) {
                try {
                    ctx.drawImage(studentImageCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing student image canvas:', error);
                }
            }
            
            // Draw student's drawing strokes
            if (drawingCanvas) {
                try {
                    ctx.drawImage(drawingCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing drawing canvas:', error);
                }
            }
        }

        // --- Peer Review Functions ---
        
        /**
         * Clears all previous peer review votes for the current classroom.
         */
        async function clearPreviousPeerReviewVotes() {
            if (!classroomCode) {
                return;
            }
            
            try {
                // ç²å–è©²æ•™å®¤çš„æ‰€æœ‰æŠ•ç¥¨è¨˜éŒ„
                const allVotes = await pb.collection('peer_reviews').getList(1, 200, {
                    filter: `classroom_code = "${classroomCode}"`
                });
                
                // åˆªé™¤æ‰€æœ‰ç›¸é—œçš„æŠ•ç¥¨è¨˜éŒ„
                for (const vote of allVotes.items) {
                    try {
                        await pb.collection('peer_reviews').delete(vote.id);
                    } catch (deleteError) {
                        // Failed to delete vote record
                    }
                }
                
                // é‡ç½®æœ¬åœ°æŠ•ç¥¨æ•¸æ“š
                allPeerReviewVotes = {};
                studentVotedWorks.clear();
                
            } catch (error) {
                // å³ä½¿æ¸…é™¤å¤±æ•—ä¹Ÿè¦é‡ç½®æœ¬åœ°æ•¸æ“š
                allPeerReviewVotes = {};
                studentVotedWorks.clear();
            }
        }

        // ===== åˆé¸åŠŸèƒ½ç›¸é—œå‡½æ•¸ =====
        
        /**
         * Shows the preliminary selection modal for teacher to select works.
         */
        function showPreliminarySelectionModal() {
            if (!currentInteractionMode || !['text_input', 'drawing'].includes(currentInteractionMode)) {
                showMessage('åªæœ‰æ–‡å­—è¼¸å…¥å’Œç¹ªåœ–æ¨¡å¼æ‰æ”¯æ´åˆé¸åŠŸèƒ½ã€‚', 'warning');
                return;
            }
            
            if (allStudentResponses.length === 0) {
                showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿä½œå“å¯ä¾›åˆé¸ã€‚', 'warning');
                return;
            }
            
            // é¡¯ç¤ºæ¨¡æ…‹çª—å£
            document.getElementById('preliminary-selection-modal').classList.remove('hidden');
            
            // å¡«å…¥å­¸ç”Ÿä½œå“
            populatePreliminarySelectionGrid();
        }
        
        /**
         * Hides the preliminary selection modal.
         */
        function hidePreliminarySelectionModal() {
            document.getElementById('preliminary-selection-modal').classList.add('hidden');
        }
        
        /**
         * Populates the preliminary selection grid with student works.
         */
        function populatePreliminarySelectionGrid() {
            const grid = document.getElementById('preliminary-selection-grid');
            const totalCountSpan = document.getElementById('total-count');
            const selectedCountSpan = document.getElementById('selected-count');
            
            grid.innerHTML = '';
            totalCountSpan.textContent = allStudentResponses.length;
            selectedCountSpan.textContent = '0';
            
            allStudentResponses.forEach((work, index) => {
                const workDiv = document.createElement('div');
                workDiv.className = 'preliminary-item';
                workDiv.dataset.studentName = work.name;
                
                let contentHtml = '';
                if (currentInteractionMode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="å­¸ç”Ÿä½œå“">`;
                } else {
                    contentHtml = `<div class="content">${work.answer}</div>`;
                }
                
                workDiv.innerHTML = `
                    <input type="checkbox" class="checkbox" />
                    <div class="student-name">${work.name}</div>
                    ${contentHtml}
                `;
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                workDiv.addEventListener('click', togglePreliminarySelection);
                
                grid.appendChild(workDiv);
            });
        }
        
        /**
         * Toggles selection of a work in preliminary selection.
         */
        function togglePreliminarySelection(e) {
            const workDiv = e.currentTarget;
            const checkbox = workDiv.querySelector('.checkbox');
            
            // åˆ‡æ›é¸ä¸­ç‹€æ…‹
            workDiv.classList.toggle('selected');
            checkbox.checked = workDiv.classList.contains('selected');
            
            // æ›´æ–°è¨ˆæ•¸
            updatePreliminarySelectionCount();
        }
        
        /**
         * Updates the selected count display.
         */
        function updatePreliminarySelectionCount() {
            const selectedItems = document.querySelectorAll('.preliminary-item.selected');
            const selectedCountSpan = document.getElementById('selected-count');
            selectedCountSpan.textContent = selectedItems.length;
        }
        
        /**
         * Confirms preliminary selection and starts peer review with selected works.
         */
        async function confirmPreliminarySelection() {
            const selectedItems = document.querySelectorAll('.preliminary-item.selected');
            
            if (selectedItems.length === 0) {
                showMessage('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ä½œå“é€²è¡Œäº’è©•ã€‚', 'warning');
                return;
            }
            
            // æ”¶é›†é¸ä¸­çš„å­¸ç”Ÿåå–®
            const selectedStudents = Array.from(selectedItems).map(item => item.dataset.studentName);
            
            try {
                // æ›´æ–°è³‡æ–™åº«ä¸­çš„åˆé¸ç‹€æ…‹
                await pb.collection('classrooms').update(classroomRecordId, {
                    preliminary_selection_active: true,
                    preliminary_selected_students: selectedStudents
                });
                
                // éš±è—åˆé¸æ¨¡æ…‹çª—å£
                hidePreliminarySelectionModal();
                
                // è‡ªå‹•é–‹å§‹äº’è©•ï¼Œä½†åªåŒ…å«é¸ä¸­çš„ä½œå“
                await startPeerReviewWithSelectedWorks(selectedStudents);
                
                showMessage(`åˆé¸å®Œæˆï¼é¸ä¸­äº† ${selectedStudents.length} å€‹ä½œå“é€²å…¥äº’è©•éšæ®µã€‚`, 'success');
                
            } catch (error) {
                showMessage('åˆé¸è¨­å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }
        
        /**
         * Starts peer review with only the selected works from preliminary selection.
         */
        async function startPeerReviewWithSelectedWorks(selectedStudents) {
            // éæ¿¾å‡ºé¸ä¸­çš„ä½œå“
            const selectedWorks = allStudentResponses.filter(work => selectedStudents.includes(work.name));
            
            if (selectedWorks.length === 0) {
                showMessage('æ²’æœ‰æ‰¾åˆ°é¸ä¸­çš„ä½œå“ã€‚', 'error');
                return;
            }
            
            try {
                // é¦–å…ˆæ¸…é™¤è©²æ•™å®¤çš„æ‰€æœ‰èˆŠæŠ•ç¥¨è¨˜éŒ„
                await clearPreviousPeerReviewVotes();
                
                // æ›´æ–°æ•™å®¤è¨˜éŒ„
                const updateResult = await pb.collection('classrooms').update(classroomRecordId, {
                    peer_review_active: true,
                    peer_review_mode: currentInteractionMode,
                    peer_review_works: selectedWorks,
                    peer_review_timestamp: new Date().toISOString(),
                    preliminary_selection_active: true,  // ä¿æŒåˆé¸ç‹€æ…‹
                    preliminary_selected_students: selectedStudents  // ä¿æŒåˆé¸å­¸ç”Ÿåå–®
                });
                
                // é¡¯ç¤ºæŠ•ç¥¨çµ±è¨ˆå®¹å™¨
                document.getElementById('peer-review-stats-container').classList.remove('hidden');
                
                // é–‹å§‹ç›£è½æŠ•ç¥¨
                listenToPeerReviewVotes();
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
                startPeerReviewBtn.innerHTML = '<i class="fas fa-stop mr-2"></i> åœæ­¢äº’è©• â¹ï¸';
                
                // éš±è—åˆé¸æŒ‰éˆ•
                document.getElementById('start-preliminary-selection-btn').classList.add('hidden');
                
            } catch (error) {
                console.error('Error starting peer review with selected works:', error);
                showMessage('é–‹å§‹äº’è©•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            }
        }

        /**
         * Toggles the peer review process for the current interaction.
         * Only works for text_input and drawing modes.
         */
        async function startPeerReview() {
            if (!currentInteractionMode || (!['text_input', 'drawing'].includes(currentInteractionMode))) {
                showMessage('äº’è©•åŠŸèƒ½åªæ”¯æ´æ–‡å­—é¡Œå’Œç¹ªåœ–é¡Œï¼', 'error');
                return;
            }
            
            if (!classroomRecordId) {
                showMessage('æ•™å®¤è¨˜éŒ„IDä¸å­˜åœ¨ï¼Œç„¡æ³•å•Ÿå‹•äº’è©•åŠŸèƒ½', 'error');
                console.error('classroomRecordId is null:', classroomRecordId);
                return;
            }
            
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            
            if (peerReviewActive) {
                // Stop peer review
                try {
                    // Update classroom peer review status in PocketBase
                    await pb.collection('classrooms').update(classroomRecordId, {
                        peer_review_active: false,
                        peer_review_mode: '',
                        peer_review_works: [],
                        peer_review_timestamp: null,
                        preliminary_selection_active: false,
                        preliminary_selected_students: []
                    });
                    
                    peerReviewActive = false;
                    showMessage('äº’è©•å·²åœæ­¢ï¼å­¸ç”Ÿå›åˆ°åŸäº’å‹•æ¨¡å¼ã€‚', 'info');
                    
                    // Hide voting statistics container
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    // Show preliminary selection button again
                    document.getElementById('start-preliminary-selection-btn').classList.remove('hidden');
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> é–‹å§‹äº’è©• â¤ï¸';
                    
                    // æ›´æ–°æ•™å®¤æ´»å‹•æ™‚é–“
                    await ClassroomAPI.updateActivity(classroomRecordId);
                    
                } catch (error) {
                    console.error('Error stopping peer review:', error);
                    showMessage('åœæ­¢äº’è©•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                }
            } else {
                // Start peer review
                if (allStudentResponses.length === 0) {
                    showMessage('ç›®å‰æ²’æœ‰å­¸ç”Ÿä½œç­”ï¼Œç„¡æ³•é–‹å§‹äº’è©•ï¼', 'error');
                    return;
                }
                
                try {
                    // é¦–å…ˆæ¸…é™¤è©²æ•™å®¤çš„æ‰€æœ‰èˆŠæŠ•ç¥¨è¨˜éŒ„
                    await clearPreviousPeerReviewVotes();
                    
                    // Update classroom peer review status in PocketBase
                    const updateResult = await pb.collection('classrooms').update(classroomRecordId, {
                        peer_review_active: true,
                        peer_review_mode: currentInteractionMode,
                        peer_review_works: allStudentResponses,
                        peer_review_timestamp: new Date().toISOString(),
                        preliminary_selection_active: false,
                        preliminary_selected_students: []
                    });
                    
                    peerReviewActive = true;
                    showMessage('äº’è©•å·²é–‹å§‹ï¼å­¸ç”Ÿå¯ä»¥é–‹å§‹è§€æ‘©æŠ•ç¥¨ã€‚', 'success');
                    
                    // Show voting statistics container
                    document.getElementById('peer-review-stats-container').classList.remove('hidden');
                    
                    // Start listening for votes
                    listenToPeerReviewVotes();
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-stop mr-2"></i> åœæ­¢äº’è©• â¹ï¸';
                    
                    // Hide preliminary selection button when peer review is active
                    document.getElementById('start-preliminary-selection-btn').classList.add('hidden');
                    
                    // æ›´æ–°æ•™å®¤æ´»å‹•æ™‚é–“
                    await ClassroomAPI.updateActivity(classroomRecordId);
                    
                } catch (error) {
                    console.error('Error starting peer review:', error);
                    console.error('éŒ¯èª¤è©³æƒ…:', error.response);
                    showMessage('é–‹å§‹äº’è©•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                }
            }
        }
        
        /**
         * Exits peer review mode for students and returns to original interaction mode.
         */
        function exitPeerReview() {
            if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                // Return to the original interaction mode
                showView('studentInteraction');
                showInteractionUI(currentInteractionMode);
                
                // Restore canvas state if returning to drawing mode
                if (currentInteractionMode === 'drawing') {
                    // Use a small delay to ensure canvas is ready
                    setTimeout(() => {
                        restoreCanvasState();
                    }, 100);
                }
            } else {
                // Return to waiting if no active interaction
                showView('studentWaiting');
            }
        }
        
        /**
         * Listens for peer review status changes and updates student UI accordingly.
         */
        function listenToPeerReviewStatus() {
            if (!classroomRecordId) {
                return;
            }
            
            // Cleanup previous subscription with proper type checking
            if (peerReviewStatusUnsubscribe && typeof peerReviewStatusUnsubscribe === 'function') {
                try {
                    peerReviewStatusUnsubscribe();
                } catch (error) {
                    // Failed to cleanup subscription
                }
                peerReviewStatusUnsubscribe = null;
            }
            
            // Subscribe to classroom changes to monitor peer review status
            peerReviewStatusUnsubscribe = pb.collection('classrooms').subscribe(classroomRecordId, async function (e) {
                if (e.action === 'update' && e.record) {
                    const data = e.record;
                    
                    if (data.peer_review_active && currentRole === 'student') {
                        // Clear local voting history for new peer review session
                        studentVotedWorks.clear();
                        
                        // Save canvas state before switching to peer review (if in drawing mode)
                        if (currentInteractionMode === 'drawing') {
                            saveCanvasState();
                        }
                        
                        // Switch student to peer review view
                        showView('studentPeerReview');
                        
                        // Filter works based on preliminary selection if active
                        let worksToDisplay = data.peer_review_works;
                        if (data.preliminary_selection_active && data.preliminary_selected_students) {
                            worksToDisplay = data.peer_review_works.filter(work => 
                                data.preliminary_selected_students.includes(work.name)
                            );
                        }
                        
                        await displayPeerReviewWorks(worksToDisplay, data.peer_review_mode);
                        
                        // Since this is a new peer review session, no need to restore old voting history
                        // Just start listening for votes with clean slate
                        listenToPeerReviewVotes();
                    } else if (data.peer_review_active && currentRole === 'teacher') {
                        // Show voting statistics container for teacher
                        document.getElementById('peer-review-stats-container').classList.remove('hidden');
                        
                        // Hide preliminary selection button when peer review is active
                        document.getElementById('start-preliminary-selection-btn').classList.add('hidden');
                        
                        // Start listening for votes and load initial data
                        listenToPeerReviewVotes();
                        
                        // Update button text to show peer review is active
                        const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
                        if (startPeerReviewBtn) {
                            startPeerReviewBtn.innerHTML = '<i class="fas fa-stop mr-2"></i> åœæ­¢äº’è©• â¹ï¸';
                        }
                    } else if (!data.peer_review_active) {
                        if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                            // Peer review ended, return to original interaction mode
                            if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                                // Return to the original interaction mode
                                showView('studentInteraction');
                                showInteractionUI(currentInteractionMode);
                                
                                // Restore canvas state if returning to drawing mode
                                if (currentInteractionMode === 'drawing') {
                                    // Use a small delay to ensure canvas is ready
                                    setTimeout(() => {
                                        restoreCanvasState();
                                    }, 100);
                                }
                            } else {
                                // Return to waiting if no active interaction
                                showView('studentWaiting');
                            }
                        } else if (currentRole === 'teacher') {
                            // Hide voting statistics container for teacher
                            document.getElementById('peer-review-stats-container').classList.add('hidden');
                            
                            // Update button text
                            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
                            if (startPeerReviewBtn) {
                                startPeerReviewBtn.innerHTML = '<i class="fas fa-play mr-2"></i> é–‹å§‹äº’è©• â–¶ï¸';
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Displays peer review works for students to vote on.
         */
        async function displayPeerReviewWorks(works, mode) {
            const worksGrid = document.getElementById('peer-review-works-grid');
            worksGrid.innerHTML = '';
            
            works.forEach((work, index) => {
                // Create a more stable unique identifier using timestamp and student name
                const workId = `${work.name}-${work.timestamp || index}`;
                
                const workDiv = document.createElement('div');
                workDiv.className = 'peer-review-work-item';
                workDiv.dataset.workId = workId;
                
                let contentHtml = '';
                if (mode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="å­¸ç”Ÿä½œå“">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                workDiv.innerHTML = `
                    <div class="work-author">${work.name}</div>
                    <div class="work-content">${contentHtml}</div>
                    <div class="vote-section">
                        <button class="vote-btn" data-work-id="${workId}" data-tooltip="é»æ“ŠæŠ•ç¥¨/å–æ¶ˆæŠ•ç¥¨">
                            <i class="fas fa-heart"></i>
                        </button>
                        <span class="vote-count zero">0</span>
                    </div>
                `;
                
                worksGrid.appendChild(workDiv);
            });
            
            // Add vote button listeners and update vote display
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', handleVote);
            });
            
            // NEW: æ¢å¾©å­¸ç”ŸæŠ•ç¥¨æ­·å²
            await restoreStudentVotingHistory();
            
            // Update button states based on restored voting history
            document.querySelectorAll('.vote-btn').forEach(btn => {
                const workId = btn.dataset.workId;
                const reviewedStudentName = workId.split('-')[0]; // æå–å­¸ç”Ÿåå­—
                if (studentVotedWorks.has(reviewedStudentName)) {
                    btn.classList.add('voted');
                }
            });
            
            // Update vote counts if available
            if (Object.keys(allPeerReviewVotes).length > 0) {
                updateStudentVoteUI(allPeerReviewVotes);
            }
            
            // Update student's vote count display
            updateVoteCountDisplay();
        }
        
        /**
         * Handles voting on a work (toggle vote/unvote).
         */
        async function handleVote(e) {
            const workId = e.currentTarget.dataset.workId;
            const voteBtn = e.currentTarget;
            const voteCountSpan = voteBtn.nextElementSibling;
            
            if (!classroomRecordId) {
                showMessage('æ•™å®¤è¨˜éŒ„IDä¸å­˜åœ¨ï¼Œç„¡æ³•æŠ•ç¥¨', 'error');
                return;
            }
            
            // å¾ workId ä¸­æå–å­¸ç”Ÿåå­— (æ ¼å¼: "name-timestamp")
            const reviewedStudentName = workId.split('-')[0];
            // æª¢æŸ¥æŠ•ç¥¨å†·å»æ™‚é–“
            const currentTime = Date.now();
            const timeSinceLastVote = currentTime - lastVoteTime;
            
            if (timeSinceLastVote < VOTE_COOLDOWN_MS) {
                const remainingTime = Math.ceil((VOTE_COOLDOWN_MS - timeSinceLastVote) / 1000 * 10) / 10;
                showMessage(`è«‹ç¨å€™ ${remainingTime} ç§’å¾Œå†æŠ•ç¥¨`, 'warning');
                return;
            }
            
            // é˜²æ­¢å¿«é€Ÿé»æ“Š - å¢å¼·ç‰ˆé˜²è­·
            if (voteBtn.disabled || voteBtn.dataset.processing === 'true') {
                return;
            }
            
            // æ¨™è¨˜æŒ‰éˆ•æ­£åœ¨è™•ç†ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            voteBtn.disabled = true;
            voteBtn.dataset.processing = 'true';
            
            // æ›´æ–°æœ€å¾ŒæŠ•ç¥¨æ™‚é–“
            lastVoteTime = currentTime;
            
            try {
                // é›™é‡æª¢æŸ¥ï¼šæª¢æŸ¥æœ¬åœ°ç‹€æ…‹å’ŒæŒ‰éˆ•ç‹€æ…‹
                const hasVotedLocally = studentVotedWorks.has(reviewedStudentName);
                const hasVotedClass = voteBtn.classList.contains('voted');
                
                if (hasVotedLocally || hasVotedClass) {
                    // Remove vote (unvote)
                    try {
                        // ä½¿ç”¨å®¢æˆ¶ç«¯éæ¿¾æŸ¥æ‰¾è¦åˆªé™¤çš„æŠ•ç¥¨ï¼ˆä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½åç¨±ï¼‰
                        const allVotes = await pb.collection('peer_reviews').getList(1, 200);
                        const targetVote = allVotes.items.find(vote => 
                            vote.classroom_code === classroomCode && 
                            vote.reviewer_name === studentName && 
                            vote.reviewed_name === reviewedStudentName
                        );
                        
                        if (targetVote) {
                            await pb.collection('peer_reviews').delete(targetVote.id);
                            // Remove from local tracking (ä½¿ç”¨å­¸ç”Ÿåå­—è€Œä¸æ˜¯workId)
                            studentVotedWorks.delete(reviewedStudentName);
                            voteBtn.classList.remove('voted');
                            
                            // æœ¬åœ°æ›´æ–°æŠ•ç¥¨è¨ˆæ•¸ï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š
                            const currentCount = parseInt(voteCountSpan.textContent) || 0;
                            const newCount = Math.max(0, currentCount - 1);
                            voteCountSpan.textContent = newCount;
                            voteCountSpan.classList.toggle('zero', newCount === 0);
                            
                            // æ›´æ–°æœ¬åœ°å…¨å±€æŠ•ç¥¨è¨ˆæ•¸
                            if (allPeerReviewVotes[reviewedStudentName]) {
                                allPeerReviewVotes[reviewedStudentName] = Math.max(0, allPeerReviewVotes[reviewedStudentName] - 1);
                            }
                            
                            updateVoteCountDisplay();
                            
                            showMessage('å·²å–æ¶ˆæŠ•ç¥¨ï¼', 'info');
                            
                            // æ¨™è¨˜æœ€è¿‘çš„æŠ•ç¥¨æ“ä½œï¼Œé˜²æ­¢è¢«é ç«¯æ›´æ–°è¦†è“‹
                            recentVoteOperation = true;
                            setTimeout(() => {
                                recentVoteOperation = false;
                            }, 2000); // 2ç§’å…§ä¸æ¥å—é ç«¯è¦†è“‹
                            
                            // æ›´æ–°æ•™å®¤æ´»å‹•æ™‚é–“
                            if (classroomRecordId) {
                                await ClassroomAPI.updateActivity(classroomRecordId);
                            }
                        } else {
                            // æœ¬åœ°ç‹€æ…‹å¯èƒ½ä¸åŒæ­¥ï¼Œç›´æ¥æ›´æ–°æœ¬åœ°ç‹€æ…‹ (ä½¿ç”¨å­¸ç”Ÿåå­—è€Œä¸æ˜¯workId)
                            studentVotedWorks.delete(reviewedStudentName);
                            voteBtn.classList.remove('voted');
                            
                            // ä¿å®ˆåœ°æ›´æ–°æŠ•ç¥¨è¨ˆæ•¸ï¼ˆå‡è¨­æœ‰ä¸€ç¥¨ï¼‰
                            const currentCount = parseInt(voteCountSpan.textContent) || 0;
                            const newCount = Math.max(0, currentCount - 1);
                            voteCountSpan.textContent = newCount;
                            voteCountSpan.classList.toggle('zero', newCount === 0);
                            
                            // æ›´æ–°æœ¬åœ°å…¨å±€æŠ•ç¥¨è¨ˆæ•¸
                            if (allPeerReviewVotes[reviewedStudentName]) {
                                allPeerReviewVotes[reviewedStudentName] = Math.max(0, allPeerReviewVotes[reviewedStudentName] - 1);
                            }
                            
                            updateVoteCountDisplay();
                            
                            // æ¨™è¨˜æœ€è¿‘çš„æŠ•ç¥¨æ“ä½œï¼Œé˜²æ­¢è¢«é ç«¯æ›´æ–°è¦†è“‹
                            recentVoteOperation = true;
                            setTimeout(() => {
                                recentVoteOperation = false;
                            }, 2000); // 2ç§’å…§ä¸æ¥å—é ç«¯è¦†è“‹
                        }
                    } catch (deleteError) {
                        console.error('[DEBUG] å–æ¶ˆæŠ•ç¥¨å¤±æ•—:', deleteError);
                        showMessage('å–æ¶ˆæŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                    }
                    
                } else {
                    // Add vote
                    if (studentVotedWorks.size >= MAX_VOTES_PER_STUDENT) {
                        showMessage(`æœ€å¤šåªèƒ½æŠ•ç¥¨ ${MAX_VOTES_PER_STUDENT} å€‹ä½œå“ï¼è«‹å…ˆå–æ¶ˆå…¶ä»–æŠ•ç¥¨ã€‚`, 'warning');
                        return;
                    }
                    
                    try {
                        // å¾ workId ä¸­æå–å­¸ç”Ÿåå­— (æ ¼å¼: "name-timestamp")
                        const reviewedStudentName = workId.split('-')[0];
                        
                        // å†æ¬¡æª¢æŸ¥æ˜¯å¦å·²ç¶“æŠ•éç¥¨ï¼ˆé˜²æ­¢ç¶²è·¯å»¶é²å°è‡´çš„é‡è¤‡æŠ•ç¥¨ï¼‰
                        const existingVotes = await pb.collection('peer_reviews').getList(1, 10, {
                            filter: `classroom_code = "${classroomCode}" && reviewer_name = "${studentName}" && reviewed_name = "${reviewedStudentName}"`
                        });
                        
                        if (existingVotes.items.length > 0) {
                            showMessage('æ‚¨å·²ç¶“ç‚ºé€™å€‹ä½œå“æŠ•éç¥¨äº†ï¼', 'warning');
                            
                            // åŒæ­¥æœ¬åœ°ç‹€æ…‹
                            studentVotedWorks.add(reviewedStudentName);
                            voteBtn.classList.add('voted');
                            return;
                        }
                        
                        // é©é…ç¾æœ‰ peer_reviews é›†åˆçµæ§‹
                        const voteData = {
                            classroom_code: classroomCode,  // ä½¿ç”¨æ•™å®¤ä»£ç¢¼è€Œéè¨˜éŒ„ ID
                            reviewer_name: studentName,     // æŠ•ç¥¨äººå§“å
                            reviewed_name: reviewedStudentName,  // è¢«æŠ•ç¥¨å­¸ç”Ÿçš„å§“å
                            score: 1                        // æŠ•ç¥¨åˆ†æ•¸è¨­ç‚º1
                        };
                        
                        const result = await pb.collection('peer_reviews').create(voteData);
                        
                        // Mark as voted locally (ä½¿ç”¨å­¸ç”Ÿåå­—è€Œä¸æ˜¯workId)
                        studentVotedWorks.add(reviewedStudentName);
                        voteBtn.classList.add('voted');
                        
                        // æœ¬åœ°æ›´æ–°æŠ•ç¥¨è¨ˆæ•¸ï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š
                        const currentCount = parseInt(voteCountSpan.textContent) || 0;
                        const newCount = currentCount + 1;
                        voteCountSpan.textContent = newCount;
                        voteCountSpan.classList.toggle('zero', newCount === 0);
                        
                        // æ›´æ–°æœ¬åœ°å…¨å±€æŠ•ç¥¨è¨ˆæ•¸
                        if (!allPeerReviewVotes[reviewedStudentName]) {
                            allPeerReviewVotes[reviewedStudentName] = 0;
                        }
                        allPeerReviewVotes[reviewedStudentName]++;
                        
                        updateVoteCountDisplay();
                        
                        showMessage('æŠ•ç¥¨æˆåŠŸï¼', 'success');
                        
                        // æ¨™è¨˜æœ€è¿‘çš„æŠ•ç¥¨æ“ä½œï¼Œé˜²æ­¢è¢«é ç«¯æ›´æ–°è¦†è“‹
                        recentVoteOperation = true;
                        setTimeout(() => {
                            recentVoteOperation = false;
                        }, 2000); // 2ç§’å…§ä¸æ¥å—é ç«¯è¦†è“‹
                        
                        // æ›´æ–°æ•™å®¤æ´»å‹•æ™‚é–“
                        if (classroomRecordId) {
                            await ClassroomAPI.updateActivity(classroomRecordId);
                        }
                        
                    } catch (createError) {
                        // æª¢æŸ¥æ˜¯å¦æ˜¯collectionä¸å­˜åœ¨çš„å•é¡Œ
                        if (createError.status === 400 || createError.status === 404) {
                            showMessage('äº’è©•åŠŸèƒ½æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                        } else {
                            showMessage('æŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                        }
                    }
                }
                
            } catch (error) {
                showMessage('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                
                // å¦‚æœæ“ä½œå¤±æ•—ï¼Œé‡ç½®å†·å»æ™‚é–“è®“ç”¨æˆ¶å¯ä»¥é‡è©¦
                lastVoteTime = 0;
                
            } finally {
                // é‡æ–°å•Ÿç”¨æŒ‰éˆ•ä¸¦æ¸…é™¤è™•ç†æ¨™è¨˜
                voteBtn.disabled = false;
                voteBtn.dataset.processing = 'false';
            }
        }
        
        /**
         * Listens for peer review votes and updates UI.
         */
        function listenToPeerReviewVotes() {
            if (!classroomCode) {
                console.log('[DEBUG] classroomCode ç‚ºç©ºï¼Œç„¡æ³•è¨­ç½®æŠ•ç¥¨ç›£è½å™¨');
                return;
            }
            
            console.log('[DEBUG] Setting up PocketBase peer review votes listener for classroom code:', classroomCode);
            
            // Cleanup previous subscription with proper type checking
            if (peerReviewUnsubscribe && typeof peerReviewUnsubscribe === 'function') {
                try {
                    peerReviewUnsubscribe();
                    console.log('[DEBUG] æ¸…ç†èˆŠçš„æŠ•ç¥¨ç›£è½å™¨æˆåŠŸ');
                } catch (unsubError) {
                    console.error('[DEBUG] æ¸…ç†èˆŠçš„æŠ•ç¥¨ç›£è½å™¨å¤±æ•—:', unsubError);
                }
                peerReviewUnsubscribe = null;
            }
            
            try {
                // Subscribe to peer review changes for this classroom
                peerReviewUnsubscribe = pb.collection('peer_reviews').subscribe('*', async function (e) {
                    console.log('[DEBUG] æ”¶åˆ°æŠ•ç¥¨è®ŠåŒ–äº‹ä»¶:', e.action, e.record);
                    // Only process votes for current classroomï¼Œä½¿ç”¨æ•™å®¤ä»£ç¢¼éæ¿¾
                    if (e.record && e.record.classroom_code === classroomCode) {
                        console.log('[DEBUG] ç›¸é—œæ•™å®¤çš„æŠ•ç¥¨è®ŠåŒ–ï¼Œå»¶é²é‡æ–°è¼‰å…¥æŠ•ç¥¨çµ±è¨ˆ');
                        
                        // æ ¹æ“šè§’è‰²èª¿æ•´å»¶é²ï¼šæ•™å¸«ç«¯æ›´å¿«æ›´æ–°ï¼Œå­¸ç”Ÿç«¯å»¶é²æ›´é•·
                        const delay = currentRole === 'teacher' ? 200 : 1000;
                        
                        setTimeout(async () => {
                            await loadPeerReviewVotes();
                        }, delay);
                    }
                });
                
                console.log('[DEBUG] æŠ•ç¥¨ç›£è½å™¨è¨­ç½®æˆåŠŸ');
                
                // Initial load of vote counts
                loadPeerReviewVotes();
            } catch (subscribeError) {
                console.error('[DEBUG] è¨­ç½®æŠ•ç¥¨ç›£è½å™¨å¤±æ•—:', subscribeError);
                // å³ä½¿ç›£è½å™¨è¨­ç½®å¤±æ•—ï¼Œä¹Ÿè¦è¼‰å…¥åˆå§‹æŠ•ç¥¨æ•¸æ“š
                loadPeerReviewVotes();
            }
        }
        
        /**
         * Loads peer review votes from PocketBase and updates UI.
         */
        async function loadPeerReviewVotes() {
            if (!classroomCode) {
                console.log('[DEBUG] classroomCode ç‚ºç©ºï¼Œç„¡æ³•åŠ è¼‰æŠ•ç¥¨æ•¸æ“š');
                return;
            }
            
            // é˜²æ­¢é‡è¤‡è«‹æ±‚
            if (isLoadingPeerReviewVotes) {
                console.log('[DEBUG] æŠ•ç¥¨æ•¸æ“šè¼‰å…¥ä¸­ï¼Œè·³éé‡è¤‡è«‹æ±‚');
                return;
            }
            
            isLoadingPeerReviewVotes = true;
            
            try {
                console.log('[DEBUG] æº–å‚™æŸ¥è©¢ peer_reviewsï¼ŒclassroomCode:', classroomCode);
                
                // ä½¿ç”¨å®¢æˆ¶ç«¯éæ¿¾ï¼ˆå› ç‚ºæœå‹™å™¨ç«¯éæ¿¾å¤±æ•—ï¼‰
                const allVotes = await pb.collection('peer_reviews').getList(1, 200);
                console.log('[DEBUG] æŸ¥è©¢æ‰€æœ‰æŠ•ç¥¨è¨˜éŒ„ï¼Œç¸½æ•¸:', allVotes.totalItems);
                
                // å®¢æˆ¶ç«¯éæ¿¾ï¼šä½¿ç”¨æ•™å®¤ä»£ç¢¼è€Œéè¨˜éŒ„ ID
                const filteredVotes = allVotes.items.filter(vote => vote.classroom_code === classroomCode);
                console.log('[DEBUG] éæ¿¾å¾Œæ‰¾åˆ°', filteredVotes.length, 'å€‹æŠ•ç¥¨è¨˜éŒ„');
                
                // Count votes per workï¼Œä½¿ç”¨ reviewed_name ä½œç‚ºä½œå“ ID
                const voteCounts = {};
                
                // æª¢æŸ¥æ˜¯å¦æœ‰åˆé¸ç‹€æ…‹ï¼Œå¦‚æœæœ‰å‰‡éœ€è¦éæ¿¾æŠ•ç¥¨
                let preliminarySelectedStudents = null;
                try {
                    if (classroomRecordId) {
                        const classroomData = await pb.collection('classrooms').getOne(classroomRecordId);
                        if (classroomData.preliminary_selection_active && classroomData.preliminary_selected_students) {
                            preliminarySelectedStudents = classroomData.preliminary_selected_students;
                            console.log('[DEBUG] åˆé¸æ¨¡å¼å•Ÿç”¨ï¼Œåªçµ±è¨ˆåˆé¸ä½œå“çš„æŠ•ç¥¨:', preliminarySelectedStudents);
                        }
                    }
                } catch (error) {
                    console.error('[DEBUG] ç²å–æ•™å®¤åˆé¸ç‹€æ…‹å¤±æ•—:', error);
                }
                
                filteredVotes.forEach(vote => {
                    // å¦‚æœæœ‰åˆé¸ç‹€æ…‹ï¼Œåªçµ±è¨ˆæŠ•çµ¦åˆé¸ä½œå“çš„ç¥¨
                    if (preliminarySelectedStudents) {
                        if (!preliminarySelectedStudents.includes(vote.reviewed_name)) {
                            console.log('[DEBUG] è·³ééåˆé¸ä½œå“çš„æŠ•ç¥¨:', vote.reviewed_name);
                            return; // è·³ééåˆé¸ä½œå“çš„æŠ•ç¥¨
                        }
                    }
                    
                    if (!voteCounts[vote.reviewed_name]) {
                        voteCounts[vote.reviewed_name] = 0;
                    }
                    voteCounts[vote.reviewed_name]++;
                });
                
                // é©—è­‰æŠ•ç¥¨æ•¸æ“šåˆç†æ€§
                const totalVotes = Object.values(voteCounts).reduce((sum, count) => sum + count, 0);
                const maxPossibleVotes = activeStudentNames.length * MAX_VOTES_PER_STUDENT;
                
                // åªåœ¨æœ‰æ´»èºå­¸ç”Ÿæ™‚é€²è¡Œè©³ç´°é©—è­‰
                if (activeStudentNames.length > 0) {
                    console.log('[DEBUG] æŠ•ç¥¨çµ±è¨ˆé©—è­‰:', {
                        voteCounts,
                        totalVotes,
                        activeStudents: activeStudentNames.length,
                        maxVotesPerStudent: MAX_VOTES_PER_STUDENT,
                        maxPossibleVotes,
                        isValid: totalVotes <= maxPossibleVotes
                    });
                    
                    // å¦‚æœç™¼ç¾ç•°å¸¸ï¼Œè¨˜éŒ„è©³ç´°ä¿¡æ¯
                    if (totalVotes > maxPossibleVotes) {
                        console.warn('[WARNING] æª¢æ¸¬åˆ°æŠ•ç¥¨æ•¸æ“šç•°å¸¸ï¼');
                        console.warn('[WARNING] ç¸½æŠ•ç¥¨æ•¸:', totalVotes, 'è¶…éæœ€å¤§å¯èƒ½æŠ•ç¥¨æ•¸:', maxPossibleVotes);
                        console.warn('[WARNING] è©³ç´°æŠ•ç¥¨åˆ†ä½ˆ:', voteCounts);
                        console.warn('[WARNING] æ´»èºå­¸ç”Ÿåˆ—è¡¨:', activeStudentNames);
                        
                        // æª¢æŸ¥æ¯å€‹ä½œå“çš„æŠ•ç¥¨æ•¸æ˜¯å¦è¶…éå­¸ç”Ÿç¸½æ•¸
                        Object.entries(voteCounts).forEach(([studentName, voteCount]) => {
                            if (voteCount > activeStudentNames.length) {
                                console.error('[ERROR] å­¸ç”Ÿ', studentName, 'çš„ä½œå“å¾—ç¥¨æ•¸', voteCount, 'è¶…éå­¸ç”Ÿç¸½æ•¸', activeStudentNames.length);
                            }
                        });
                    }
                } else {
                    // ç•¶æ²’æœ‰æ´»èºå­¸ç”Ÿæ™‚ï¼Œåªè¨˜éŒ„åŸºæœ¬ä¿¡æ¯
                    console.log('[DEBUG] æŠ•ç¥¨çµ±è¨ˆ (ç„¡æ´»èºå­¸ç”Ÿé©—è­‰):', {
                        voteCounts,
                        totalVotes,
                        note: 'æ´»èºå­¸ç”Ÿåˆ—è¡¨ç‚ºç©ºï¼Œè·³éæ•¸æ“šé©—è­‰'
                    });
                }

                allPeerReviewVotes = voteCounts;
                
                // Update student UI
                if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                    // å¦‚æœå­¸ç”Ÿå‰›å®ŒæˆæŠ•ç¥¨æ“ä½œï¼Œå‰‡è·³éæ›´æ–°ä»¥é¿å…è¦†è“‹æœ¬åœ°ç‹€æ…‹
                    if (!recentVoteOperation) {
                        updateStudentVoteUI(voteCounts);
                        updateVoteCountDisplay();
                    } else {
                        console.log('[DEBUG] è·³éå­¸ç”ŸUIæ›´æ–°ï¼Œå› ç‚ºå‰›å®ŒæˆæŠ•ç¥¨æ“ä½œ');
                    }
                }
                
                // Update teacher UI - æ•™å¸«ç«¯ç¸½æ˜¯éœ€è¦æœ€æ–°çš„çµ±è¨ˆ
                if (currentRole === 'teacher' && !document.getElementById('peer-review-stats-container').classList.contains('hidden')) {
                    await updateTeacherVoteStats(voteCounts);
                }
                
            } catch (error) {
                // å¿½ç•¥è‡ªå‹•å–æ¶ˆçš„è«‹æ±‚éŒ¯èª¤
                if (error.message && error.message.includes('autocancelled')) {
                    console.log('[DEBUG] è«‹æ±‚è¢«è‡ªå‹•å–æ¶ˆï¼Œé€™æ˜¯æ­£å¸¸çš„');
                    return;
                }
                
                console.error('Error loading peer review votes:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', error.response);
                
                // ä½¿ç”¨ç©ºçµæœ
                allPeerReviewVotes = {};
                if (currentRole === 'teacher' && !document.getElementById('peer-review-stats-container').classList.contains('hidden')) {
                    await updateTeacherVoteStats({});
                }
            } finally {
                // ç¸½æ˜¯é‡‹æ”¾é–å®š
                isLoadingPeerReviewVotes = false;
            }
        }
        
        /**
         * Updates the vote counts in student UI.
         */
        function updateStudentVoteUI(votes) {
            document.querySelectorAll('.vote-count').forEach(span => {
                const workId = span.previousElementSibling.dataset.workId;
                // å¾ workId æå–å­¸ç”Ÿåå­— (æ ¼å¼: "name-timestamp")
                const reviewedStudentName = workId.split('-')[0];
                const count = votes[reviewedStudentName] || 0;
                span.textContent = count;
                span.classList.toggle('zero', count === 0);
            });
        }
        
        /**
         * Updates the student's current vote count display.
         */
        function updateVoteCountDisplay() {
            const voteCountElement = document.getElementById('current-vote-count');
            if (voteCountElement) {
                voteCountElement.textContent = studentVotedWorks.size;
                
                // Change color based on vote count
                const container = voteCountElement.parentElement;
                container.className = 'inline-block px-4 py-2 rounded-full text-sm font-medium';
                
                if (studentVotedWorks.size === 0) {
                    container.classList.add('bg-gray-100', 'text-gray-600');
                } else if (studentVotedWorks.size < MAX_VOTES_PER_STUDENT) {
                    container.classList.add('bg-blue-100', 'text-blue-800');
                } else {
                    container.classList.add('bg-green-100', 'text-green-800');
                }
            }
        }

        /**
         * Restores student's voting history from PocketBase.
         */
        async function restoreStudentVotingHistory() {
            if (!classroomCode || !studentName) {
                console.log('[DEBUG] classroomCode æˆ– studentName ç‚ºç©ºï¼Œç„¡æ³•æ¢å¾©æŠ•ç¥¨æ­·å²');
                return;
            }
            
            // é˜²æ­¢é‡è¤‡è«‹æ±‚
            if (isRestoringVotingHistory) {
                console.log('[DEBUG] æŠ•ç¥¨æ­·å²æ¢å¾©ä¸­ï¼Œè·³éé‡è¤‡è«‹æ±‚');
                return;
            }
            
            isRestoringVotingHistory = true;
            
            try {
                console.log('[DEBUG] æ¢å¾©æŠ•ç¥¨æ­·å²ï¼ŒclassroomCode:', classroomCode, 'studentName:', studentName);
                
                // ä½¿ç”¨å®¢æˆ¶ç«¯éæ¿¾ï¼ˆé¿å…æœå‹™å™¨ç«¯éæ¿¾å™¨èªæ³•å•é¡Œï¼‰
                const allVotes = await pb.collection('peer_reviews').getList(1, 200);
                console.log('[DEBUG] æŸ¥è©¢æ‰€æœ‰æŠ•ç¥¨è¨˜éŒ„ï¼Œç¸½æ•¸:', allVotes.totalItems);
                
                // Clear existing voting history
                studentVotedWorks.clear();
                
                // Find votes made by this student in this classroomï¼Œä½¿ç”¨é©é…çš„æ¬„ä½åç¨±
                allVotes.items.forEach(vote => {
                    if (vote.classroom_code === classroomCode && vote.reviewer_name === studentName) {
                        studentVotedWorks.add(vote.reviewed_name);
                    }
                });
                
                console.log('[DEBUG] æ¢å¾©æŠ•ç¥¨æ­·å²å®Œæˆï¼ŒæŠ•ç¥¨æ•¸:', studentVotedWorks.size);
                console.log('Restored student voting history:', Array.from(studentVotedWorks));
                
                // Update vote count display after restoration
                updateVoteCountDisplay();
            } catch (error) {
                // å¿½ç•¥è‡ªå‹•å–æ¶ˆçš„è«‹æ±‚éŒ¯èª¤
                if (error.message && error.message.includes('autocancelled')) {
                    console.log('[DEBUG] æŠ•ç¥¨æ­·å²æ¢å¾©è«‹æ±‚è¢«è‡ªå‹•å–æ¶ˆï¼Œé€™æ˜¯æ­£å¸¸çš„');
                    return;
                }
                
                console.error('Error restoring student voting history:', error);
                
                // å¦‚æœå‡ºéŒ¯ï¼Œè‡³å°‘æ¸…ç©ºæœ¬åœ°æŠ•ç¥¨æ­·å²
                studentVotedWorks.clear();
                updateVoteCountDisplay();
            } finally {
                // ç¸½æ˜¯é‡‹æ”¾é–å®š
                isRestoringVotingHistory = false;
            }
        }

        /**
         * Updates the teacher's vote statistics display.
         */
        async function updateTeacherVoteStats(votes) {
            const statsGrid = document.getElementById('peer-review-stats-grid');
            statsGrid.innerHTML = '';
            
            let worksToShow = [];
            
            // Get works from the current peer review session (same as students see)
            try {
                if (classroomRecordId) {
                    const classroomData = await pb.collection('classrooms').getOne(classroomRecordId);
                    console.log('[DEBUG] æ•™å®¤ç‹€æ…‹:', {
                        peer_review_active: classroomData.peer_review_active,
                        preliminary_selection_active: classroomData.preliminary_selection_active,
                        preliminary_selected_students: classroomData.preliminary_selected_students
                    });
                    
                    if (classroomData.peer_review_active && classroomData.peer_review_works) {
                        // Use the same works that students see in peer review
                        worksToShow = classroomData.peer_review_works;
                        console.log('[DEBUG] æ•™å¸«ç«¯çµ±è¨ˆï¼šä½¿ç”¨äº’è©•ä½œå“åˆ—è¡¨', worksToShow.length, 'å€‹ä½œå“');
                    } else {
                        console.log('[DEBUG] äº’è©•æœªå•Ÿç”¨ï¼Œç„¡ä½œå“é¡¯ç¤º');
                        return; // No works to show if peer review is not active
                    }
                }
            } catch (error) {
                console.error('[DEBUG] ç²å–æ•™å®¤è³‡æ–™å¤±æ•—:', error);
                return; // Don't show any works if we can't get classroom data
            }
            
            // Sort works by vote count (descending)
            const sortedWorks = worksToShow.map(work => {
                const workId = `${work.name}-${work.timestamp || allStudentResponses.indexOf(work)}`;
                return {
                    ...work,
                    workId: workId,
                    votes: votes[work.name] || 0  // ä½¿ç”¨å­¸ç”Ÿåå­—è€Œä¸æ˜¯workIdæŸ¥æ‰¾æŠ•ç¥¨æ•¸
                };
            }).sort((a, b) => b.votes - a.votes);
            
            sortedWorks.forEach((work, index) => {
                const statsDiv = document.createElement('div');
                statsDiv.className = 'vote-stats-item';
                
                let contentHtml = '';
                if (currentInteractionMode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="å­¸ç”Ÿä½œå“">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                statsDiv.innerHTML = `
                    <div class="stats-author">${work.name}</div>
                    <div class="stats-content">${contentHtml}</div>
                    <div class="stats-votes">
                        <i class="fas fa-heart vote-icon"></i>
                        <span class="vote-count ${work.votes === 0 ? 'zero' : ''}">${work.votes}</span>
                    </div>
                `;
                
                statsGrid.appendChild(statsDiv);
            });
        }

        // --- Initialization Function ---
        async function initialize() {
            loadAISettings(); 
            loadDispatchSettings(); // Load saved combined dispatch settings
            
            // æª¢æŸ¥URLåƒæ•¸ä¸¦è‡ªå‹•è™•ç†
            const urlParamsHandled = checkURLParameters();
            
            // åˆå§‹åŒ–ç”¨æˆ¶ (æ›¿ä»£ Firebase Auth)
            initializeUser();

            try {
                // ä¸å†è‡ªå‹•æ¢å¾©æ•™å¸«ç‹€æ…‹ï¼Œè®“ä½¿ç”¨è€…é‡æ–°é¸æ“‡
                // Check if teacher has a persisted classroom code
                const savedTeacherClassroomCode = localStorage.getItem('teacherClassroomCode');
                if (savedTeacherClassroomCode) {
                    // æä¾›é¸é …è®“ä½¿ç”¨è€…é¸æ“‡æ˜¯å¦ç¹¼çºŒä½¿ç”¨ä¹‹å‰çš„æ•™å®¤
                    console.log(`[DEBUG] ç™¼ç¾ä¿å­˜çš„æ•™å®¤ä»£ç¢¼: ${savedTeacherClassroomCode}`);
                    // æ¸…é™¤ä¿å­˜çš„æ•™å®¤ä»£ç¢¼ï¼Œè®“ä½¿ç”¨è€…é‡æ–°è¼¸å…¥
                    localStorage.removeItem('teacherClassroomCode');
                }
                
                // å¦‚æœURLåƒæ•¸æœªè¢«è™•ç†ï¼Œæ‰é¡¯ç¤ºå…¥å£é é¢
                if (!urlParamsHandled) {
                    showView('entry');
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                showView('entry'); 
            }

            document.getElementById('app-id-display').textContent = baseAppId; // Display the base app ID
        }
        
        /**
         * å•Ÿå‹•æ•™å®¤å›æ”¶å®šæ™‚å™¨
         */
        function startClassroomCleanupTimer() {
            // æ¯30åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
            const CLEANUP_INTERVAL_MS = 30 * 60 * 1000; // 30åˆ†é˜
            const IDLE_TIME_HOURS = 2; // 2å°æ™‚æœªæ´»å‹•çš„æ•™å®¤è¢«è¦–ç‚ºé–’ç½®
            
            console.log('[ClassroomCleanup] å•Ÿå‹•æ•™å®¤å›æ”¶å®šæ™‚å™¨ï¼Œæ¯30åˆ†é˜æª¢æŸ¥ä¸€æ¬¡');
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡æª¢æŸ¥
            performCleanup();
            
            // è¨­ç½®å®šæœŸæª¢æŸ¥
            setInterval(async () => {
                try {
                    await performCleanup();
                } catch (error) {
                    console.error('[ClassroomCleanup] å®šæœŸæ¸…ç†å¤±æ•—:', error);
                }
            }, CLEANUP_INTERVAL_MS);
            
            async function performCleanup() {
                try {
                    // 1. æ¸…ç†é–’ç½®æ•™å®¤
                    const cleanedCount = await ClassroomAPI.cleanupIdleClassrooms(IDLE_TIME_HOURS);
                    if (cleanedCount > 0) {
                        console.log(`[ClassroomCleanup] æˆåŠŸæ¸…ç†äº† ${cleanedCount} å€‹é–’ç½®æ•™å®¤`);
                    } else {
                        console.log('[ClassroomCleanup] æ²’æœ‰ç™¼ç¾éœ€è¦æ¸…ç†çš„é–’ç½®æ•™å®¤');
                    }
                    
                    // 2. æ¸…ç†å­¤ç«‹æ•¸æ“šï¼ˆæ¯3æ¬¡æ¸…ç†åŸ·è¡Œä¸€æ¬¡ï¼Œæ¸›å°‘é »ç‡ï¼‰
                    if (!performCleanup.orphanedCleanupCounter) {
                        performCleanup.orphanedCleanupCounter = 0;
                    }
                    performCleanup.orphanedCleanupCounter++;
                    
                    if (performCleanup.orphanedCleanupCounter >= 3) {
                        console.log('[ClassroomCleanup] åŸ·è¡Œå­¤ç«‹æ•¸æ“šæ¸…ç†...');
                        await ClassroomAPI.cleanupOrphanedData();
                        performCleanup.orphanedCleanupCounter = 0;
                    }
                    
                } catch (error) {
                    console.error('[ClassroomCleanup] åŸ·è¡Œæ¸…ç†å¤±æ•—:', error);
                }
            }
        }
        
        /**
         * æª¢æŸ¥URLåƒæ•¸ä¸¦è‡ªå‹•è™•ç†å­¸ç”Ÿæ¨¡å¼å’Œæ•™å®¤ä»£ç¢¼
         */
        function checkURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const classroom = urlParams.get('classroom');
            
            if (mode === 'student' && classroom) {
                // è¨­ç½®ç‚ºå­¸ç”Ÿè§’è‰²
                currentRole = 'student';
                
                // ç›´æ¥è·³è½‰åˆ°å­¸ç”Ÿç™»å…¥é é¢ä¸¦è‡ªå‹•å¡«å…¥æ•™å®¤ä»£ç¢¼
                setTimeout(() => {
                    showView('studentName');
                    const studentClassroomInput = document.getElementById('student-classroom-code-input');
                    if (studentClassroomInput) {
                        studentClassroomInput.value = classroom;
                        // è¨­ç½®ç‚ºåªè®€ä¸¦åŠ ä¸Šæ¨£å¼æç¤º
                        studentClassroomInput.readOnly = true;
                        studentClassroomInput.style.backgroundColor = '#e6ffed';
                        studentClassroomInput.style.borderColor = '#22c55e';
                        
                        // è‡ªå‹•èšç„¦åˆ°å­¸ç”Ÿå§“åè¼¸å…¥æ¡†
                        const studentNameInput = document.getElementById('student-name-input');
                        if (studentNameInput) {
                            setTimeout(() => {
                                studentNameInput.focus();
                                studentNameInput.select(); // æ–¹ä¾¿ç”¨æˆ¶ç›´æ¥è¼¸å…¥
                            }, 150);
                        }
                    }
                    
                    // æ›´æ–°é é¢æ¨™é¡Œä»¥æç¤ºç”¨æˆ¶
                    const titleElement = document.querySelector('#student-name-view h2');
                    if (titleElement) {
                        titleElement.innerHTML = `å·²æƒç¢¼é€²å…¥æ•™å®¤: <span class="text-green-600">${classroom}</span><br><span class="text-lg text-gray-600">è«‹è¼¸å…¥æ‚¨çš„å§“å</span>`;
                    }
                    
                    // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
                    showMessage(`ğŸ‰ æƒç¢¼æˆåŠŸï¼è«‹è¼¸å…¥æ‚¨çš„å§“åå³å¯é€²å…¥æ•™å®¤ ${classroom}`, 'success');
                }, 100); // çŸ­æš«å»¶é²ç¢ºä¿DOMå·²è¼‰å…¥
                
                return true; // è¡¨ç¤ºå·²è™•ç†URLåƒæ•¸
            }
            return false; // è¡¨ç¤ºæœªè™•ç†URLåƒæ•¸
        }

        // Add beforeunload handler to warn user about closing window
        let hasEndedClass = false;
        
        // Track when user clicks the end class button
        function markClassEnded() {
            hasEndedClass = true;
        }
        
        // Set up window close warning
        window.onbeforeunload = function() {
            if (!hasEndedClass) {
                return 'è«‹å…ˆæŒ‰ä¸‹ç´…è‰²ä¸‹èª²éµï¼Œå†é—œé–‰è¦–çª—ï¼Œæœ¬æç¤ºè«‹å…ˆæŒ‰å–æ¶ˆ';
            }
        };

        // --- Quick Answer Functions ---
        let quickAnswerActive = false;
        let quickAnswerWinner = null;
        let quickAnswerWinnerDisplayed = false;
        let quickAnswerSubscription = null;

        function startQuickAnswer() {
            console.log('[Quick Answer] Starting quick answer...');
            console.log('[Quick Answer] Current role:', currentRole);
            
            quickAnswerActive = true;
            quickAnswerWinner = null;
            quickAnswerWinnerDisplayed = false;

            // Update status text for students
            const statusText = document.getElementById('quick-answer-status-text');
            if (statusText) {
                statusText.textContent = 'æ¶ç­”é–‹å§‹ï¼å¿«é»æ“ŠæŒ‰éˆ•ï¼';
                console.log('[Quick Answer] Updated student status text');
            }

            // Reset student locked/result states
            const quickAnswerLocked = document.getElementById('quick-answer-locked');
            const quickAnswerResult = document.getElementById('quick-answer-result');
            if (quickAnswerLocked) quickAnswerLocked.classList.add('hidden');
            if (quickAnswerResult) quickAnswerResult.classList.add('hidden');

            // Update teacher UI (if this is called from student side, we need to update teacher display)
            const quickAnswerControls = document.getElementById('quick-answer-controls');
            const quickAnswerStatus = document.getElementById('quick-answer-status');
            const winnerDisplay = document.getElementById('quick-answer-winner-display');
            const restartBtn = document.getElementById('restart-quick-answer-btn');
            
            if (quickAnswerControls) {
                quickAnswerControls.classList.remove('hidden');
                console.log('[Quick Answer] Showed controls panel');
            }
            if (quickAnswerStatus) {
                quickAnswerStatus.textContent = 'æ¶ç­”é€²è¡Œä¸­...';
                console.log('[Quick Answer] Updated status text');
            }
            if (winnerDisplay) winnerDisplay.classList.add('hidden');
            if (restartBtn) restartBtn.classList.add('hidden');

            // Generate random position for the button (student side)
            const container = document.getElementById('quick-answer-button-container');
            if (container) {
                // Clear any existing content and reset classes
                container.innerHTML = '';
                container.classList.remove('pointer-events-none');

                // Create the quick answer button
                const button = document.createElement('button');
                button.className = 'quick-answer-btn';
                button.textContent = 'å¿«é»æˆ‘';

                // Calculate random position (ensure button is fully visible)
                const containerRect = container.getBoundingClientRect();
                const buttonSize = 200; // 200px width and height
                const maxLeft = containerRect.width - buttonSize;
                const maxTop = containerRect.height - buttonSize;

                const randomLeft = Math.random() * Math.max(0, maxLeft);
                const randomTop = Math.random() * Math.max(0, maxTop);

                button.style.left = randomLeft + 'px';
                button.style.top = randomTop + 'px';

                // Add click handler
                button.addEventListener('click', handleQuickAnswerClick);

                container.appendChild(button);
                console.log('[Quick Answer] Created new quick answer button');
            }
        }

        async function handleQuickAnswerClick() {
            if (!quickAnswerActive || quickAnswerWinner) return;

            try {
                // Submit the quick answer to Firebase
                const response = `æ¶ç­”æˆåŠŸï¼š${studentName}`;
                console.log('Submitting quick answer:', response);
                await submitAnswer(response);
                console.log('Quick answer submitted successfully');

                // Show success message
                document.getElementById('quick-answer-result').classList.remove('hidden');
                document.getElementById('quick-answer-status-text').textContent = 'ä½ æ¶ç­”æˆåŠŸäº†ï¼';

                // Lock the button
                lockQuickAnswerButton();

            } catch (error) {
                console.error('Failed to submit quick answer:', error);
                showMessage('æ¶ç­”æäº¤å¤±æ•—ï¼', 'error');
            }
        }

        function lockQuickAnswerButton() {
            const container = document.getElementById('quick-answer-button-container');
            const button = document.querySelector('.quick-answer-btn');
            
            if (button) {
                button.classList.add('locked');
                button.disabled = true;
                button.removeEventListener('click', handleQuickAnswerClick);
            }
            
            // ç¦ç”¨æ•´å€‹æŒ‰éˆ•å®¹å™¨çš„äº¤äº’
            container.classList.add('pointer-events-none');

            // Show locked message for other students
            document.getElementById('quick-answer-locked').classList.remove('hidden');
            document.getElementById('quick-answer-result').classList.add('hidden');
            
            console.log('[Student] æ¶ç­”æŒ‰éˆ•å·²é–å®š');
        }

        // Listen for quick answer winner updates
        function listenToQuickAnswerUpdates() {
            if (currentRole !== 'student' || currentInteractionMode !== 'quick_answer') return;

            // å–æ¶ˆä¹‹å‰çš„è¨‚é–± - åŠ å…¥é¡å‹æª¢æŸ¥
            if (quickAnswerSubscription && typeof quickAnswerSubscription === 'function') {
                quickAnswerSubscription();
                quickAnswerSubscription = null;
            }

            console.log('[Student] é–‹å§‹ç›£è½æ¶ç­”æ›´æ–°...');
            
            // ä½¿ç”¨ PocketBase API ç›£è½å­¸ç”Ÿå›æ‡‰
            quickAnswerSubscription = StudentResponseAPI.subscribe(classroomCode, (e) => {
                console.log('[Student] æ”¶åˆ°å­¸ç”Ÿå›æ‡‰æ›´æ–°:', e);
                
                if (e.action === 'create' || e.action === 'update') {
                    const data = e.record;
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ¶ç­”å›æ‡‰
                    if (data.answer && data.answer.includes('æ¶ç­”æˆåŠŸ')) {
                        console.log('[Student] ç™¼ç¾æ¶ç­”æˆåŠŸ:', data);
                        
                        // å¦‚æœä¸æ˜¯è‡ªå·±æ¶ç­”æˆåŠŸï¼Œä¸”é‚„æ²’æœ‰æ¶ç­”è´å®¶ï¼Œå‰‡é–å®šæŒ‰éˆ•
                        if (data.student_name !== studentName && !quickAnswerWinner) {
                            console.log('[Student] å…¶ä»–å­¸ç”Ÿæ¶ç­”æˆåŠŸï¼Œé–å®šæŒ‰éˆ•');
                            quickAnswerWinner = data.student_name;
                            lockQuickAnswerButton();
                            document.getElementById('quick-answer-status-text').textContent = `${data.student_name} æ¶ç­”æˆåŠŸï¼`;
                        }
                    }
                } else if (e.action === 'delete') {
                    console.log('[Student] æª¢æ¸¬åˆ°å­¸ç”Ÿå›æ‡‰è¢«åˆªé™¤');
                    console.log('[Student] ç•¶å‰å­¸ç”Ÿåç¨±:', studentName);
                    console.log('[Student] ç•¶å‰äº’å‹•æ¨¡å¼:', currentInteractionMode);
                    
                    // å¦‚æœç•¶å‰æ˜¯æ¶ç­”æ¨¡å¼ï¼Œæª¢æ¸¬åˆ°å›æ‡‰è¢«æ¸…ç©ºå°±é‡æ–°é–‹å§‹æ¶ç­”
                    // ä¸è«–å­¸ç”Ÿæ˜¯å¦ç‚ºç²å‹è€…ï¼Œéƒ½æ‡‰è©²é‡æ–°é–‹å§‹
                    if (currentInteractionMode === 'quick_answer') {
                        console.log('[Student] æª¢æ¸¬åˆ°æ¶ç­”é‡å•Ÿä¿¡è™Ÿï¼ˆå›æ‡‰æ¸…é™¤ï¼‰');
                        console.log('[Student] ç•¶å‰å­¸ç”Ÿç‹€æ…‹ - quickAnswerWinner:', quickAnswerWinner, 'quickAnswerActive:', quickAnswerActive);
                        
                        // å»¶é²ä¸€ä¸‹ç¢ºä¿æ‰€æœ‰å›æ‡‰éƒ½è¢«æ¸…é™¤
                        setTimeout(() => {
                            console.log('[Student] é‡æ–°å•Ÿå‹•æ¶ç­”... å­¸ç”Ÿ:', studentName);
                            
                            // é‡ç½®å¿«ç­”ç‹€æ…‹
                            quickAnswerActive = false;
                            quickAnswerWinner = null;
                            quickAnswerWinnerDisplayed = false;
                            
                            // é‡ç½® UI å…ƒç´ 
                            const quickAnswerLocked = document.getElementById('quick-answer-locked');
                            const quickAnswerResult = document.getElementById('quick-answer-result');
                            const statusText = document.getElementById('quick-answer-status-text');
                            const container = document.getElementById('quick-answer-button-container');
                            
                            if (quickAnswerLocked) {
                                quickAnswerLocked.classList.add('hidden');
                                console.log('[Student] éš±è—é–å®šè¨Šæ¯');
                            }
                            if (quickAnswerResult) {
                                quickAnswerResult.classList.add('hidden');
                                console.log('[Student] éš±è—çµæœè¨Šæ¯');
                            }
                            if (statusText) {
                                statusText.textContent = 'ç­‰å¾…æ•™å¸«é–‹å§‹æ¶ç­”...';
                                console.log('[Student] é‡ç½®ç‹€æ…‹æ–‡å­—');
                            }
                            if (container) {
                                container.innerHTML = '';
                                container.classList.remove('pointer-events-none');
                                console.log('[Student] é‡ç½®æŒ‰éˆ•å®¹å™¨');
                            }
                            
                            // é‡æ–°é–‹å§‹æ¶ç­”
                            console.log('[Student] å‘¼å« startQuickAnswer...');
                            startQuickAnswer();
                            
                        }, 600); // çµ¦äºˆè¶³å¤ æ™‚é–“è®“æ‰€æœ‰åˆªé™¤æ“ä½œå®Œæˆ
                    } else {
                        console.log('[Student] ä¸åœ¨æ¶ç­”æ¨¡å¼ï¼Œå¿½ç•¥åˆªé™¤äº‹ä»¶');
                    }
                }
            });
        }

        function showQuickAnswerWinner(winnerName) {
            console.log('showQuickAnswerWinner called with:', winnerName);
            console.log('[Quick Answer Winner] Current role:', currentRole);
            
            if (quickAnswerWinnerDisplayed) {
                console.log('Winner already displayed, skipping');
                return; // Prevent showing multiple times
            }
            quickAnswerWinnerDisplayed = true;
            console.log('Displaying winner overlay');

            // Update teacher UI controls
            if (currentRole === 'teacher') {
                console.log('[Quick Answer Winner] Updating teacher UI controls...');
                const quickAnswerStatus = document.getElementById('quick-answer-status');
                const winnerDisplay = document.getElementById('quick-answer-winner-display');
                const winnerNameElement = document.getElementById('quick-answer-winner-name');
                const winnerTimeElement = document.getElementById('quick-answer-winner-time');
                const restartBtn = document.getElementById('restart-quick-answer-btn');
                
                console.log('[Quick Answer Winner] Elements found:', {
                    quickAnswerStatus: !!quickAnswerStatus,
                    winnerDisplay: !!winnerDisplay,
                    winnerNameElement: !!winnerNameElement,
                    winnerTimeElement: !!winnerTimeElement,
                    restartBtn: !!restartBtn
                });
                
                if (quickAnswerStatus) {
                    quickAnswerStatus.textContent = 'æ¶ç­”å·²çµæŸ';
                    console.log('[Quick Answer Winner] Updated status');
                }
                if (winnerNameElement) {
                    winnerNameElement.textContent = winnerName;
                    console.log('[Quick Answer Winner] Updated winner name');
                }
                if (winnerTimeElement) {
                    winnerTimeElement.textContent = new Date().toLocaleTimeString();
                    console.log('[Quick Answer Winner] Updated winner time');
                }
                if (winnerDisplay) {
                    winnerDisplay.classList.remove('hidden');
                    console.log('[Quick Answer Winner] Showed winner display');
                }
                if (restartBtn) {
                    restartBtn.classList.remove('hidden');
                    console.log('[Quick Answer Winner] Showed restart button');
                }
            } else {
                console.log('[Quick Answer Winner] Current role is not teacher, role:', currentRole);
            }

            // Create a big overlay notification for the teacher
            const overlay = document.createElement('div');
            overlay.id = 'quick-answer-winner-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.5s ease-in-out;
            `;

            overlay.innerHTML = `
                <div style="text-align: center; color: white; font-size: 3rem; font-weight: bold;">
                    <i class="fas fa-trophy" style="color: #ffd700; font-size: 6rem; margin-bottom: 20px;"></i>
                    <h1 style="margin: 20px 0; color: #4ade80;">æ¶ç­”æˆåŠŸï¼</h1>
                    <h2 style="margin: 20px 0; color: #60a5fa; font-size: 4rem;">${winnerName}</h2>
                    <p style="font-size: 1.5rem; color: #d1d5db;">é»æ“Šä»»æ„ä½ç½®é—œé–‰</p>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: scale(0.8); }
                        to { opacity: 1; transform: scale(1); }
                    }
                </style>
            `;

            // Add click handler to close the overlay
            overlay.addEventListener('click', () => {
                overlay.remove();
                quickAnswerWinnerDisplayed = false; // Reset for next round
            });

            document.body.appendChild(overlay);

            // Auto close after 5 seconds
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.remove();
                    quickAnswerWinnerDisplayed = false;
                }
            }, 5000);
        }

        // --- Start Application ---
        initialize();
        setupEventListeners(); // Call setupEventListeners only once here.

    </script>
</body>
</html>