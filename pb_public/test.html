<!DOCTYPE html>
<html>
<head>
    <title>èª²å ‚äº’å‹•ç³»çµ± - æ•™å®¤å»ºç«‹æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>èª²å ‚äº’å‹•ç³»çµ± - æ•™å®¤å»ºç«‹æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>åŸºæœ¬é€£æ¥æ¸¬è©¦</h2>
        <button id="testBtn">æ¸¬è©¦ PocketBase é€£æ¥</button>
        <div id="result"></div>
    </div>
    
    <div class="test-section">
        <h2>æ•™å®¤å»ºç«‹æ¸¬è©¦ (æ¨¡æ“¬ä¸»æ‡‰ç”¨ç¨‹å¼)</h2>
        <button id="testCreateClassroom">å»ºç«‹æ¸¬è©¦æ•™å®¤</button>
        <div id="testResult"></div>
    </div>

    <script type="module">
        import PocketBase from 'https://cdn.skypack.dev/pocketbase';
        
        const pb = new PocketBase('http://127.0.0.1:8090');
        const baseAppId = 'default-classroom-app'; // ä½¿ç”¨èˆ‡ä¸»æ‡‰ç”¨ç¨‹å¼ç›¸åŒçš„ app_id
        
        // è¤‡è£½ä¸»æ‡‰ç”¨ç¨‹å¼çš„ handlePBError å‡½æ•¸
        function handlePBError(error, operation) {
            console.error(`[PocketBase] ${operation} failed:`, error);
            let message = `æ“ä½œå¤±æ•—: ${operation}`;
            if (error.response?.message) {
                message += ` - ${error.response.message}`;
            }
            if (error.response?.data) {
                console.error('è©³ç´°éŒ¯èª¤è³‡è¨Š:', error.response.data);
                message += `\nè©³ç´°éŒ¯èª¤: ${JSON.stringify(error.response.data, null, 2)}`;
            }
            return message;
        }
        
        // è¤‡è£½ä¸»æ‡‰ç”¨ç¨‹å¼çš„ ClassroomAPI
        const ClassroomAPI = {
            async upsert(classroomCode, data) {
                try {
                    console.log('ClassroomAPI.upsert è¢«èª¿ç”¨:', { classroomCode, data });
                    
                    // å…ˆå˜—è©¦æŸ¥æ‰¾ç¾æœ‰æ•™å®¤
                    const existingRecords = await pb.collection('classrooms').getList(1, 1, {
                        filter: `code = "${classroomCode}" && app_id = "${baseAppId}"`
                    });
                    
                    if (existingRecords.items.length > 0) {
                        // æ›´æ–°ç¾æœ‰æ•™å®¤
                        console.log('æ›´æ–°ç¾æœ‰æ•™å®¤:', existingRecords.items[0].id);
                        return await pb.collection('classrooms').update(existingRecords.items[0].id, data);
                    } else {
                        // å»ºç«‹æ–°æ•™å®¤
                        const createData = {
                            code: classroomCode,
                            app_id: baseAppId,
                            ...data
                        };
                        console.log('å»ºç«‹æ–°æ•™å®¤ï¼Œè³‡æ–™:', createData);
                        return await pb.collection('classrooms').create(createData);
                    }
                } catch (error) {
                    const errorMsg = handlePBError(error, 'å»ºç«‹/æ›´æ–°æ•™å®¤');
                    throw new Error(errorMsg);
                }
            }
        };
        
        // åŸºæœ¬é€£æ¥æ¸¬è©¦
        const result = document.getElementById('result');
        
        document.getElementById('testBtn').addEventListener('click', async () => {
            try {
                // æ¸¬è©¦åŸºæœ¬é€£æ¥
                result.innerHTML = '<p>æ¸¬è©¦ä¸­...</p>';
                
                // åˆ—å‡ºæ‰€æœ‰ collections
                const collections = await pb.collections.getFullList();
                result.innerHTML = `
                    <h2>é€£æ¥æˆåŠŸï¼</h2>
                    <h3>Collections:</h3>
                    <ul>
                        ${collections.map(c => `<li>${c.name} (${c.type})</li>`).join('')}
                    </ul>
                `;
                
                // æ¸¬è©¦å»ºç«‹æ•™å®¤
                const testClassroom = await pb.collection('classrooms').create({
                    code: 'TEST123',
                    app_id: 'test-app',
                    teacher_id: 'test-teacher',
                    active_mode: 'waiting',
                    is_paused: false
                });
                
                result.innerHTML += `<p>âœ… æ¸¬è©¦æ•™å®¤å»ºç«‹æˆåŠŸ: ${testClassroom.id}</p>`;
                
                // æ¸…ç†æ¸¬è©¦è³‡æ–™
                await pb.collection('classrooms').delete(testClassroom.id);
                result.innerHTML += `<p>âœ… æ¸¬è©¦è³‡æ–™æ¸…ç†å®Œæˆ</p>`;
                
            } catch (error) {
                result.innerHTML = `<p style="color: red;">éŒ¯èª¤: ${error.message}</p>`;
                console.error('æ¸¬è©¦å¤±æ•—:', error);
            }
        });
        
        // æ•™å®¤å»ºç«‹æ¸¬è©¦ (å®Œå…¨æ¨¡æ“¬ä¸»æ‡‰ç”¨ç¨‹å¼)
        document.getElementById('testCreateClassroom').addEventListener('click', async () => {
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<p class="info">å»ºç«‹æ¸¬è©¦æ•™å®¤ä¸­...</p>';
            
            console.log('ä½¿ç”¨çš„ baseAppId:', baseAppId);
            
            try {
                // å®Œå…¨æ¨¡æ“¬ä¸»æ‡‰ç”¨ç¨‹å¼çš„è³‡æ–™
                const classroomCode = 'TEST_' + Date.now();
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const initialData = { 
                    active_mode: 'waiting', 
                    teacher_id: userId, 
                    is_paused: false
                };
                
                console.log('æº–å‚™å»ºç«‹æ•™å®¤:', { classroomCode, initialData, baseAppId });
                
                // ç›´æ¥ä½¿ç”¨ PocketBase API è€Œä¸æ˜¯ ClassroomAPI
                const createData = {
                    code: classroomCode,
                    app_id: baseAppId,
                    ...initialData
                };
                
                console.log('æœ€çµ‚ç™¼é€è³‡æ–™:', createData);
                
                const classroom = await pb.collection('classrooms').create(createData);
                
                testResult.innerHTML = `
                    <p class="success">âœ… æ•™å®¤å»ºç«‹æˆåŠŸï¼</p>
                    <pre>${JSON.stringify(classroom, null, 2)}</pre>
                `;
                
                // æ¸…ç†æ¸¬è©¦è³‡æ–™
                setTimeout(async () => {
                    try {
                        await pb.collection('classrooms').delete(classroom.id);
                        testResult.innerHTML += `<p class="info">ğŸ§¹ æ¸¬è©¦è³‡æ–™å·²æ¸…ç†</p>`;
                    } catch (e) {
                        console.error('æ¸…ç†å¤±æ•—:', e);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('å»ºç«‹æ•™å®¤å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    name: error.name,
                    message: error.message,
                    status: error.status,
                    response: error.response
                });
                
                testResult.innerHTML = `
                    <p class="error">âŒ å»ºç«‹å¤±æ•—: ${error.message}</p>
                    <p class="error">ç‹€æ…‹ç¢¼: ${error.status}</p>
                    <pre class="error">${JSON.stringify(error.response, null, 2)}</pre>
                `;
            }
        });
    </script>
</body>
</html>